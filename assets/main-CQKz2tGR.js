import{initializeApp as e}from"https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";import{getAuth as t,sendEmailVerification as n,EmailAuthProvider as s,reauthenticateWithCredential as a,onAuthStateChanged as r,updatePassword as i,sendPasswordResetEmail as o,signOut as l,signInWithEmailAndPassword as d,createUserWithEmailAndPassword as c}from"https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";import{getFirestore as u,where as p,writeBatch as m,deleteDoc as h,orderBy as b,query as f,getDocs as g,collection as x,getDoc as v,setDoc as y,doc as w}from"https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const n of e)if("childList"===n.type)for(const e of n.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const E=e({apiKey:"AIzaSyBJgDqHiHD8mncuRNlw8eA1ismr_fcvj2E",authDomain:"mi-gestion-e2ee.firebaseapp.com",projectId:"mi-gestion-e2ee",storageBucket:"mi-gestion-e2ee.firebasestorage.app",messagingSenderId:"97671435614",appId:"1:97671435614:web:e0f35d92692ca1e63b2bcf",measurementId:"G-GLYJSXBC8E"}),I=t(E),C=u(E);window.firebaseModules={app:E,auth:I,db:C,createUserWithEmailAndPassword:c,signInWithEmailAndPassword:d,signOut:l,sendPasswordResetEmail:o,updatePassword:i,onAuthStateChanged:r,reauthenticateWithCredential:a,EmailAuthProvider:s,sendEmailVerification:n,getFirestore:u,doc:w,setDoc:y,getDoc:v,collection:x,getDocs:g,query:f,orderBy:b,deleteDoc:h,writeBatch:m,where:p};const $=new class{constructor(){this.container=null,this.queue=[],this.isShowing=!1}createContainer(){if(document.getElementById("toast-container"))return;const e=document.createElement("div");e.id="toast-container",e.className="fixed bottom-6 right-6 z-[100] flex flex-col items-end gap-3 pointer-events-none sm:bottom-6 sm:right-6 top-4 right-4 sm:top-auto",document.body.appendChild(e),this.container=e}show(e,t="info",n=4e3){this.createContainer();const s={success:{icon:'<i class="fas fa-check-circle text-emerald-500 text-lg"></i>',border:"border-emerald-500/20",bg:"bg-white"},error:{icon:'<i class="fas fa-times-circle text-red-500 text-lg"></i>',border:"border-red-500/20",bg:"bg-white"},info:{icon:'<i class="fas fa-info-circle text-brand-500 text-lg"></i>',border:"border-brand-500/20",bg:"bg-white"},warning:{icon:'<i class="fas fa-exclamation-triangle text-amber-500 text-lg"></i>',border:"border-amber-500/20",bg:"bg-white"}},a=s[t]||s.info,r=document.createElement("div");r.className=`\n      pointer-events-auto \n      flex items-center gap-3 \n      min-w-[300px] max-w-sm \n      p-4 rounded-xl \n      bg-white \n      border ${a.border} \n      shadow-lg shadow-slate-200/50 \n      transform translate-y-10 opacity-0 scale-95\n      transition-all duration-300 ease-out\n    `,r.innerHTML=`\n      <div class="flex-shrink-0">\n        ${a.icon}\n      </div>\n      <div class="flex-1">\n        <p class="text-sm font-medium text-slate-700 leading-snug">${e}</p>\n      </div>\n      <button class="text-slate-400 hover:text-slate-600 transition-colors ml-2">\n        <i class="fas fa-times text-xs"></i>\n      </button>\n    `;document.getElementById("toast-container").appendChild(r),r.querySelector("button").onclick=()=>this.dismiss(r),requestAnimationFrame(()=>{r.classList.remove("translate-y-10","opacity-0","scale-95"),r.classList.add("translate-y-0","opacity-100","scale-100")}),setTimeout(()=>{this.dismiss(r)},n)}dismiss(e){e.classList.add("opacity-0","translate-y-4","scale-95"),e.style.marginBottom=`-${e.offsetHeight}px`,setTimeout(()=>{e.remove()},300)}},S="AES-GCM";function k(e){return Array.prototype.map.call(new Uint8Array(e),e=>("00"+e.toString(16)).slice(-2)).join("")}function L(e){return new Uint8Array(e.match(/.{1,2}/g).map(e=>parseInt(e,16)))}async function T(e){return e instanceof CryptoKey?e:await window.crypto.subtle.importKey("raw",e,{name:S},!1,["encrypt","decrypt"])}async function D(e,t){try{const s=await T(t),a=JSON.stringify(e),r=(n=a,(new TextEncoder).encode(n)),i=window.crypto.getRandomValues(new Uint8Array(12)),o=await window.crypto.subtle.encrypt({name:S,iv:i},s,r);return{iv:k(i),content:k(o)}}catch(s){throw new Error("No se pudo cifrar la informaci√≥n.")}var n}async function B(e,t){try{const n=(new TextEncoder).encode(e),s=await crypto.subtle.importKey("raw",n,"PBKDF2",!1,["deriveKey"]),a=await crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:1e5,hash:"SHA-256"},s,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),r=await crypto.subtle.exportKey("raw",a);return new Uint8Array(r)}catch(n){throw n}}const j=new class{constructor(){this.key=null,this.userId=null,this.isUnlocked=!1,this.lockTimer=null,this.GRACE_PERIOD_MS=72e5}_resetTimer(){this.lockTimer&&clearTimeout(this.lockTimer),this.lockTimer=setTimeout(()=>{this.lock(),window.location.reload()},this.GRACE_PERIOD_MS)}async initialize(e,t,n,s=null){try{if(this.userId=n,s){const n=await async function(e,t,n){try{const s=await B(e,t),a=await crypto.subtle.digest("SHA-256",s);return new Uint8Array(a).slice(0,16).every((e,t)=>e===n[t])}catch(s){return!1}}(e,t,s);if(!n)throw new Error("Contrase√±a incorrecta")}const a=await B(e,t);return this.key=a,this.isUnlocked=!0,this._resetTimer(),!0}catch(a){throw this.lock(),a}}lock(){this.key=null,this.isUnlocked=!1,this.userId=null,this.lockTimer&&clearTimeout(this.lockTimer)}isReady(){return!0===this.isUnlocked&&null!==this.key}async decryptDocument(e){if(!this.isReady())throw new Error("B√≥veda bloqueada");return this._resetTimer(),await async function(e,t){try{if(!e||!e.iv||!e.content)return e;const n=await T(t),s=L(e.iv),a=L(e.content),r=await window.crypto.subtle.decrypt({name:S,iv:s},n,a),i=(new TextDecoder).decode(r);return JSON.parse(i)}catch(n){throw new Error("Contrase√±a incorrecta o datos corruptos.")}}(e,this.key)}async encryptDocument(e){if(!this.isReady())throw new Error("B√≥veda bloqueada");return this._resetTimer(),await D(e,this.key)}async validateKey(e,t){try{return await B(e,t),!0}catch(n){return!1}}};const M=new class{constructor(){this.auth=null,this.db=null,this.user=null,this.observers=[],this.waitForFirebase()}async waitForFirebase(){let e=0;for(;!window.firebaseModules&&e<50;)await new Promise(e=>setTimeout(e,100)),e++;if(window.firebaseModules){this.auth=window.firebaseModules.auth,this.db=window.firebaseModules.db;const{onAuthStateChanged:e}=window.firebaseModules;e(this.auth,e=>this.updateState(e))}}updateState(e){this.user=e,this.notifyObservers(e)}subscribe(e){this.observers.push(e),null!==this.user&&e(this.user)}notifyObservers(e){this.observers.forEach(t=>t(e))}getCurrentUser(){return this.user}bufferToBase64(e){return btoa(String.fromCharCode(...new Uint8Array(e)))}base64ToBuffer(e){return Uint8Array.from(atob(e),e=>e.charCodeAt(0))}async _getSecurityData(e){const{getDoc:t,doc:n}=window.firebaseModules;try{const s=n(this.db,"users",e,"system","security"),a=await t(s);if(a.exists()){const e=a.data();return{salt:this.base64ToBuffer(e.salt),verifier:e.verifier?this.base64ToBuffer(e.verifier):null}}return null}catch(s){return null}}async login(e,t){if(!this.auth)throw new Error("Firebase no inicializado");try{const{signInWithEmailAndPassword:n,signOut:s}=window.firebaseModules,a=await n(this.auth,e,t);if(!a.user.emailVerified){await s(this.auth),this.updateState(null);const e=new Error("El correo no ha sido verificado.");throw e.code="auth/email-not-verified",e}return this.updateState(a.user),{success:!0,user:a.user}}catch(n){throw this.user&&await this.logout(),n}}async register(e,t){if(!this.auth)throw new Error("Firebase no inicializado");try{const{createUserWithEmailAndPassword:n,sendEmailVerification:s,setDoc:a,doc:r,signOut:i}=window.firebaseModules,o=await n(this.auth,e,t);return await a(r(this.db,"users",o.user.uid,"system","metadata"),{vaultConfigured:!1,createdAt:(new Date).toISOString()}),await s(o.user),await i(this.auth),this.updateState(null),{success:!0,requiresVerification:!0}}catch(n){throw n}}async resendVerificationEmail(e,t){const{signInWithEmailAndPassword:n,sendEmailVerification:s,signOut:a}=window.firebaseModules,r=await n(this.auth,e,t);return await s(r.user),await a(this.auth),!0}async logout(){try{j&&"function"==typeof j.clearKey&&j.clearKey();const{signOut:e}=window.firebaseModules;return this.auth&&await e(this.auth),this.updateState(null),{success:!0}}catch(e){throw e}}async resetPassword(e){const{sendPasswordResetEmail:t}=window.firebaseModules;return await t(this.auth,e),{success:!0}}async initializeEncryption(e){const t=this.user||this.auth?.currentUser;if(!t)throw new Error("Usuario no autenticado");const n=await this._getSecurityData(t.uid);if(!n||!n.salt){const n=(new TextEncoder).encode(t.uid);return await j.initialize(e,n,t.uid)}return await j.initialize(e,n.salt,t.uid,n.verifier)}async isVaultConfigured(){const e=this.getCurrentUser();if(!e)return!1;const{getDoc:t,doc:n}=window.firebaseModules;try{const s=await t(n(this.db,"users",e.uid,"system","metadata"));return s.exists()&&!0===s.data().vaultConfigured}catch(s){return!1}}async markVaultAsConfigured(){const e=this.getCurrentUser();if(!e)return;const{setDoc:t,doc:n}=window.firebaseModules;await t(n(this.db,"users",e.uid,"system","metadata"),{vaultConfigured:!0,vaultConfiguredAt:(new Date).toISOString()},{merge:!0})}async checkPasswordConflict(e){const t=this.getCurrentUser();if(!t||!t.email)return!1;try{const{EmailAuthProvider:n,reauthenticateWithCredential:s}=window.firebaseModules,a=n.credential(t.email,e);return await s(t,a),!0}catch(n){return"auth/wrong-password"===n.code||n.code,!1}}},A=Object.freeze(Object.defineProperty({__proto__:null,authService:M},Symbol.toStringTag,{value:"Module"}));class q{constructor(e,t){this.onLoginSuccess=e,this.onError=t,this.isLoginMode=!0}updateView(e){e.className="w-full max-w-md mx-auto",e.innerHTML=this.render(),this.setupEventListeners(e)}render(){return`\n      <div class="bg-white rounded-2xl shadow-card border border-slate-100 overflow-hidden animate-slide-up">\n        <div class="px-8 pt-8 pb-6 text-center border-b border-slate-50">\n          <div class="inline-flex items-center justify-center w-12 h-12 rounded-xl bg-brand-50 text-brand-600 mb-4">\n            <i class="fas fa-shield-alt text-xl"></i>\n          </div>\n          <h2 class="text-2xl font-bold text-slate-900 tracking-tight">\n            ${this.isLoginMode?"Bienvenido de nuevo":"Crear B√≥veda"}\n          </h2>\n          <p class="mt-2 text-sm text-slate-500">\n            ${this.isLoginMode?"Ingresa tus credenciales para desencriptar.":"Configura tu espacio seguro E2EE."}\n          </p>\n        </div>\n\n        <div class="flex p-2 bg-slate-50/50 mx-6 mt-6 rounded-lg border border-slate-100">\n          <button id="tabLogin" class="flex-1 py-2 text-sm font-medium rounded-md transition-all duration-200 ${this.isLoginMode?"bg-white text-slate-800 shadow-sm border border-slate-200/50":"text-slate-500 hover:text-slate-700"}">\n            Ingresar\n          </button>\n          <button id="tabRegister" class="flex-1 py-2 text-sm font-medium rounded-md transition-all duration-200 ${this.isLoginMode?"text-slate-500 hover:text-slate-700":"bg-white text-slate-800 shadow-sm border border-slate-200/50"}">\n            Registrarse\n          </button>\n        </div>\n\n        <div class="p-8">\n          <form id="authForm" class="space-y-5">\n            <div class="space-y-4">\n              <div>\n                <label class="block text-xs font-semibold text-slate-700 uppercase tracking-wider mb-1.5">\n                  Correo Electr√≥nico\n                </label>\n                <div class="relative group">\n                  <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">\n                    <i class="fas fa-envelope text-slate-400 group-focus-within:text-brand-500 transition-colors"></i>\n                  </div>\n                  <input type="email" id="email" required \n                    class="block w-full pl-10 pr-3 py-2.5 bg-white border border-slate-300 rounded-lg text-slate-900 placeholder-slate-400 focus:outline-none focus:border-brand-500 focus:ring-4 focus:ring-brand-500/10 transition-all sm:text-sm"\n                    placeholder="nombre@empresa.com">\n                </div>\n              </div>\n\n              <div>\n                <div class="flex items-center justify-between mb-1.5">\n                  <label class="block text-xs font-semibold text-slate-700 uppercase tracking-wider">\n                    Contrase√±a maestra\n                  </label>\n                  ${this.isLoginMode?'\n                    <a href="#" id="forgotPassword" class="text-xs font-medium text-brand-600 hover:text-brand-700 hover:underline">\n                      ¬øOlvidaste?\n                    </a>\n                  ':""}\n                </div>\n                <div class="relative group">\n                  <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">\n                    <i class="fas fa-lock text-slate-400 group-focus-within:text-brand-500 transition-colors"></i>\n                  </div>\n                  <input type="password" id="password" required \n                    class="block w-full pl-10 pr-3 py-2.5 bg-white border border-slate-300 rounded-lg text-slate-900 placeholder-slate-400 focus:outline-none focus:border-brand-500 focus:ring-4 focus:ring-brand-500/10 transition-all sm:text-sm"\n                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">\n                </div>\n                ${this.isLoginMode?"":'\n                  <p class="mt-2 text-xs text-slate-500">\n                    <i class="fas fa-info-circle mr-1"></i> \n                    Esta contrase√±a encriptar√° tus datos. No la pierdas.\n                  </p>\n                '}\n              </div>\n            </div>\n\n            <button type="submit" \n              class="w-full flex justify-center items-center py-2.5 px-4 border border-transparent rounded-lg shadow-sm text-sm font-semibold text-white bg-brand-600 hover:bg-brand-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-500 transition-all disabled:opacity-70 disabled:cursor-not-allowed mt-6">\n              <span>${this.isLoginMode?"Acceder a B√≥veda":"Crear Cuenta"}</span>\n              <i class="fas fa-arrow-right ml-2 text-xs opacity-70"></i>\n            </button>\n          </form>\n        </div>\n\n        <div class="px-8 py-4 bg-slate-50 border-t border-slate-100 flex items-center justify-center gap-2">\n          <i class="fas fa-shield-halved text-emerald-500 text-xs"></i>\n          <span class="text-xs font-medium text-slate-500">Cifrado de extremo a extremo activo</span>\n        </div>\n      </div>\n    `}setupEventListeners(e){const t=e.querySelector("#authForm"),n=e.querySelector("#tabLogin"),s=e.querySelector("#tabRegister"),a=e.querySelector("#forgotPassword"),r=t=>{this.isLoginMode=t,this.updateView(e)};n&&(n.onclick=()=>r(!0)),s&&(s.onclick=()=>r(!1)),t.addEventListener("submit",async e=>{e.preventDefault();const n=t.email.value,s=t.password.value,a=t.querySelector('button[type="submit"]'),i=a.innerHTML;a.disabled=!0,a.innerHTML='<svg class="animate-spin -ml-1 mr-3 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Procesando...';try{if(this.isLoginMode)await M.login(n,s),this.onLoginSuccess();else{if((await M.register(n,s)).requiresVerification)return a.disabled=!1,a.innerHTML=i,r(!0),alert(`Verifica tu correo enviado a ${n}`),void t.reset();this.onLoginSuccess()}}catch(o){a.disabled=!1,a.innerHTML=i,this.onError?this.onError(o):alert(o.message)}}),a&&(a.onclick=t=>{t.preventDefault();const n=e.querySelector("#email").value;n?M.resetPassword(n).then(()=>alert("Correo de recuperaci√≥n enviado")).catch(e=>this.onError?this.onError(e):alert(e.message)):this.onError?this.onError({message:"Ingresa tu correo para recuperar la contrase√±a"}):alert("Ingresa tu correo primero")})}}class F{constructor(e,t){this.onSubmit=e,this.email=t||"Usuario"}show(){if(document.getElementById("passwordPromptModal"))return;const e=`\n      <div id="passwordPromptModal" class="fixed inset-0 z-[70] flex items-center justify-center p-4">\n        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm transition-opacity opacity-0" id="ppmBackdrop"></div>\n        \n        <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform scale-95 opacity-0 transition-all duration-200" id="ppmCard">\n          \n          <div class="p-6 text-center">\n            <div class="w-14 h-14 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-600 border border-slate-200">\n              <i class="fas fa-lock text-xl"></i>\n            </div>\n            \n            <h3 class="text-lg font-bold text-slate-900">Seguridad Requerida</h3>\n            <p class="text-sm text-slate-500 mt-1 mb-6">\n              Ingresa tu <strong>Llave Maestra</strong> para descifrar los datos de <span class="font-medium text-slate-700">${this.email}</span>.\n            </p>\n\n            <form id="passwordPromptForm">\n              <div class="relative mb-4 group">\n                <input type="password" id="ppmPassword" \n                  class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-xl focus:bg-white focus:border-brand-600 focus:ring-4 focus:ring-brand-600/10 outline-none transition-all font-mono text-sm text-center tracking-widest text-slate-800 placeholder-slate-400"\n                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autofocus>\n              </div>\n\n              <div id="ppmError" class="hidden text-xs text-red-500 font-bold mb-3 bg-red-50 py-2 rounded-lg border border-red-100">\n                <i class="fas fa-times-circle mr-1"></i> Contrase√±a incorrecta\n              </div>\n\n              <button type="submit" id="ppmSubmitBtn"\n                class="w-full py-3 bg-slate-900 hover:bg-black text-white font-bold rounded-xl shadow-lg transition-transform active:scale-95 flex items-center justify-center gap-2">\n                <span>Desbloquear</span>\n                <i class="fas fa-arrow-right text-xs"></i>\n              </button>\n            </form>\n          </div>\n          \n          <div class="bg-slate-50 py-3 text-center border-t border-slate-100">\n             <button id="ppmCancelBtn" class="text-xs font-bold text-slate-400 hover:text-slate-600 uppercase tracking-wide transition-colors">\n               Cancelar\n             </button>\n          </div>\n        </div>\n      </div>\n    `;document.body.insertAdjacentHTML("beforeend",e),requestAnimationFrame(()=>{document.getElementById("ppmBackdrop").classList.remove("opacity-0");const e=document.getElementById("ppmCard");e.classList.remove("scale-95","opacity-0"),e.classList.add("scale-100","opacity-100"),document.getElementById("ppmPassword").focus()}),this.setupListeners()}setupListeners(){const e=document.getElementById("passwordPromptForm"),t=document.getElementById("ppmError"),n=document.getElementById("ppmSubmitBtn"),s=document.getElementById("ppmCancelBtn"),a=()=>{document.getElementById("passwordPromptModal")?.remove()};s?.addEventListener("click",a),e?.addEventListener("submit",async e=>{e.preventDefault();const s=document.getElementById("ppmPassword").value,r=n.innerHTML;n.innerHTML='<i class="fas fa-circle-notch fa-spin"></i> Verificando...',n.disabled=!0,t.classList.add("hidden");try{if(await this.onSubmit(s))a();else{const e=document.getElementById("ppmCard");e.classList.add("animate-pulse"),t.classList.remove("hidden"),document.getElementById("ppmPassword").value="",document.getElementById("ppmPassword").focus(),n.innerHTML=r,n.disabled=!1,setTimeout(()=>e.classList.remove("animate-pulse"),500)}}catch(i){t.textContent="Error del sistema",t.classList.remove("hidden"),n.innerHTML=r,n.disabled=!1}})}}const P=new class{constructor(){if(!window.firebaseModules)throw new Error("Firebase no est√° inicializado. Recarga la p√°gina.");this.modules=window.firebaseModules,this.auth=this.modules.auth,this.db=this.modules.db,this.app=this.modules.app}_cleanObject(e){if("object"!=typeof e||null===e)return e;if(Array.isArray(e))return e.map(e=>this._cleanObject(e));const t={};for(const n in e)if(e.hasOwnProperty(n)){const s=e[n];void 0!==s&&(t[n]=this._cleanObject(s))}return t}getAuth(){return this.auth}getFirestore(){return this.db}getApp(){return this.app}async createUser(e,t){return this.modules.createUserWithEmailAndPassword(this.auth,e,t)}async signIn(e,t){return this.modules.signInWithEmailAndPassword(this.auth,e,t)}async signOut(){return this.modules.signOut(this.auth)}async resetPassword(e){return this.modules.sendPasswordResetEmail(this.auth,e)}async updatePassword(e,t){return this.modules.updatePassword(e,t)}onAuthStateChanged(e){return this.modules.onAuthStateChanged(this.auth,e)}getDoc(e){return this.modules.getDoc(e)}setDoc(e,t,n){const s=this._cleanObject(t);return this.modules.setDoc(e,s,n)}deleteDoc(e){return this.modules.deleteDoc(e)}doc(e){return this.modules.doc(this.db,e)}};class O{constructor(e,t="mi-gestion-v1"){this.userId=e,this.appId=t}async loadFromLocalStorage(){const e=`user_templates_${this.userId}`,t=localStorage.getItem(e);return t?JSON.parse(t):[]}async saveToLocalStorage(e){try{if(!this.userId)return;const t=`user_templates_${this.userId}`;localStorage.setItem(t,JSON.stringify(e))}catch(t){}}getTemplatesRef(){if(!this.userId)throw new Error("ID de usuario no definido para Firestore.");return P.doc(`users/${this.userId}/templates/config`)}async loadFromFirestore(){try{const e=this.getTemplatesRef(),t=await P.getDoc(e);if(t.exists()){const e=t.data();return e.templates||[]}return[]}catch(e){return null}}async saveToFirestore(e){try{if(!this.userId)return;const t=this.getTemplatesRef(),n={updatedAt:(new Date).toISOString(),count:e.length,templates:e};await P.setDoc(t,n,{merge:!0}),await this.saveToLocalStorage(e)}catch(t){throw t}}async checkSyncStatus(e){if(!this.userId)return{synced:!1,error:"Usuario no autenticado"};try{const t=this.getTemplatesRef(),n=await P.getDoc(t);if(n.exists()){const t=n.data(),s=t.templates||[];return{synced:s.length===e.length,localCount:e.length,cloudCount:s.length,cloudTemplates:s,lastUpdated:t.updatedAt,needsSync:s.length!==e.length}}return{synced:!1,localCount:e.length,cloudCount:0,needsSync:!0,cloudTemplates:[]}}catch(t){return{synced:!1,error:t.message}}}}const R=[{value:"string",label:"Texto Breve",inputType:"text",icon:"fas fa-font",description:"Nombres, t√≠tulos o datos cortos."},{value:"text",label:"Texto Largo / Notas",inputType:"textarea",icon:"fas fa-align-left",description:"Descripciones detalladas o p√°rrafos."},{value:"currency",label:"Moneda / Dinero",inputType:"text",icon:"fas fa-dollar-sign",description:"Importes financieros."},{value:"number",label:"N√∫mero",inputType:"text",icon:"fas fa-hashtag",description:"Cantidades, edades, unidades."},{value:"percentage",label:"Porcentaje",inputType:"text",icon:"fas fa-percent",description:"Valores porcentuales (0-100)."},{value:"boolean",label:"S√≠ / No (Interruptor)",inputType:"checkbox",icon:"fas fa-check-square",description:"Opci√≥n binaria verdadero/falso."},{value:"select",label:"Lista de Opciones",inputType:"select",icon:"fas fa-list-ul",description:"Men√∫ desplegable con opciones predefinidas."},{value:"date",label:"Fecha",inputType:"date",icon:"far fa-calendar-alt",description:"Selector de calendario."},{value:"email",label:"Correo Electr√≥nico",inputType:"email",icon:"fas fa-envelope",description:"Validaci√≥n de formato email."},{value:"url",label:"Enlace Web (URL)",inputType:"url",icon:"fas fa-link",description:"Link a sitio web con etiqueta opcional."},{value:"secret",label:"Dato Sensible (Oculto)",inputType:"password",icon:"fas fa-key",description:"Se visualiza con desenfoque/asteriscos."},{value:"table",label:"Tabla Din√°mica",inputType:"table",icon:"fas fa-table",description:"Lista de √≠tems con columnas personalizadas."},{value:"separator",label:"--- SEPARADOR / T√çTULO ---",inputType:"separator",icon:"fas fa-heading",description:"Divisor visual para organizar secciones."}],N=()=>R;const _=new class{getValidFieldTypes(){return N().map(e=>e.value)}generateFieldId(e,t){if(!e||"string"!=typeof e)return`campo_${t+1}`;const n=e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9_$]/g,"_").replace(/_{2,}/g,"_").replace(/^_|_$/g,"");return n&&/^[a-zA-Z_$]/.test(n)?n:`campo_${t+1}`}validateField(e,t){const n=this.getValidFieldTypes();if(!n.includes(e.type))throw new Error(`Tipo de campo inv√°lido: "${e.type}". Tipos v√°lidos: ${n.join(", ")}`);return e.id||(e.id=this.generateFieldId(e.label,t)),"table"===e.type&&e.columns&&Array.isArray(e.columns)&&0!==e.columns.length&&e.columns.forEach((t,s)=>{if(!t.label)throw new Error(`La columna ${s+1} de la tabla '${e.label}' no tiene nombre (etiqueta).`);if(!n.includes(t.type))throw new Error(`Tipo inv√°lido en columna '${t.label}'`);t.id||(t.id=this.generateFieldId(t.label,s))}),void 0===e.sensitive&&(e.sensitive=!1),!0}validateTemplateData(e){if(!e.name)throw new Error("La plantilla debe tener un nombre");if(!e.fields||!Array.isArray(e.fields)||0===e.fields.length)throw new Error("La plantilla debe tener al menos un campo");return e.fields.forEach((e,t)=>{this.validateField(e,t)}),!0}getCategoryName(e){return{personal:"Personal",access:"Accesos",financial:"Financiero",health:"Salud",custom:"Personalizado"}[e]||e}getCategoryIcon(e){return{personal:"üë§",access:"üîê",financial:"üí∞",health:"üè•",custom:"üìã"}[e]||"üìÑ"}};const V=new class{constructor(){this.userId=null,this.appId="mi-gestion-v1",this.userTemplates=[],this.isInitialized=!1,this.storage=null}async initialize(e){this.isInitialized&&this.userId===e||(this.userId=e,this.storage=new O(e,this.appId),await this.loadUserTemplates(),this.isInitialized=!0)}async loadUserTemplates(){try{if(!this.userId)return void(this.userTemplates=[]);let e=await this.storage.loadFromFirestore();null===e&&(e=await this.storage.loadFromLocalStorage()),e&&0!==e.length||(e=this.getDefaultTemplates(),await this.storage.saveToFirestore(e)),this.userTemplates=e}catch(e){this.userTemplates=this.getDefaultTemplates()}}async createTemplate(e){if(!this.userId)throw new Error("Usuario no autenticado");_.validateTemplateData(e);const t={id:`template_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,userId:this.userId,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),...e,settings:{allowDuplicates:!1,maxEntries:0,category:"custom",...e.settings,isSystemTemplate:!1}};return this.userTemplates.push(t),await this.storage.saveToFirestore(this.userTemplates),t}async updateTemplate(e,t){const n=this.userTemplates.findIndex(t=>t.id===e);if(-1===n)throw new Error("Plantilla no encontrada");const s={...this.userTemplates[n],...t};return _.validateTemplateData(s),this.userTemplates[n]={...s,updatedAt:(new Date).toISOString()},await this.storage.saveToFirestore(this.userTemplates),this.userTemplates[n]}async deleteTemplate(e){const t=this.userTemplates.length;if(this.userTemplates=this.userTemplates.filter(t=>t.id!==e),this.userTemplates.length===t)throw new Error("Plantilla no encontrada");return await this.storage.saveToFirestore(this.userTemplates),{success:!0,message:"Plantilla eliminada"}}async exportTemplate(e){const t=await this.getTemplateById(e);if(!t)throw new Error("Plantilla no encontrada");const{id:n,userId:s,createdAt:a,updatedAt:r,...i}=t;return i}async importTemplate(e){return await this.createTemplate(e)}async getUserTemplates(){if(!this.isInitialized)throw new Error("Servicio no inicializado");return 0===this.userTemplates.length?this.getDefaultTemplates():this.userTemplates}async getTemplateById(e){return this.userTemplates.find(t=>t.id===e)||null}async getCategories(){const e=await this.getUserTemplates();return[...new Set(e.map(e=>e.settings.category))].map(t=>({id:t,count:e.filter(e=>e.settings.category===t).length}))}getDefaultTemplates(){return[{id:"tpl_default_access",name:"Accesos y Contrase√±as",description:"Gesti√≥n segura de credenciales",icon:"üîê",color:"#F59E0B",settings:{category:"access",allowDuplicates:!0},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),fields:[{id:"f_site",label:"Sitio / Aplicaci√≥n",type:"string",order:1,required:!0},{id:"f_user",label:"Usuario / Email",type:"string",order:2,required:!1},{id:"f_pass",label:"Contrase√±a",type:"secret",order:3,required:!0},{id:"f_url",label:"URL de acceso",type:"url",order:4,required:!1},{id:"f_notes",label:"Notas adicionales",type:"text",order:5,required:!1}]},{id:"tpl_default_health",name:"Historial M√©dico",description:"Registro b√°sico de salud",icon:"‚öïÔ∏è",color:"#EF4444",settings:{category:"health",allowDuplicates:!1},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),fields:[{id:"f_blood",label:"Tipo de Sangre",type:"string",order:1,required:!1},{id:"f_allergies",label:"Alergias",type:"text",order:2,required:!1},{id:"f_meds",label:"Medicaci√≥n Actual",type:"text",order:3,required:!1},{id:"f_contact",label:"Contacto Emergencia",type:"string",order:4,required:!0}]},{id:"tpl_default_finance",name:"Tarjeta de Cr√©dito",description:"Datos de tarjetas bancarias",icon:"üí≥",color:"#10B981",settings:{category:"financial",allowDuplicates:!0},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),fields:[{id:"f_bank",label:"Banco / Emisor",type:"string",order:1,required:!0},{id:"f_number",label:"N√∫mero de Tarjeta",type:"secret",order:2,required:!0},{id:"f_exp",label:"Vencimiento (MM/AA)",type:"string",order:3,required:!0},{id:"f_cvv",label:"CVV",type:"secret",order:4,required:!0},{id:"f_pin",label:"PIN Cajero",type:"secret",order:5,required:!1}]}]}async checkSyncStatus(){return this.storage.checkSyncStatus(this.userTemplates)}async syncTemplates(){const e=await this.storage.checkSyncStatus(this.userTemplates);if(e.needsSync){if(e.cloudCount>e.localCount)return this.userTemplates=e.cloudTemplates,await this.storage.saveToLocalStorage(this.userTemplates),{synced:!0,message:`Descargadas ${e.cloudCount} plantillas.`};if(e.localCount>e.cloudCount)return await this.storage.saveToFirestore(this.userTemplates),{synced:!0,message:`Subidas ${e.localCount} plantillas.`}}return{synced:!0,message:"Sincronizado."}}},H=Object.freeze(Object.defineProperty({__proto__:null,templateService:V},Symbol.toStringTag,{value:"Module"})),z={},U=function(e,t,n){let s=Promise.resolve();if(t&&t.length>0){let e=function(e){return Promise.all(e.map(e=>Promise.resolve(e).then(e=>({status:"fulfilled",value:e}),e=>({status:"rejected",reason:e}))))};document.getElementsByTagName("link");const n=document.querySelector("meta[property=csp-nonce]"),a=n?.nonce||n?.getAttribute("nonce");s=e(t.map(e=>{if((e=function(e){return"/"+e}(e))in z)return;z[e]=!0;const t=e.endsWith(".css"),n=t?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${e}"]${n}`))return;const s=document.createElement("link");return s.rel=t?"stylesheet":"modulepreload",t||(s.as="script"),s.crossOrigin="",s.href=e,a&&s.setAttribute("nonce",a),document.head.appendChild(s),t?new Promise((t,n)=>{s.addEventListener("load",t),s.addEventListener("error",()=>n(new Error(`Unable to preload CSS for ${e}`)))}):void 0}))}function a(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return s.then(t=>{for(const e of t||[])"rejected"===e.status&&a(e.reason);return e().catch(a)})};const G=new class{constructor(){this.db=null,this.collectionName="documents",setTimeout(()=>{window.firebaseModules&&(this.db=window.firebaseModules.db)},500)}getCollection(){if(!this.db||!window.firebaseModules)throw new Error("Firebase no inicializado");const e=M.getCurrentUser();if(!e)throw new Error("Usuario no autenticado");const{collection:t}=window.firebaseModules;return t(this.db,`users/${e.uid}/${this.collectionName}`)}async getById(e){const{doc:t,getDoc:n}=window.firebaseModules,s=await n(t(this.getCollection(),e));if(!s.exists())throw new Error("No encontrado");return{id:s.id,...s.data()}}async create(e){const{title:t,data:n,template:s,tags:a}=e,r={title:t||"Sin T√≠tulo",templateName:s.name,icon:s.icon,color:s.color,tags:a||[],createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()},i=await j.encryptDocument(n),{doc:o,setDoc:l}=window.firebaseModules,d=o(this.getCollection()),c={id:d.id,templateId:s.id,encryptedContent:i,encryptionMetadata:{version:1,algo:"AES-GCM"},metadata:r};return await l(d,c),c}async update(e,t){const{title:n,data:s,template:a,tags:r}=t,i=await j.encryptDocument(s),{doc:o,setDoc:l}=window.firebaseModules,d=o(this.getCollection(),e),c={encryptedContent:i,metadata:{title:n,tags:r||[],updatedAt:(new Date).toISOString(),icon:a.icon,color:a.color,templateName:a.name}};return await l(d,c,{merge:!0}),{id:e,...c}}async delete(e){const{doc:t,deleteDoc:n}=window.firebaseModules;await n(t(this.getCollection(),e))}async listDocuments(){return(await this.getAllDocuments()).map(e=>({id:e.id,templateId:e.templateId,title:e.metadata?.title||"Sin T√≠tulo",updatedAt:e.metadata?.updatedAt||(new Date).toISOString(),createdAt:e.metadata?.createdAt||(new Date).toISOString(),icon:e.metadata?.icon,color:e.metadata?.color,templateName:e.metadata?.templateName,tags:e.metadata?.tags||[],...e}))}async getAllDocuments(){try{if(!window.firebaseModules)return[];const{getDocs:e,query:t,orderBy:n}=window.firebaseModules,s=t(this.getCollection(),n("metadata.updatedAt","desc"));return(await e(s)).docs.map(e=>({id:e.id,...e.data()}))}catch(e){return[]}}async loadDocumentForEditing(e){const t=await this.getById(e),{templateService:n}=await U(async()=>{const{templateService:e}=await Promise.resolve().then(()=>H);return{templateService:e}},void 0);let s=t.template;if(s||(s=await n.getTemplateById(t.templateId)),!s)throw new Error("Plantilla no existe");return{document:t,template:s,formData:await j.decryptDocument(t.encryptedContent),metadata:t.metadata}}async reEncryptAllDocuments(e){const t=await j.deriveTemporaryKey(e),n=await this.getAllDocuments();if(0===n.length)return!0;const{writeBatch:s,doc:a}=window.firebaseModules,r=s(this.db);for(const o of n)try{const e=await j.decryptDocument(o.encryptedContent),n=await j.encryptDocument(e,t),s=a(this.getCollection(),o.id);r.update(s,{encryptedContent:n,"encryptionMetadata.updatedAt":(new Date).toISOString()})}catch(i){throw new Error(`Error integridad doc ${o.id}`)}return await r.commit(),j.setNewMasterKey(t),!0}async getDocumentsByTemplateId(e){if(!window.firebaseModules)return[];const{getDocs:t,query:n,where:s}=window.firebaseModules;try{const a=n(this.getCollection(),s("templateId","==",e));return(await t(a)).docs.map(e=>({id:e.id,...e.data()}))}catch(a){return[]}}async deleteDocumentsByTemplateId(e){const t=await this.getDocumentsByTemplateId(e);if(0===t.length)return 0;const{writeBatch:n,doc:s}=window.firebaseModules,a=n(this.db);return t.forEach(e=>{const t=s(this.getCollection(),e.id);a.delete(t)}),await a.commit(),t.length}async getStorageStats(){try{const e=await this.getAllDocuments();let t=0;return e.forEach(e=>{e.encryptedContent&&(t+=new Blob([JSON.stringify(e.encryptedContent)]).size),e.metadata&&(t+=new Blob([JSON.stringify(e.metadata)]).size)}),{count:e.length,bytes:t}}catch(e){return{count:0,bytes:0}}}},W={"es-VE":{moneda:"Bol√≠var",codigo:"VES"},"es-ES":{moneda:"Euro",codigo:"EUR"},"en-US":{moneda:"D√≥lar USD",codigo:"USD"},"en-GB":{moneda:"Libra",codigo:"GBP"},"fr-FR":{moneda:"Euro",codigo:"EUR"},"es-AR":{moneda:"Peso Arg",codigo:"ARS"},"es-CO":{moneda:"Peso Col",codigo:"COP"},"es-MX":{moneda:"Peso Mex",codigo:"MXN"},es:{moneda:"D√≥lar USD",codigo:"USD"},"es-419":{moneda:"D√≥lar USD",codigo:"USD"}},K=()=>{const e=navigator.language;if(W[e])return{locale:e,...W[e]};const t=e.split("-")[0];return W[t]?{locale:t,...W[t]}:{locale:"en-US",...W["en-US"]}},J=(e,t)=>{if(!e||"string"!=typeof e)return`campo_${t+1}`;const n=e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]/g,"_").replace(/_+/g,"_").replace(/^_|_$/g,"");return n.length<2||/^\d/.test(n)?`campo_${t+1}_${n}`:n},X=e=>({personal:"üë§",access:"üîê",financial:"üí≥",health:"‚ù§Ô∏è",home:"üè†",car:"üöó",job:"üíº",education:"üéì",custom:"‚ö°",all:"üìÇ"}[e]||"üìã");class Y{constructor(e){this.handlers=e}render(e,t,n){const s=e.filter(e=>!e.settings?.isSystemTemplate),a=t.map(e=>{const t=e.id===n;return`\n        <button class="flex items-center px-3 py-1.5 rounded-full text-xs font-bold transition-all border category-filter whitespace-nowrap gap-2 ${t?"bg-slate-800 text-white shadow-md border-slate-800":"bg-white text-slate-600 border-slate-200 hover:border-slate-300 hover:bg-slate-50"}" \n                data-category="${e.id}">\n            <span>${X(e.id)}</span>\n            ${s=e.id,{personal:"Personal",access:"Accesos / Claves",financial:"Financiero",health:"Salud",home:"Hogar",car:"Veh√≠culo",job:"Laboral",education:"Educaci√≥n",custom:"Personalizado",all:"Todas"}[s]||"Otros"}\n            <span class="${t?"text-white/60":"text-slate-400"} text-[10px]">\n                ${e.count}\n            </span>\n        </button>`;var s}).join(""),r="all"===n;return`\n      <div class="animate-fade-in space-y-6">\n        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">\n            <div>\n                <h2 class="text-xl font-bold text-slate-800">Cat√°logo de Plantillas</h2>\n                <p class="text-slate-500 text-sm">Define la estructura de tus datos.</p>\n            </div>\n            \n            <div class="flex gap-3 w-full sm:w-auto">\n              <input type="file" id="importTemplateInput" accept=".json" class="hidden" />\n              <button id="btnImportTemplate" class="px-4 py-2 bg-white border border-slate-200 text-slate-600 hover:text-brand-600 hover:border-brand-200 rounded-lg transition shadow-sm text-sm font-medium flex items-center gap-2">\n                <i class="fas fa-file-import"></i> <span>Importar</span>\n              </button>\n              <button id="btnNewTemplate" class="px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white font-bold rounded-lg transition shadow-md flex items-center gap-2 text-sm">\n                <i class="fas fa-plus"></i> <span>Crear Nueva</span>\n              </button>\n            </div>\n        </div>\n\n        <div class="flex flex-wrap gap-2 pb-2">\n            <button class="flex items-center px-3 py-1.5 rounded-full text-xs font-bold transition-all border category-filter whitespace-nowrap gap-2 ${r?"bg-slate-800 text-white shadow-md border-slate-800":"bg-white text-slate-600 border-slate-200 hover:bg-slate-50"}" data-category="all">\n                <span>üí†</span> Todas\n                <span class="${r?"text-white/60":"text-slate-400"} text-[10px]">${e.length}</span>\n            </button>\n            ${a}\n        </div>\n\n        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">\n            ${s.map(e=>this.renderCard(e)).join("")}\n        </div>\n        \n        ${0===s.length?'\n            <div class="text-center py-12 border border-dashed border-slate-200 rounded-xl bg-slate-50/50">\n                <p class="text-slate-400 text-sm">No se encontraron plantillas en esta categor√≠a.</p>\n            </div>':""}\n      </div>`}renderCard(e){const t=e.fields.length,n=e.color||"#64748b";return`\n    <div class="template-card group bg-white border border-slate-200 rounded-xl p-5 hover:shadow-card hover:border-brand-200 transition-all cursor-pointer relative overflow-hidden" \n         data-template-id="${e.id}">\n      \n      <div class="flex justify-between items-start mb-3">\n          <div class="w-10 h-10 rounded-lg flex items-center justify-center text-xl border border-slate-100" style="background-color: ${n}10; color: ${n}">\n                ${e.icon||"üìã"}\n          </div>\n          <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">\n              <button class="edit-template p-1.5 text-slate-400 hover:text-brand-600 hover:bg-brand-50 rounded transition"><i class="fas fa-pen text-xs"></i></button>\n              <button class="export-template p-1.5 text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 rounded transition"><i class="fas fa-download text-xs"></i></button>\n              <button class="delete-template p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded transition"><i class="fas fa-trash text-xs"></i></button>\n          </div>\n      </div>\n      \n      <h4 class="font-bold text-slate-800 text-base mb-1 group-hover:text-brand-600 transition-colors">${e.name}</h4>\n      <p class="text-xs text-slate-500 mb-4 line-clamp-2 h-8 leading-relaxed">\n        ${e.description||"Sin descripci√≥n."}\n      </p>\n\n      <div class="flex items-center justify-between pt-3 border-t border-slate-50">\n        <span class="text-[10px] font-bold uppercase tracking-wider text-slate-400 bg-slate-50 px-2 py-0.5 rounded border border-slate-100">\n            ${t} Campos\n        </span>\n        <span class="text-[10px] font-bold text-slate-300 group-hover:text-brand-500 transition-colors">\n            Usar <i class="fas fa-arrow-right ml-1"></i>\n        </span>\n      </div>\n    </div>`}setupListeners(e){e.querySelector("#btnNewTemplate")?.addEventListener("click",this.handlers.onNew);const t=e.querySelector("#importTemplateInput");e.querySelector("#btnImportTemplate")?.addEventListener("click",()=>t.click()),t?.addEventListener("change",e=>{e.target.files.length&&this.handlers.onImport(e.target.files[0])}),e.querySelectorAll(".category-filter").forEach(e=>{e.addEventListener("click",e=>this.handlers.onFilter(e.currentTarget.dataset.category))}),e.addEventListener("click",e=>{const t=e.target.closest(".edit-template");if(t)return e.stopPropagation(),void this.handlers.onEdit(t.closest(".template-card").dataset.templateId);const n=e.target.closest(".delete-template");if(n)return e.stopPropagation(),void this.handlers.onDelete(n.closest(".template-card").dataset.templateId);const s=e.target.closest(".export-template");if(s)return e.stopPropagation(),void this.handlers.onExport(s.closest(".template-card").dataset.templateId);const a=e.target.closest(".template-card");a&&this.handlers.onSelect(a.dataset.templateId)})}}class Z{constructor(e,t,n){this.data={...e},this.index=t,this.callbacks=n||{},this.domElement=null}render(){return`\n      <div class="field-item-config group relative bg-white border border-slate-200 rounded-2xl p-1 transition-all duration-300 hover:shadow-lg hover:border-primary/50 mb-4" data-id="${this.data.id}">\n        <div class="flex items-stretch">\n          \n          <div class="w-10 flex flex-col items-center justify-center text-slate-300 cursor-grab active:cursor-grabbing hover:text-indigo-500 drag-handle rounded-l-xl border-r border-slate-200/50 transition-colors">\n              <i class="fas fa-grip-vertical"></i>\n          </div>\n\n          <div class="flex-grow p-4">\n              <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-3">\n                  <div class="md:col-span-7">\n                      <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">\n                          Etiqueta del Campo\n                      </label>\n                      <input type="text" class="field-label-input w-full px-3 py-2 bg-white/60 border border-slate-200 rounded-lg focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-semibold text-slate-700 text-sm" \n                             value="${this.data.label||""}" \n                             placeholder="Ej: Nombre del Cliente" required />\n                  </div>\n                  \n                  <div class="md:col-span-5">\n                      <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Tipo de Dato</label>\n                      <div class="relative">\n                          <select class="field-type-select w-full px-3 py-2 bg-white border border-slate-200 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition appearance-none cursor-pointer text-sm font-medium text-slate-600">\n                              ${this.renderTypeOptions()}\n                          </select>\n                          <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400"><i class="fas fa-chevron-down text-xs"></i></div>\n                      </div>\n                  </div>\n              </div>\n\n              <div class="specific-settings-container space-y-3">\n                  ${this.renderSpecificSettings()}\n              </div>\n\n              <div class="flex items-center justify-end pt-2 mt-2 border-t border-slate-50">\n                  <label class="flex items-center cursor-pointer select-none group/check p-1.5 rounded-lg hover:bg-slate-50 transition">\n                      <input type="checkbox" class="field-required-check form-checkbox h-4 w-4 text-indigo-600 rounded border-slate-300 focus:ring-indigo-500 transition" \n                        ${this.data.required?"checked":""}>\n                      <span class="ml-2 text-xs font-bold text-slate-400 group-hover/check:text-slate-600 transition-colors">Campo Obligatorio</span>\n                  </label>\n              </div>\n          </div>\n\n          <button type="button" class="btn-remove-field absolute -top-3 -right-3 w-8 h-8 bg-white text-slate-300 hover:text-white hover:bg-red-500 border border-slate-200 hover:border-red-500 rounded-full shadow-md flex items-center justify-center transition-all z-20 opacity-0 group-hover:opacity-100 scale-75 group-hover:scale-100">\n              <i class="fas fa-times text-sm"></i>\n          </button>\n        </div>\n      </div>\n    `}renderTypeOptions(){return N().map(e=>`<option value="${e.value}" ${this.data.type===e.value?"selected":""}>${e.label}</option>`).join("")}renderSpecificSettings(){return""}postRender(e){this.domElement=e.querySelector(`[data-id="${this.data.id}"]`),this.domElement&&(this.attachCommonListeners(),this.attachSpecificListeners())}attachCommonListeners(){const e=this.domElement.querySelector(".field-label-input"),t=this.domElement.querySelector(".field-type-select"),n=this.domElement.querySelector(".field-required-check"),s=this.domElement.querySelector(".btn-remove-field");e?.addEventListener("input",e=>{this.data.label=e.target.value,this.notifyChange()}),t?.addEventListener("change",e=>{const t=e.target.value;this.data.type=t,this.callbacks.onTypeChange&&this.callbacks.onTypeChange(this,t)}),n?.addEventListener("change",e=>{this.data.required=e.target.checked,this.notifyChange()}),s?.addEventListener("click",()=>{this.callbacks.onRemove&&this.callbacks.onRemove(this)})}attachSpecificListeners(){}notifyChange(){this.callbacks.onChange&&this.callbacks.onChange(this.getDefinition())}getDefinition(){return{...this.data}}}class Q extends Z{}class ee extends Z{renderSpecificSettings(){return`\n      <div class="options-config animate-fade-in p-3 bg-amber-50 border border-amber-100 rounded-xl">\n          <label class="block text-[10px] font-bold text-amber-700 uppercase mb-1 ml-1">\n              Opciones (Separadas por coma)\n          </label>\n          <input type="text" class="field-options-input w-full px-3 py-2 bg-white border border-amber-200 rounded-lg text-sm text-slate-700 placeholder-amber-800/30 focus:ring-2 focus:ring-amber-200 focus:border-amber-400 outline-none transition" \n                 value="${(this.data.options||[]).join(", ")}" \n                 placeholder="Opci√≥n A, Opci√≥n B, Opci√≥n C">\n          <p class="text-[10px] text-amber-600 mt-1 ml-1">Los usuarios elegir√°n una de estas opciones.</p>\n      </div>\n    `}attachSpecificListeners(){const e=this.domElement.querySelector(".field-options-input");e&&e.addEventListener("input",e=>{const t=e.target.value;this.data.options=t.split(",").map(e=>e.trim()).filter(e=>e),this.notifyChange()})}getDefinition(){return{...super.getDefinition(),options:this.data.options||[]}}}class te extends Z{render(){return`\n      <div class="field-item-config group relative bg-slate-50 border border-slate-300 shadow-inner rounded-2xl p-1 transition-all duration-300 mb-4" data-id="${this.data.id}">\n        <div class="flex items-stretch">\n          \n          <div class="w-10 flex flex-col items-center justify-center text-slate-400 cursor-grab active:cursor-grabbing hover:text-indigo-500 drag-handle rounded-l-xl border-r border-slate-200/50">\n              <i class="fas fa-grip-vertical"></i>\n          </div>\n\n          <div class="flex-grow p-4">\n              <div class="grid grid-cols-1 md:grid-cols-12 gap-4">\n                  <div class="md:col-span-7">\n                      <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1 ml-1">\n                          T√≠tulo de la Secci√≥n\n                      </label>\n                      <input type="text" class="field-label-input w-full px-3 py-2 bg-white border border-slate-300 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-bold text-slate-800 text-sm shadow-sm" \n                             value="${this.data.label||""}" \n                             placeholder="Ej: Informaci√≥n Personal" required />\n                  </div>\n                  \n                  <div class="md:col-span-5">\n                      <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Tipo</label>\n                      <div class="relative opacity-75">\n                           <select class="field-type-select w-full px-3 py-2 bg-slate-100 border border-slate-300 rounded-lg outline-none text-sm font-medium text-slate-500 cursor-pointer hover:bg-white transition">\n                              ${this.renderTypeOptions()}\n                           </select>\n                           <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400"><i class="fas fa-chevron-down text-xs"></i></div>\n                      </div>\n                  </div>\n              </div>\n\n              <div class="pt-4 pb-1 text-center opacity-60">\n                <div class="h-px bg-slate-300 w-full flex items-center justify-center">\n                    <span class="bg-slate-200 px-3 py-0.5 rounded text-[10px] text-slate-500 font-bold uppercase tracking-widest">Divisor Visual</span>\n                </div>\n            </div>\n          </div>\n\n          <button type="button" class="btn-remove-field absolute -top-3 -right-3 w-8 h-8 bg-white text-slate-300 hover:text-white hover:bg-red-500 border border-slate-200 hover:border-red-500 rounded-full shadow-md flex items-center justify-center transition-all z-20 opacity-0 group-hover:opacity-100 scale-75 group-hover:scale-100">\n              <i class="fas fa-times text-sm"></i>\n          </button>\n        </div>\n      </div>\n    `}}const ne=new class{constructor(){this.modalId="columns-config-modal",this.currentColumns=[],this.onSave=null,this.columnControllers=[],this.injectModalHtml(),this.bindGlobalEvents()}open(e,t){this.currentColumns=JSON.parse(JSON.stringify(e||[])),this.onSave=t,this.columnControllers=[],this.renderColumnItems();const n=document.getElementById(this.modalId);n&&(n.classList.remove("hidden"),this.initSortable())}close(){const e=document.getElementById(this.modalId);e&&e.classList.add("hidden"),this.columnControllers=[]}renderColumnItems(){const e=document.getElementById("modal-columns-container");e&&(e.innerHTML="",this.currentColumns.forEach((e,t)=>{this.addColumnController(e,t)}),this.updateEmptyState())}addColumnController(e,t){const n=document.getElementById("modal-columns-container");"table"!==e.type&&"separator"!==e.type||(e.type="text");try{const s=re.createController(e,t,{onRemove:e=>{e.domElement.remove(),this.columnControllers=this.columnControllers.filter(t=>t!==e),this.updateEmptyState()},onTypeChange:(e,t)=>this.handleTypeChange(e,t)});this.renderControllerToDOM(s,n),this.columnControllers.push(s)}catch(s){}}handleTypeChange(e,t){const n=document.getElementById("modal-columns-container"),s=e.getDefinition();s.type=t,"select"!==t&&delete s.options;const a=re.createController(s,e.index,{onRemove:e=>{e.domElement.remove(),this.columnControllers=this.columnControllers.filter(t=>t!==e),this.updateEmptyState()},onTypeChange:(e,t)=>this.handleTypeChange(e,t)}),r=document.createElement("div");r.innerHTML=a.render();const i=r.firstElementChild;i.classList.remove("mb-4"),i.classList.add("mb-2","scale-95","origin-left"),e.domElement.replaceWith(i),a.postRender(n),this.filterForbiddenOptions(i);const o=this.columnControllers.indexOf(e);-1!==o&&(this.columnControllers[o]=a)}renderControllerToDOM(e,t){const n=document.createElement("div");n.innerHTML=e.render();const s=n.firstElementChild;s.classList.remove("mb-4"),s.classList.add("mb-2","scale-95","origin-left"),t.appendChild(s),e.postRender(t),this.filterForbiddenOptions(s)}filterForbiddenOptions(e){const t=e.querySelector(".field-type-select");t&&[...t.options].forEach(e=>{"table"!==e.value&&"separator"!==e.value||e.remove()})}addNewColumn(){const e=this.columnControllers.length,t={id:`col_${Date.now()}`,label:"",type:"string",required:!1};this.addColumnController(t,e),this.updateEmptyState();const n=document.getElementById("modal-columns-container");setTimeout(()=>{n.scrollTop=n.scrollHeight},50)}handleSave(){const e=this.columnControllers.map(e=>e.getDefinition());this.onSave&&this.onSave(e),this.close()}updateEmptyState(){const e=document.getElementById("modal-columns-container"),t=document.getElementById("modal-empty-msg"),n=e.children.length>0;t&&t.classList.toggle("hidden",n)}initSortable(){const e=document.getElementById("modal-columns-container");window.Sortable&&e&&(e._sortable&&e._sortable.destroy(),e._sortable=new window.Sortable(e,{animation:150,handle:".drag-handle",ghostClass:"bg-indigo-50"}))}injectModalHtml(){if(document.getElementById(this.modalId))return;const e=`\n      <div id="${this.modalId}" class="fixed inset-0 z-[60] hidden">\n        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" id="modal-backdrop"></div>\n        <div class="relative w-full h-full flex items-center justify-center p-4">\n            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[85vh] animate-fade-in-up overflow-hidden">\n                <div class="px-8 py-6 bg-white border-b border-slate-100 flex justify-between items-center z-10">\n                    <div class="flex items-center gap-4">\n                        <div class="w-10 h-10 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center text-lg">\n                            <i class="fas fa-table"></i>\n                        </div>\n                        <div>\n                            <h3 class="text-lg font-bold text-slate-800">Configurar Columnas</h3>\n                            <p class="text-xs text-slate-500 font-medium">Define la estructura de tu tabla.</p>\n                        </div>\n                    </div>\n                    <button type="button" id="modal-close-top" class="text-slate-400 hover:text-slate-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 transition"><i class="fas fa-times"></i></button>\n                </div>\n                <div class="p-6 overflow-y-auto flex-grow bg-slate-50/50 custom-scrollbar relative">\n                    <div id="modal-columns-container" class="space-y-3 min-h-[50px]"></div>\n                    <div id="modal-empty-msg" class="flex flex-col items-center justify-center py-10 opacity-60">\n                        <i class="fas fa-columns text-4xl text-slate-300 mb-2"></i>\n                        <p class="text-sm text-slate-400">Sin columnas definidas</p>\n                    </div>\n                    <button type="button" id="modal-add-btn" class="mt-6 w-full py-3 border-2 border-dashed border-indigo-200 bg-indigo-50/30 text-indigo-600 rounded-xl hover:bg-indigo-50 hover:border-indigo-300 transition flex items-center justify-center font-bold text-sm gap-2">\n                        <i class="fas fa-plus-circle"></i> Agregar Columna\n                    </button>\n                </div>\n                <div class="px-8 py-5 border-t border-slate-100 flex justify-end space-x-3 bg-white z-10">\n                    <button type="button" id="modal-cancel-btn" class="px-5 py-2.5 text-slate-600 font-bold hover:bg-slate-50 rounded-xl transition text-sm">Cancelar</button>\n                    <button type="button" id="modal-save-btn" class="px-6 py-2.5 text-white bg-indigo-600 hover:bg-indigo-700 font-bold rounded-xl shadow-lg shadow-indigo-500/20 transition text-sm flex items-center gap-2">\n                        <i class="fas fa-check"></i> Aplicar Cambios\n                    </button>\n                </div>\n            </div>\n        </div>\n      </div>\n    `;document.body.insertAdjacentHTML("beforeend",e)}bindGlobalEvents(){document.getElementById("modal-close-top")?.addEventListener("click",()=>this.close()),document.getElementById("modal-cancel-btn")?.addEventListener("click",()=>this.close()),document.getElementById("modal-backdrop")?.addEventListener("click",()=>this.close()),document.getElementById("modal-add-btn")?.addEventListener("click",()=>this.addNewColumn()),document.getElementById("modal-save-btn")?.addEventListener("click",()=>this.handleSave())}};class se extends Z{constructor(e,t,n){super(e,t,n),this.data.columns=this.data.columns||[]}renderSpecificSettings(){return`\n      <div class="table-config-area mt-2 p-3 bg-indigo-50 border border-indigo-100 rounded-xl">\n          <div class="flex items-center justify-between">\n              <div class="flex items-center gap-3">\n                  <div class="w-10 h-10 rounded-lg bg-white flex items-center justify-center text-indigo-600 shadow-sm border border-indigo-100">\n                    <i class="fas fa-table"></i>\n                  </div>\n                  <div>\n                      <p class="text-sm font-bold text-indigo-900">Estructura de Tabla</p>\n                      <p class="text-xs text-indigo-600 font-medium">\n                        <span class="col-count-badge font-extrabold bg-white px-1.5 rounded text-indigo-800 shadow-sm">${this.data.columns.length}</span> columnas definidas\n                      </p>\n                  </div>\n              </div>\n              \n              <button type="button" class="btn-configure-table px-4 py-1.5 bg-white text-indigo-600 text-xs font-bold border border-indigo-200 rounded-lg hover:bg-indigo-600 hover:text-white shadow-sm transition-all transform active:scale-95">\n                  <i class="fas fa-cog mr-1"></i> Configurar\n              </button>\n          </div>\n      </div>\n    `}attachSpecificListeners(){const e=this.domElement.querySelector(".btn-configure-table");e&&e.addEventListener("click",()=>{ne.open(this.data.columns,e=>{this.data.columns=e;const t=this.domElement.querySelector(".col-count-badge");t&&(t.textContent=e.length),this.notifyChange()})})}getDefinition(){return{...super.getDefinition(),columns:this.data.columns}}}class ae extends Z{renderSpecificSettings(){return`\n      <div class="mt-3 animate-fade-in">\n        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">\n            Texto de Ayuda (Placeholder)\n        </label>\n        <div class="relative">\n            <input type="text" class="field-placeholder-input w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm text-slate-600 focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition" \n               value="${this.data.placeholder||""}" \n               placeholder="Ej: Ingresa el nombre completo...">\n            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400">\n                <i class="fas fa-i-cursor text-xs"></i>\n            </div>\n        </div>\n        <p class="text-[10px] text-slate-400 mt-1 ml-1">Se mostrar√° dentro del campo cuando est√© vac√≠o.</p>\n      </div>\n    `}attachSpecificListeners(){const e=this.domElement.querySelector(".field-placeholder-input");e&&e.addEventListener("input",e=>{this.data.placeholder=e.target.value,this.notifyChange()})}getDefinition(){return{...super.getDefinition(),placeholder:this.data.placeholder||""}}}const re=new class{constructor(){this.configs={},this.registerDefaults()}register(e,t){this.configs[e]=t}registerDefaults(){this.register("select",ee),this.register("separator",te),this.register("table",se),this.register("string",ae),this.register("text",ae),this.register("default",Q)}createController(e,t,n){const s=this.configs[e.type]||this.configs.default;if(!s)throw new Error(`No hay configuraci√≥n registrada para el tipo: ${e.type}`);return new s(e,t,n)}};class ie{constructor(e){this.handlers=e,this.fieldControllers=[],this.sortable=null}render(e=null){this.fieldControllers=[];(e?.fields||[]).forEach((e,t)=>{const n=this.createController(e,t);this.fieldControllers.push(n)});return function(e,t,n=""){const s=t?.settings?.category||"custom",a=t?.icon||"üìã",r=t?.color||"#4F46E5";return`\n      <div class="max-w-4xl mx-auto animate-fade-in-up pb-24 flex flex-col gap-6">\n          \n          <div class="bg-white/90 backdrop-blur-md border border-slate-200 rounded-2xl p-4 shadow-sm sticky top-4 z-40 transition-all">\n            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">\n                <div class="flex items-center">\n                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary to-secondary text-white flex items-center justify-center mr-4 shadow-lg shadow-indigo-500/20 flex-shrink-0">\n                        <i class="fas fa-${e?"pen-nib":"magic"} text-xl"></i>\n                    </div>\n                    <div>\n                        <h3 class="text-xl font-bold text-slate-800 leading-tight">\n                            ${e?"Editar Plantilla":"Nueva Estructura"}\n                        </h3>\n                        <p class="text-xs text-slate-500 font-medium">Dise√±a los campos de tu documento</p>\n                    </div>\n                </div>\n                <div class="flex gap-3 w-full sm:w-auto">\n                     <button type="button" id="cancelTemplate" class="flex-1 sm:flex-none px-5 py-2.5 bg-white border border-slate-300 text-slate-600 rounded-xl hover:bg-slate-50 hover:text-slate-800 transition font-bold text-sm shadow-sm">\n                        Cancelar\n                     </button>\n                     <button type="button" id="saveTemplateBtnHeader" class="flex-1 sm:flex-none px-6 py-2.5 bg-gradient-to-r from-primary to-secondary hover:from-primary-hover hover:to-secondary-hover text-white rounded-xl shadow-lg shadow-indigo-500/30 transition transform active:scale-95 font-bold text-sm flex items-center justify-center gap-2">\n                          <i class="fas fa-save"></i> <span>Guardar</span>\n                     </button>\n                </div>\n            </div>\n          </div>\n          \n          <form id="templateForm" class="space-y-6">\n              \n              <div class="bg-white p-6 sm:p-8 rounded-3xl shadow-xl shadow-slate-200/50 border border-slate-100">\n                  <div class="flex items-center gap-2 mb-6 border-b border-slate-100 pb-4">\n                     <i class="fas fa-info-circle text-indigo-400"></i>\n                     <h4 class="text-sm font-bold text-slate-500 uppercase tracking-wider">Informaci√≥n B√°sica</h4>\n                  </div>\n\n                  <div class="grid grid-cols-1 md:grid-cols-12 gap-6">\n                      <div class="md:col-span-8">\n                          <label class="block text-xs font-bold text-slate-400 uppercase mb-2 ml-1">Nombre</label>\n                          <input type="text" id="templateName" value="${t?.name||""}" \n                                 class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:border-primary focus:ring-4 focus:ring-primary/10 outline-none transition text-slate-800 font-bold placeholder-slate-400 text-lg" \n                                 required placeholder="Ej: Tarjeta de Cr√©dito">\n                      </div>\n\n                      <div class="md:col-span-4">\n                          <label class="block text-xs font-bold text-slate-400 uppercase mb-2 ml-1">Categor√≠a</label>\n                          <div class="relative">\n                              <select id="templateCategory" class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:border-primary focus:ring-4 focus:ring-primary/10 outline-none transition appearance-none cursor-pointer font-medium text-slate-700">\n                                  ${[{value:"custom",label:"Personalizado"},{value:"personal",label:"Personal"},{value:"access",label:"Accesos"},{value:"financial",label:"Financiero"},{value:"health",label:"Salud"},{value:"home",label:"Hogar"},{value:"car",label:"Veh√≠culo"},{value:"job",label:"Trabajo"},{value:"education",label:"Formaci√≥n"}].map(e=>`<option value="${e.value}" ${e.value===s?"selected":""}>${e.label}</option>`).join("")}\n                              </select>\n                              <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-400"><i class="fas fa-chevron-down text-xs"></i></div>\n                          </div>\n                      </div>\n\n                      <div class="md:col-span-3">\n                          <label class="block text-xs font-bold text-slate-400 uppercase mb-2 ml-1">Icono</label>\n                          <input type="text" id="templateIcon" value="${a}" \n                                 class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-center text-2xl focus:bg-white focus:border-primary focus:ring-4 focus:ring-primary/10 outline-none transition" \n                                 placeholder="üìã">\n                      </div>\n                      \n                      <div class="md:col-span-9">\n                          <label class="block text-xs font-bold text-slate-400 uppercase mb-2 ml-1">Color de Identidad</label>\n                          <div class="flex items-center gap-3 h-[52px] border border-slate-200 rounded-xl p-2 bg-slate-50">\n                              <input type="color" id="templateColor" value="${r}" class="h-full w-16 rounded-lg cursor-pointer border-none p-0 bg-transparent shadow-sm">\n                              <span class="text-xs text-slate-400 font-medium">Selecciona un color para identificar r√°pidamente esta plantilla.</span>\n                          </div>\n                      </div>\n\n                      <div class="md:col-span-12">\n                          <label class="block text-xs font-bold text-slate-400 uppercase mb-2 ml-1">Descripci√≥n (Opcional)</label>\n                          <input type="text" id="templateDescription" value="${t?.description||""}" \n                                 class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:border-primary focus:ring-4 focus:ring-primary/10 outline-none transition text-slate-600" \n                                 placeholder="Describe brevemente el prop√≥sito de este documento...">\n                      </div>\n                  </div>\n              </div>\n              \n              <div class="bg-white p-6 sm:p-8 rounded-3xl shadow-xl shadow-slate-200/50 border border-slate-100 relative min-h-[400px]">\n                  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4 border-b border-slate-100 pb-6">\n                    <div>\n                        <div class="flex items-center gap-2 mb-1">\n                             <i class="fas fa-layer-group text-secondary"></i>\n                             <h4 class="text-sm font-bold text-slate-500 uppercase tracking-wider">Campos del Documento</h4>\n                        </div>\n                        <p class="text-xs text-slate-400 ml-6">Arrastra desde <i class="fas fa-grip-vertical text-[10px] mx-1"></i> para ordenar.</p>\n                    </div>\n                    \n                    </div>\n\n                  <div id="fieldsContainer" class="space-y-4">\n                      ${n}\n                  </div>\n                  \n                  <div id="noFieldsMessage" class="hidden flex flex-col items-center justify-center py-16 border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50/30 mt-4 transition-all hover:bg-slate-50 hover:border-indigo-200 group cursor-pointer" onclick="document.getElementById('addFieldBtn').click()">\n                      <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mb-4 shadow-sm border border-slate-100 group-hover:scale-110 transition-transform duration-300">\n                          <i class="fas fa-plus text-3xl text-slate-300 group-hover:text-indigo-400"></i>\n                      </div>\n                      <p class="text-slate-600 font-bold text-lg">Lienzo Vac√≠o</p>\n                      <p class="text-sm text-slate-400 group-hover:text-indigo-500 transition-colors">Haz clic para agregar tu primer campo</p>\n                  </div>\n\n                  <button type="button" id="addFieldBtn" class="mt-6 w-full py-3 border-2 border-dashed border-indigo-200 bg-indigo-50/30 text-indigo-600 rounded-xl hover:bg-indigo-50 hover:border-indigo-300 transition flex items-center justify-center font-bold text-sm gap-2">\n                      <i class="fas fa-plus-circle"></i> Agregar Campo Principal\n                  </button>\n\n              </div>\n          </form>\n      </div>\n    `}(!!e,e,this.fieldControllers.map(e=>e.render()).join(""))}setupListeners(e){this.setupMainListeners(e);const t=e.querySelector("#fieldsContainer");t&&this.fieldControllers.forEach(e=>e.postRender(t)),this.initSortable(t),this.updateNoFieldsMessage(e)}setupMainListeners(e){const t=e.querySelector("#templateCategory"),n=e.querySelector("#templateIcon");t&&n&&t.addEventListener("change",e=>{n.value=X(e.target.value)}),e.querySelector("#addFieldBtn")?.addEventListener("click",()=>{this.addField(e)});const s=e.querySelector("#templateForm");s&&s.addEventListener("submit",e=>{e.preventDefault(),this.saveData()}),e.querySelector("#saveTemplateBtnHeader")?.addEventListener("click",()=>{s&&s.dispatchEvent(new Event("submit"))}),e.querySelector("#cancelTemplate")?.addEventListener("click",()=>{this.handlers.onCancel()})}createController(e,t){const n={onRemove:e=>this.removeField(e),onTypeChange:(e,t)=>this.handleTypeChange(e,t),onChange:()=>{}};return re.createController(e,t,n)}addField(e){const t=e.querySelector("#fieldsContainer");if(!t)return;const n=this.fieldControllers.length,s={id:J(`campo_${n+1}`,n),label:"",type:"string",required:!1},a=this.createController(s,n);this.fieldControllers.push(a);const r=document.createElement("div");r.innerHTML=a.render();const i=r.firstElementChild;t.appendChild(i),a.postRender(t),i.scrollIntoView({behavior:"smooth",block:"center"}),this.updateNoFieldsMessage(e)}removeField(e){e.domElement&&e.domElement.remove(),this.fieldControllers=this.fieldControllers.filter(t=>t!==e),this.updateNoFieldsMessage(document)}handleTypeChange(e,t){const n=document.getElementById("fieldsContainer");if(!n)return;const s=e.getDefinition();s.type=t,"select"!==t&&delete s.options,"table"!==t&&delete s.columns;const a=this.createController(s,e.index),r=document.createElement("div");r.innerHTML=a.render();const i=r.firstElementChild;e.domElement.replaceWith(i),a.postRender(n);const o=this.fieldControllers.indexOf(e);-1!==o&&(this.fieldControllers[o]=a)}initSortable(e){e&&window.Sortable&&(this.sortable&&this.sortable.destroy(),this.sortable=new window.Sortable(e,{animation:200,handle:".drag-handle",ghostClass:"opacity-50",onEnd:e=>{this.reorderControllers()}}))}reorderControllers(){const e=document.getElementById("fieldsContainer");if(!e)return;const t=Array.from(e.children).map(e=>e.dataset.id);this.fieldControllers.sort((e,n)=>t.indexOf(e.data.id)-t.indexOf(n.data.id))}updateNoFieldsMessage(e){const t=e.querySelector("#fieldsContainer"),n=e.querySelector("#noFieldsMessage");t&&n&&n.classList.toggle("hidden",t.children.length>0)}saveData(){try{const e=document.getElementById("templateName"),t=e?e.value.trim():"";if(!t)throw new Error("Por favor, asigna un nombre a la plantilla.");const n=this.fieldControllers.map((e,t)=>{const n=e.getDefinition();return n.order=t+1,n});if(0===n.length)throw new Error("Agrega al menos un campo para guardar la plantilla.");if(n.filter(e=>!e.label.trim()&&"separator"!==e.type).length>0)throw new Error("Hay campos sin etiqueta. Por favor, n√≥mbralos.");const s={name:t,category:document.getElementById("templateCategory").value,icon:document.getElementById("templateIcon").value,color:document.getElementById("templateColor").value,description:document.getElementById("templateDescription").value,fields:n};this.handlers.onSave(s)}catch(e){alert(e.message)}}}class oe{constructor(e){this.onTemplateSelect=e,this.currentView="list",this.editingTemplateId=null,this.listComponent=new Y({onNew:()=>this.setView("create"),onImport:e=>this.handleImport(e),onSelect:e=>this.onTemplateSelect(e),onEdit:e=>this.setView("edit",e),onDelete:e=>this.handleDelete(e),onExport:e=>this.handleExport(e),onFilter:e=>this.loadTemplates(e)}),this.formComponent=new ie({onSave:e=>this.handleSave(e),onCancel:()=>this.setView("list")})}render(){return'<div id="templateContent" class="min-h-[500px] w-full animate-fade-in"></div>'}async setView(e,t=null){this.currentView=e,this.editingTemplateId=t;const n=document.getElementById("templateContent");if(n)if("list"!==e||n.querySelector(".template-card")||this.renderLoading(n),"list"===e)await this.loadTemplates();else{let e=null;t&&(n.innerHTML='<div class="flex justify-center p-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div></div>',e=await V.getTemplateById(t)),n.innerHTML=this.formComponent.render(e),this.formComponent.setupListeners(n)}}async loadTemplates(e="all"){const t=document.getElementById("templateContent");if(t){"list"!==this.currentView&&this.renderLoading(t);try{const n=await V.getUserTemplates(),s=n.reduce((e,t)=>{const n=t.settings?.category||"custom";return e[n]=(e[n]||0)+1,e},{}),a=Object.keys(s).sort((e,t)=>"custom"===e?-1:"custom"===t?1:e.localeCompare(t)).map(e=>({id:e,count:s[e]}));let r=n;"all"!==e&&(r=n.filter(t=>(t.settings?.category||"custom")===e)),t.innerHTML=this.listComponent.render(r,a,e),this.listComponent.setupListeners(t)}catch(n){this.renderError(t,n.message)}}}renderLoading(e){e.innerHTML='\n        <div class="flex flex-col items-center justify-center h-96">\n            <div class="relative">\n                <div class="w-16 h-16 rounded-full border-4 border-indigo-50 border-t-primary animate-spin"></div>\n                <div class="absolute inset-0 flex items-center justify-center">\n                    <i class="fas fa-layer-group text-indigo-300 text-xs"></i>\n                </div>\n            </div>\n            <p class="text-slate-500 font-medium mt-4 animate-pulse">Cargando cat√°logo...</p>\n        </div>'}renderError(e,t){e.innerHTML=`\n        <div class="max-w-md mx-auto mt-10 p-6 bg-red-50 border border-red-100 rounded-2xl text-center">\n            <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center mx-auto mb-3 shadow-sm text-red-500">\n                <i class="fas fa-wifi-slash"></i>\n            </div>\n            <h3 class="text-red-800 font-bold">Error de Conexi√≥n</h3>\n            <p class="text-red-600 text-sm mt-1">${t}</p>\n            <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-white border border-red-200 text-red-600 rounded-lg hover:bg-red-50 text-sm font-bold transition">Reintentar</button>\n        </div>`}async handleSave(e){try{"edit"===this.currentView&&this.editingTemplateId?await V.updateTemplate(this.editingTemplateId,e):await V.createTemplate(e),this.setView("list")}catch(t){alert("Error: "+t.message)}}async handleDelete(e){try{const t=(await G.getDocumentsByTemplateId(e)).length;if(t>0){const n=`‚ö†Ô∏è ¬°ADVERTENCIA DE SEGURIDAD!\n\nEsta plantilla tiene ${t} documento(s) asociado(s).\n\nSi contin√∫as, TODOS los documentos creados con esta plantilla ser√°n ELIMINADOS PERMANENTEMENTE para mantener la integridad del sistema.\n\nEsta acci√≥n NO se puede deshacer.\n\n¬øEst√°s absolutamente seguro de borrar la plantilla y sus documentos?`;if(!confirm(n))return;await G.deletesByTemplateId(e)}else if(!confirm("¬øEst√°s seguro de eliminar esta plantilla?"))return;await V.deleteTemplate(e),this.loadTemplates()}catch(t){alert("Error durante la eliminaci√≥n: "+t.message)}}async handleExport(e){try{const t=await V.exportTemplate(e),n=`${(t.name||"plantilla").replace(/[^a-z0-9]/gi,"_").toLowerCase()}.json`,s=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),a=URL.createObjectURL(s),r=document.createElement("a");r.href=a,r.download=n,document.body.appendChild(r),r.click(),document.body.removeChild(r)}catch(t){alert("Error exportando: "+t.message)}}async handleImport(e){if(!e)return;const t=new FileReader;t.onload=async e=>{try{const t=JSON.parse(e.target.result);await V.importTemplate(t),this.loadTemplates()}catch(t){alert("El archivo no es v√°lido.")}},t.readAsText(e)}}const le=new class{constructor(){this.types={}}register(e,t){this.types[e]=t}createController(e,t,n){const s=this.types[e.type]||this.types.string;if(!s)throw new Error(`No hay controlador registrado para el tipo: ${e.type}`);return new s(e,t,n)}};class de{constructor(e,t={}){this.fieldsDef=e,this.formData={...t},this.controllers={},this.activeTabId="group-principal"}groupFields(){const e=[];let t={id:"group-principal",label:"Principal",icon:"fas fa-info-circle",fields:[]};return this.fieldsDef.forEach(n=>{"separator"===n.type?(t.fields.length>0&&e.push(t),t={id:`group-${n.id}`,label:n.label,icon:"fas fa-folder-open",fields:[],isSeparator:!0}):t.fields.push(n)}),t.fields.length>0&&e.push(t),e}renderHtml(){if(!this.fieldsDef||!Array.isArray(this.fieldsDef))return"";const e=this.groupFields();return 1===e.length?this.renderFieldsFlat(e[0].fields):`\n      <div class="col-span-full form-layout-container">\n          \n          <div class="hidden md:flex items-center gap-1 border-b border-slate-200 mb-6 overflow-x-auto no-scrollbar">\n              ${e.map((e,t)=>`\n                    <button type="button" \n                            class="tab-trigger px-5 py-3 text-sm font-bold border-b-2 transition-all whitespace-nowrap flex items-center gap-2 rounded-t-lg ${0===t?"border-indigo-500 text-indigo-600 bg-indigo-50/50":"border-transparent text-slate-500 hover:text-slate-700 hover:bg-slate-50"}"\n                            data-target="${e.id}">\n                        <i class="${e.icon} text-xs opacity-70"></i>\n                        ${e.label}\n                        ${this.hasErrorInGroup(e)?'<span class="w-2 h-2 rounded-full bg-red-500 ml-1"></span>':""}\n                    </button>\n                  `).join("")}\n          </div>\n\n          <div class="space-y-4 md:space-y-0">\n              ${e.map((e,t)=>{const n=0===t;return`\n                    <div class="group-container ${n?"":"md:hidden"}" id="${e.id}" data-group-index="${t}">\n                        \n                        <button type="button" \n                                class="accordion-trigger md:hidden w-full flex items-center justify-between p-4 bg-white border border-slate-200 rounded-xl shadow-sm mb-3 transition-all ${n?"ring-2 ring-indigo-500/20 border-indigo-200":""}">\n                            <div class="flex items-center gap-3 font-bold text-slate-700">\n                                <i class="${e.icon} text-indigo-500"></i>\n                                ${e.label}\n                            </div>\n                            <i class="fas fa-chevron-down transition-transform ${n?"rotate-180":""}"></i>\n                        </button>\n\n                        <div class="group-content transition-all duration-300 ${n?"max-h-[5000px] opacity-100":"max-h-0 opacity-0 md:max-h-none md:opacity-100 overflow-hidden"}">\n                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-1 md:p-2">\n                                ${this.renderFieldsFlat(e.fields)}\n                             </div>\n                        </div>\n                    </div>\n                  `}).join("")}\n          </div>\n      </div>\n    `}renderFieldsFlat(e){return e.map(e=>{const t=le.createController(e,this.formData[e.id],(e,t)=>this.handleFieldChange(e,t));return this.controllers[e.id]=t,t.render()}).join("")}hasErrorInGroup(e){return!1}postRender(e){Object.values(this.controllers).forEach(t=>{t.postRender&&t.postRender(e)});const t=e.querySelectorAll(".tab-trigger"),n=e.querySelectorAll(".group-container");t.forEach(e=>{e.addEventListener("click",()=>{const s=e.dataset.target;t.forEach(e=>{e.classList.remove("border-indigo-500","text-indigo-600","bg-indigo-50/50"),e.classList.add("border-transparent","text-slate-500")}),e.classList.remove("border-transparent","text-slate-500"),e.classList.add("border-indigo-500","text-indigo-600","bg-indigo-50/50"),n.forEach(e=>{e.id===s?e.classList.remove("md:hidden"):e.classList.add("md:hidden")})})});e.querySelectorAll(".accordion-trigger").forEach(e=>{e.addEventListener("click",()=>{const t=e.closest(".group-container").querySelector(".group-content"),n=e.querySelector(".fa-chevron-down");t.classList.contains("max-h-0")?(t.classList.remove("max-h-0","opacity-0","overflow-hidden"),t.classList.add("max-h-[5000px]","opacity-100"),n.classList.add("rotate-180"),e.classList.add("ring-2","ring-indigo-500/20","border-indigo-200")):(t.classList.add("max-h-0","opacity-0","overflow-hidden"),t.classList.remove("max-h-[5000px]","opacity-100"),n.classList.remove("rotate-180"),e.classList.remove("ring-2","ring-indigo-500/20","border-indigo-200"))})})}handleFieldChange(e,t){this.formData[e]=t}getValidData(){let e=!0;const t={};let n=null;return Object.values(this.controllers).forEach(s=>{const a=s.validate();!0!==a&&(e=!1,s.showError(a),n||(n=s)),t[s.def.id]=s.getValue()}),!e&&n&&this.focusOnField(n),e?t:null}focusOnField(e){if(!e.domElement)return;const t=e.domElement.closest(".group-container");if(t){const n=t.id,s=document.querySelector(`.tab-trigger[data-target="${n}"]`);s&&s.click();const a=t.querySelector(".accordion-trigger");if(a){t.querySelector(".group-content").classList.contains("max-h-0")&&a.click()}setTimeout(()=>{e.domElement.scrollIntoView({behavior:"smooth",block:"center"})},300)}}}class ce{constructor(e,t,n){this.def=e,this.value=t,this.onChange=n||(()=>{}),this.domElement=null}render(){const e=this.def.required?'<span class="text-red-500 ml-1">*</span>':"",t=this.def.description?`<p class="mt-1 text-xs text-slate-400">${this.def.description}</p>`:"";return`\n      <div class="field-wrapper mb-4 ${["text","table","url"].includes(this.def.type)?"md:col-span-2 print:col-span-2":"md:col-span-1 print:col-span-1"}" data-field-id="${this.def.id}">\n        <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">\n          ${this.def.label} ${e}\n        </label>\n        ${this.renderInput()} \n        ${t}\n        <div class="error-msg text-red-500 text-xs mt-1 hidden"></div>\n      </div>\n    `}renderInput(){return""}postRender(e){const t=e.querySelector(`[name="${this.def.id}"]`);t&&(this.domElement=t,this.attachListeners(t))}attachListeners(e){e.addEventListener("input",e=>{this.value=e.target.value,this.onChange(this.def.id,this.value)})}getValue(){return this.value}validate(){return!this.def.required||null!==this.value&&""!==this.value&&void 0!==this.value||"Este campo es requerido."}showError(e){const t=document.querySelector(`div[data-field-id="${this.def.id}"]`),n=t?.querySelector(".error-msg");n&&(n.textContent=e,n.classList.remove("hidden"))}}class ue extends ce{renderInput(){const e="text"===this.def.type,t="email"===this.def.type?"email":"text",n="w-full bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all px-4 py-3 text-slate-700 font-medium placeholder-slate-300";return e?`\n        <textarea \n          name="${this.def.id}" \n          class="${n} min-h-[100px] resize-y" \n          rows="4" \n          placeholder="${this.def.placeholder||"Escribir..."}"\n        >${this.value||""}</textarea>`:`\n      <input \n        type="${t}" \n        name="${this.def.id}" \n        class="${n}" \n        value="${this.value||""}" \n        placeholder="${this.def.placeholder||"Escribir..."}"\n      >`}}class pe extends ce{renderInput(){const e="currency"===this.def.type,t=e?"pl-10":"pl-4";return`\n      <div class="relative">\n        ${e?'<i class="fas fa-dollar-sign absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>':""}\n        <input \n          type="text" \n          name="${this.def.id}" \n          class="w-full bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all ${t} pr-4 py-3 font-mono text-right text-slate-700 font-bold placeholder-slate-300"\n          value="${null!==this.value&&void 0!==this.value?this.value:""}" \n          placeholder="0.00"\n        >\n      </div>`}postRender(e){super.postRender(e),this.domElement&&(this.domElement.addEventListener("blur",()=>this.evaluateMath()),this.domElement.addEventListener("keydown",e=>{"Enter"!==e.key&&"="!==e.key||(e.preventDefault(),this.evaluateMath())}))}evaluateMath(){const e=this.domElement,t=e.value.trim();if(t&&/^[\d\s\.\+\-\*\/\(\)]+$/.test(t)&&/[\+\-\*\/]/.test(t))try{const n=new Function('"use strict";return ('+t+")")();if(isFinite(n)){const t=Math.round(100*n)/100;e.value=t,this.value=t,this.onChange(this.def.id,t),this.showSuccessFeedback(e)}}catch(n){}}showSuccessFeedback(e){e.style.borderColor,e.classList.add("text-emerald-600","bg-emerald-50"),setTimeout(()=>{e.classList.remove("text-emerald-600","bg-emerald-50")},800)}getValue(){return""===this.value||null===this.value?null:Number(this.value)}}class me extends ce{renderInput(){const e=!!this.value;return`\n      <div class="flex items-center h-full py-2">\n        <label class="relative inline-flex items-center cursor-pointer">\n          <input type="checkbox" name="${this.def.id}" class="sr-only peer" ${e?"checked":""}>\n          <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>\n          <span class="ml-3 text-sm font-medium text-slate-600 select-none">\n            ${e?"S√≠, activado":"No"}\n          </span>\n        </label>\n      </div>`}attachListeners(e){e.addEventListener("change",t=>{this.value=t.target.checked,this.onChange(this.def.id,this.value);const n=e.parentElement.querySelector("span");n&&(n.textContent=this.value?"S√≠, activado":"No")})}}class he extends ce{renderInput(){const e=(this.def.options||[]).map(e=>`<option value="${e}" ${this.value===e?"selected":""}>${e}</option>`).join("");return`\n      <div class="relative">\n        <select \n          name="${this.def.id}" \n          class="w-full bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all px-4 py-3 appearance-none text-slate-700 font-medium cursor-pointer"\n        >\n          <option value="">-- Seleccionar --</option>\n          ${e}\n        </select>\n        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-500">\n          <i class="fas fa-chevron-down text-xs"></i>\n        </div>\n      </div>`}}class be extends ce{renderInput(){return`\n      <div class="relative">\n        <input \n          type="date" \n          name="${this.def.id}" \n          class="w-full bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all px-4 py-3 text-slate-700 font-medium"\n          value="${this.value||""}"\n        >\n      </div>`}}class fe extends ce{renderInput(){return`\n      <div class="relative group">\n        <input \n          type="password" \n          name="${this.def.id}" \n          class="w-full bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-secondary/50 focus:border-secondary transition-all px-4 py-3 text-slate-700 font-bold tracking-wider placeholder-slate-300 pr-12"\n          value="${this.value||""}" \n          placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"\n        >\n        <button type="button" class="toggle-pass absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-secondary p-2 transition-colors focus:outline-none">\n          <i class="fas fa-eye"></i>\n        </button>\n      </div>`}postRender(e){super.postRender(e);const t=e.querySelector(`[data-field-id="${this.def.id}"]`);if(!t)return;const n=t.querySelector(".toggle-pass"),s=this.domElement;n&&s&&(n.onclick=e=>{e.preventDefault();const t="password"===s.type;s.type=t?"text":"password",n.innerHTML=`<i class="fas fa-eye${t?"-slash":""}"></i>`,n.classList.toggle("text-secondary",t)})}}class ge extends ce{constructor(e,t,n){super(e,Array.isArray(t)?t:[],n),this.columns=this.def.columns||[],this.wrapperId=`table-wrapper-${this.def.id}`,this.tbodyId=`tbody-${this.def.id}`,this.fileInputId=`csv-input-${this.def.id}`}renderInput(){const e=this.columns.map(e=>`<th class="px-4 py-2 text-left text-xs font-bold text-slate-500 uppercase tracking-wider hidden md:table-cell border-b border-slate-200">${e.label}</th>`).join("");return`\n      <div id="${this.wrapperId}" class="table-field-container border border-slate-200 rounded-xl overflow-hidden bg-white shadow-sm transition-all hover:shadow-md">\n        \n        <div class="flex items-center justify-between px-4 py-2 bg-slate-50 border-b border-slate-200">\n            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">\n                <i class="fas fa-table mr-1"></i> Datos\n            </span>\n            <div class="flex items-center gap-2">\n                <button type="button" class="btn-export-csv text-slate-500 hover:text-indigo-600 hover:bg-white px-2 py-1 rounded-md transition-colors text-xs font-bold border border-transparent hover:border-slate-200 flex items-center gap-1" title="Descargar CSV">\n                    <i class="fas fa-download"></i> <span class="hidden sm:inline">Exportar</span>\n                </button>\n                <label class="btn-import-csv cursor-pointer text-slate-500 hover:text-emerald-600 hover:bg-white px-2 py-1 rounded-md transition-colors text-xs font-bold border border-transparent hover:border-slate-200 flex items-center gap-1" title="Cargar CSV">\n                    <input type="file" id="${this.fileInputId}" class="hidden" accept=".csv">\n                    <i class="fas fa-upload"></i> <span class="hidden sm:inline">Importar</span>\n                </label>\n            </div>\n        </div>\n\n        <div class="overflow-x-auto max-h-[400px] custom-scrollbar">\n          <table class="w-full text-left border-collapse">\n            <thead class="bg-slate-50 hidden md:table-header-group sticky top-0 z-10 shadow-sm">\n              <tr>\n                ${e}\n                <th class="w-20 px-4 py-2 text-center text-xs font-bold text-slate-500 uppercase hidden md:table-cell bg-slate-50 border-b border-slate-200">Acciones</th>\n              </tr>\n            </thead>\n\n            <tbody class="block md:table-row-group p-4 md:p-0 space-y-4 md:space-y-0 divide-y divide-slate-200 md:divide-slate-100" id="${this.tbodyId}">\n              ${this.renderRows()}\n            </tbody>\n          </table>\n        </div>\n        \n        <button type="button" class="add-row-btn w-full py-3 bg-slate-50 hover:bg-indigo-50 text-slate-500 hover:text-indigo-600 font-bold text-xs uppercase tracking-wider transition-colors border-t border-slate-200 flex items-center justify-center gap-2 group">\n           <i class="fas fa-plus-circle group-hover:scale-110 transition-transform"></i> Agregar Registro\n        </button>\n      </div>\n    `}renderRows(){return 0===this.value.length?`<tr><td colspan="${this.columns.length+1}" class="block md:table-cell p-8 text-center text-xs text-slate-400 italic bg-white">\n        <div class="flex flex-col items-center gap-2">\n            <i class="fas fa-inbox text-2xl opacity-20"></i>\n            <span>Sin registros. Agrega uno manualmente o importa un CSV.</span>\n        </div>\n      </td></tr>`:this.value.map((e,t)=>`\n        <tr class="block md:table-row bg-white md:hover:bg-slate-50 transition-colors group rounded-xl shadow-sm md:shadow-none border border-slate-200 md:border-none mb-4 md:mb-0">\n          ${this.columns.map(t=>`\n            <td class="block md:table-cell px-4 py-2 md:py-3 align-top text-sm border-b md:border-none border-slate-100 last:border-0">\n                <span class="md:hidden block text-[10px] font-bold text-slate-400 uppercase mb-1">${t.label}</span>\n                <div class="text-slate-700 font-medium break-words">${function(e,t){if(null==t||""===t)return'<span class="text-slate-300 italic text-xs">--</span>';if("url"===e.type){const e=t?.url||("string"==typeof t?t:"")||"";return`<div class="flex items-center gap-1.5 overflow-hidden">\n                  <i class="fas fa-link text-[10px] text-indigo-400 flex-shrink-0"></i>\n                  <span class="truncate text-xs text-slate-600 font-medium" title="${e}">${t?.text||e}</span>\n                </div>`}if("boolean"===e.type)return t?'<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold bg-emerald-100 text-emerald-700"><i class="fas fa-check mr-1"></i> S√≠</span>':'<span class="text-slate-400 text-xs">No</span>';if("secret"===e.type)return'<span class="text-slate-400 text-xs tracking-widest">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>';if(["currency","percentage"].includes(e.type))return`<span class="font-mono text-xs text-slate-700 font-bold">${t}${"percentage"===e.type?"%":""}</span>`;if("text"===e.type){const e="string"==typeof t&&t.length>30?t.substring(0,30)+"...":t;return`<span class="text-xs text-slate-600 truncate block" title="${t}"><i class="fas fa-paragraph text-slate-300 mr-1"></i>${e}</span>`}return`<span class="text-xs text-slate-600 truncate block" title="${t}">${t}</span>`}(t,e[t.id])}</div>\n            </td>`).join("")}\n          ${`\n          <td class="block md:table-cell px-4 py-3 md:py-3 text-right md:text-center align-middle whitespace-nowrap bg-slate-50 md:bg-transparent rounded-b-xl md:rounded-none border-t md:border-none border-slate-100">\n             <div class="flex items-center justify-end md:justify-center gap-2">\n                 <button type="button" class="edit-btn w-8 h-8 rounded-lg text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 transition-colors" data-index="${t}" title="Editar">\n                    <i class="fas fa-pencil-alt text-xs"></i>\n                 </button>\n                 <button type="button" class="remove-btn w-8 h-8 rounded-lg text-slate-400 hover:text-red-600 hover:bg-red-50 transition-colors" data-index="${t}" title="Eliminar">\n                    <i class="fas fa-trash-alt text-xs"></i>\n                 </button>\n             </div>\n          </td>`}\n        </tr>`).join("")}postRender(e){super.postRender(e);const t=e.querySelector(`#${this.wrapperId}`);if(!t)return;this.tbody=t.querySelector(`#${this.tbodyId}`),t.querySelector(".add-row-btn")?.addEventListener("click",e=>{e.stopPropagation(),this.openRowEditor(null)}),t.querySelector(".btn-export-csv")?.addEventListener("click",()=>this.exportCSV());const n=t.querySelector(`#${this.fileInputId}`);n?.addEventListener("change",e=>{e.target.files.length>0&&(this.importCSV(e.target.files[0]),e.target.value="")}),t.addEventListener("click",e=>{const n=e.target.closest(".edit-btn"),s=e.target.closest(".remove-btn");(t.contains(n)||t.contains(s))&&(n&&(e.stopPropagation(),this.openRowEditor(parseInt(n.dataset.index))),s&&(e.stopPropagation(),confirm("¬øEst√°s seguro de eliminar este registro?")&&this.removeRow(parseInt(s.dataset.index))))})}exportCSV(){if(0===this.value.length)return void alert("No hay datos para exportar.");const e=[],t=[];this.columns.forEach(n=>{"url"===n.type?(e.push(`"${n.label} (URL)"`),e.push(`"${n.label} (Texto)"`),t.push({id:n.id,type:"url",prop:"url"}),t.push({id:n.id,type:"url",prop:"text"})):(e.push(`"${n.label.replace(/"/g,'""')}"`),t.push({id:n.id,type:"simple"}))});const n=this.value.map(e=>t.map(t=>{const n=e[t.id];if("url"===t.type){if(!n)return'""';const e=("object"==typeof n?n:{url:n,text:n})[t.prop]||"";return`"${String(e).replace(/"/g,'""')}"`}{let e=n;return null==e&&(e=""),"object"==typeof e&&(e=JSON.stringify(e)),`"${String(e).replace(/"/g,'""')}"`}}).join(",")).join("\n"),s=`${e.join(",")}\n${n}`,a=new Blob([s],{type:"text/csv;charset=utf-8;"}),r=URL.createObjectURL(a),i=document.createElement("a");i.setAttribute("href",r),i.setAttribute("download",`tabla_${this.def.label.replace(/\s+/g,"_").toLowerCase()}.csv`),document.body.appendChild(i),i.click(),document.body.removeChild(i)}importCSV(e){const t=new FileReader;t.onload=e=>{try{const t=e.target.result.split(/\r?\n/).filter(e=>""!==e.trim());if(t.length<2)throw new Error("El archivo CSV parece estar vac√≠o.");const n=this.parseCSVLine(t[0]),s={};if(this.columns.forEach(e=>{if("url"===e.type){const t=`${e.label} (URL)`.toLowerCase(),a=`${e.label} (Texto)`.toLowerCase(),r=e.label.toLowerCase(),i=n.findIndex(e=>e.toLowerCase().trim()===t),o=n.findIndex(e=>e.toLowerCase().trim()===a),l=n.findIndex(e=>e.toLowerCase().trim()===r);-1===i&&-1===l||(s[e.id]={type:"url",urlIdx:-1!==i?i:l,textIdx:o})}else{const t=n.findIndex(t=>t.toLowerCase().trim()===e.label.toLowerCase());-1!==t&&(s[e.id]={type:"simple",idx:t})}}),0===Object.keys(s).length){let e=0;this.columns.forEach(t=>{"url"===t.type?(s[t.id]={type:"url",urlIdx:e,textIdx:e+1},e+=2):(s[t.id]={type:"simple",idx:e},e+=1)})}const a=[];for(let e=1;e<t.length;e++){const n=this.parseCSVLine(t[e]),r={};let i=!1;Object.keys(s).forEach(e=>{const t=s[e];if("url"===t.type){const s=n[t.urlIdx]||"",a=-1!==t.textIdx?n[t.textIdx]:"";s&&(r[e]={url:s,text:a||s},i=!0)}else{const s=n[t.idx];void 0!==s&&(r[e]=s,i=!0)}}),i&&a.push(r)}a.length>0?(this.value=[...this.value,...a],this.updateAndRender(),alert(`‚úÖ Se importaron ${a.length} registros.`)):alert("No se pudieron extraer datos v√°lidos.")}catch(t){alert("Error al importar: "+t.message)}},t.readAsText(e)}parseCSVLine(e){const t=/(?!\s*$)\s*(?:'([^']*)'|"([^"]*)"|([^,'"\s\\]*(?:\s+[^,'"\s\\]+)*))\s*(?:,|$)/g,n=[];let s;for(;null!==(s=t.exec(e));){let e=s[2]||s[1]||s[3]||"";e=e.replace(/""/g,'"'),n.push(e)}return n}removeRow(e){this.value.splice(e,1),this.updateAndRender()}updateAndRender(){this.onChange(this.def.id,this.value),this.tbody&&(this.tbody.innerHTML=this.renderRows())}openRowEditor(e){const t=null!==e,n=t?this.value[e]:{},s=new de(this.columns,n),a=`modal-${this.def.id}-${Date.now()}`,r=`\n      <div id="${a}" class="fixed inset-0 z-[100] flex items-center justify-center p-4" style="z-index: 1000;">\n        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity modal-backdrop"></div>\n        <div class="relative w-full max-w-lg bg-white rounded-2xl shadow-2xl flex flex-col max-h-[90vh] animate-fade-in-up overflow-hidden">\n          <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">\n            <h3 class="font-bold text-lg text-slate-800">${t?"Editar Registro":"Nuevo Registro"}</h3>\n            <button type="button" class="modal-close text-slate-400 hover:text-slate-600 transition"><i class="fas fa-times"></i></button>\n          </div>\n          <div class="p-6 overflow-y-auto custom-scrollbar">\n            <div id="modal-form-body-${a}" class="space-y-4">\n                ${s.renderHtml()}\n            </div>\n          </div>\n          <div class="px-6 py-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">\n             <button type="button" class="modal-cancel px-4 py-2 text-slate-600 font-bold hover:bg-white rounded-lg transition text-sm">Cancelar</button>\n             <button type="button" class="modal-save px-6 py-2 bg-indigo-600 text-white font-bold rounded-lg shadow hover:bg-indigo-700 transition text-sm">Guardar</button>\n          </div>\n        </div>\n      </div>\n    `;document.body.insertAdjacentHTML("beforeend",r);const i=document.getElementById(a),o=document.getElementById(`modal-form-body-${a}`);s.postRender(o);const l=()=>i.remove();i.querySelector(".modal-backdrop").onclick=l,i.querySelector(".modal-close").onclick=l,i.querySelector(".modal-cancel").onclick=l,i.querySelector(".modal-save").onclick=()=>{const n=s.getValidData();n&&(t?this.value[e]=n:this.value.push(n),this.updateAndRender(),l())}}}class xe extends ce{constructor(e,t,n){let s=t;"string"==typeof s&&(s={url:s,text:""}),s||(s={url:"",text:""}),super(e,s,n)}renderInput(){const e="w-full bg-slate-50 border border-slate-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all text-sm px-3 py-2";return`\n      <div class="url-field-group space-y-2 p-3 border border-slate-100 rounded-xl bg-slate-50/50">\n          \n          <div class="relative">\n              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">\n                  <i class="fas fa-link text-xs"></i>\n              </div>\n              <input \n                  type="text" \n                  class="url-input ${e} pl-8 text-blue-600 font-mono placeholder-slate-400" \n                  placeholder="https://ejemplo.com"\n                  value="${this.value.url||""}"\n              >\n          </div>\n\n          <div class="relative">\n              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">\n                  <i class="fas fa-font text-xs"></i>\n              </div>\n              <input \n                  type="text" \n                  class="text-input ${e} pl-8 text-slate-700 placeholder-slate-400 font-medium" \n                  placeholder="Texto del enlace (Opcional)"\n                  value="${this.value.text||""}"\n              >\n          </div>\n          \n      </div>\n    `}postRender(e){const t=e.querySelector(`div[data-field-id="${this.def.id}"]`);if(!t)return;const n=t.querySelector(".url-input"),s=t.querySelector(".text-input"),a=()=>{this.value={url:n.value.trim(),text:s.value.trim()},this.onChange(this.def.id,this.value)};n&&n.addEventListener("input",a),s&&s.addEventListener("input",a)}getValue(){return this.value}}class ve extends ce{constructor(e,t,n){super(e,null,n)}render(){return`\n      <div class="col-span-1 md:col-span-2 mt-8 mb-4 border-b border-slate-200 pb-2 flex items-center gap-3 select-none">\n          <div class="w-1.5 h-6 bg-slate-400 rounded-full"></div>\n          <h3 class="text-lg font-bold text-slate-700 tracking-tight uppercase">\n            ${this.def.label}\n          </h3>\n      </div>\n    `}getValue(){return null}validate(){return!0}renderInput(){return""}}class ye{constructor(e,t,n){this.initialData=e,this.onSaveSuccess=t,this.onCancel=n,this.isEditing=!!e.documentId,this.documentId=e.documentId||null,this.template=e.template||null,this.initialFormData=e.formData||{},this.documentMetadata=e.metadata||{},this.isSubmitting=!1,this.formManager=null,le.register("string",ue),le.register("text",ue),le.register("email",ue),le.register("number",pe),le.register("currency",pe),le.register("percentage",pe),le.register("boolean",me),le.register("select",he),le.register("date",be),le.register("secret",fe),le.register("table",ge),le.register("url",xe),le.register("separator",ve),this.isEditing&&!this.template&&this.checkSecurityAndLoad()}checkSecurityAndLoad(){j.isReady()?this.loadExistingDocument():window.app&&window.app.requireEncryption?window.app.requireEncryption(()=>this.loadExistingDocument()):this.renderError("Seguridad no inicializada. Recarga la p√°gina.")}async loadExistingDocument(){const e=document.getElementById("editorContainer");e&&(e.innerHTML='\n        <div class="flex flex-col items-center justify-center py-20">\n            <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-brand-600 mb-4"></div>\n            <p class="text-slate-500 font-medium">Descifrando informaci√≥n segura...</p>\n        </div>');try{const e=await G.getById(this.documentId);this.template=e.template,this.initialFormData=e.data,this.documentMetadata={title:e.title,tags:e.tags||[]},this.render(),this.setupEventListeners()}catch(t){this.renderError("No se pudo acceder al documento cifrado.")}}render(){const e=document.getElementById("editorContainer");if(!e||!this.template)return;this.formManager=new de(this.template.fields,this.initialFormData);const t=this.documentMetadata.title||"",n=this.template.color||"#3b82f6",s=this.template.icon||"üìÑ",a=`\n      <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-card border border-slate-200 overflow-hidden animate-slide-up relative flex flex-col min-h-[600px]">\n        \n        <div class="px-6 py-4 bg-white border-b border-slate-100 flex flex-col sm:flex-row justify-between items-center sticky top-0 z-30 gap-4 shadow-sm">\n          \n          <div class="flex items-center gap-4 w-full sm:w-auto flex-1">\n            <div class="w-12 h-12 rounded-lg flex items-center justify-center shadow-sm border border-slate-100 flex-shrink-0"\n                 style="background-color: ${n}10; color: ${n}">\n              ${s.includes("fa-")||s.includes("fa ")?`<i class="${s} text-2xl"></i>`:`<span class="text-2xl">${s}</span>`}\n            </div>\n            \n            <div class="flex-1 min-w-0">\n              <div class="flex items-center gap-2 mb-1">\n                 <span class="text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded bg-slate-100 text-slate-500 border border-slate-200">\n                    ${this.template.name}\n                 </span>\n                 ${this.isEditing?'<span class="flex items-center gap-1 text-[10px] text-amber-600 font-bold bg-amber-50 px-2 py-0.5 rounded border border-amber-100"><i class="fas fa-pen"></i> Editando</span>':'<span class="flex items-center gap-1 text-[10px] text-emerald-600 font-bold bg-emerald-50 px-2 py-0.5 rounded border border-emerald-100"><i class="fas fa-star"></i> Nuevo</span>'}\n              </div>\n              \n              <input type="text" id="docTitleInput" \n                  class="w-full bg-transparent border-0 border-b border-transparent hover:border-slate-200 focus:border-brand-500 p-0 text-xl font-bold text-slate-900 placeholder-slate-300 focus:ring-0 transition-all truncate" \n                  value="${t}" \n                  placeholder="T√≠tulo del documento..." \n                  autocomplete="off"\n                  required autofocus>\n            </div>\n          </div>\n\n          <div class="flex gap-3 w-full sm:w-auto justify-end">\n             <button id="cancelEditBtn" class="px-4 py-2 rounded-lg text-slate-600 font-medium hover:bg-slate-50 border border-transparent hover:border-slate-200 transition-all text-sm">\n               Cancelar\n             </button>\n             <button id="saveDocBtn" class="px-5 py-2 rounded-lg bg-brand-600 text-white font-semibold shadow-md hover:bg-brand-700 hover:shadow-lg transition-all flex items-center gap-2 text-sm disabled:opacity-70 disabled:cursor-wait">\n               <i class="fas fa-save"></i> \n               <span>${this.isEditing?"Guardar Cambios":"Guardar"}</span>\n             </button>\n          </div>\n        </div>\n\n        <div class="p-6 sm:p-10 bg-white">\n          <input type="hidden" id="docTagsInput" value="${(this.documentMetadata.tags||[]).join(", ")}">\n          \n          <form id="dynamicForm" class="grid grid-cols-1 gap-8 animate-fade-in">\n             ${this.formManager.renderHtml()}\n          </form>\n        </div>\n        \n        <div class="bg-slate-50 px-6 py-3 border-t border-slate-100 text-center">\n             <p class="text-[10px] text-slate-400 font-mono">\n                <i class="fas fa-lock text-emerald-500 mr-1"></i> Contenido cifrado de extremo a extremo antes de guardar.\n             </p>\n        </div>\n      </div>\n    `;return e&&(e.innerHTML=a),a}setupEventListeners(){const e=document.getElementById("saveDocBtn"),t=document.getElementById("cancelEditBtn");e&&(e.onclick=()=>this.handleSave()),t&&(t.onclick=()=>this.onCancel());const n=document.getElementById("dynamicForm");n&&this.formManager&&this.formManager.postRender(n)}async handleSave(){if(this.isSubmitting)return;const e=document.getElementById("docTitleInput"),t=e.value.trim();if(!t)return e.classList.add("border-red-500","animate-pulse"),e.focus(),void setTimeout(()=>e.classList.remove("border-red-500","animate-pulse"),2e3);const n=this.formManager.getValidData();if(!n)return void alert("Por favor corrige los errores marcados en el formulario.");const s=document.getElementById("docTagsInput");let a=s?s.value.split(",").map(e=>e.trim()).filter(e=>e):[];this.updateEditorState(!0,"Cifrando...");try{const e={title:t,templateId:this.template.id,template:this.template,data:n,tags:a,updatedAt:(new Date).toISOString()};let s=null;s=this.isEditing?await G.update(this.documentId,e):await G.create(e),s&&s.id?this.onSaveSuccess(s.id):this.onSaveSuccess()}catch(r){alert("Error al guardar: "+r.message),this.updateEditorState(!1)}}updateEditorState(e,t=null){this.isSubmitting=e;const n=document.getElementById("saveDocBtn");n&&(e?(n.disabled=!0,n.innerHTML=`<i class="fas fa-circle-notch fa-spin"></i> ${t}`):(n.disabled=!1,n.innerHTML=this.isEditing?'<i class="fas fa-save"></i> Guardar Cambios':'<i class="fas fa-save"></i> Guardar'))}renderError(e){const t=document.getElementById("editorContainer");t&&(t.innerHTML=`\n            <div class="p-8 text-center max-w-lg mx-auto mt-10">\n                <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500">\n                    <i class="fas fa-times"></i>\n                </div>\n                <h3 class="text-lg font-bold text-slate-900 mb-2">Error</h3>\n                <p class="text-slate-500 mb-6">${e}</p>\n                <button onclick="window.location.reload()" class="px-4 py-2 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 transition text-sm font-medium">\n                    Recargar\n                </button>\n            </div>`)}}class we{constructor(e){this.onSuccess=e}show(){if(document.getElementById("vaultSetupModal"))return;document.body.insertAdjacentHTML("beforeend",'\n      <div id="vaultSetupModal" class="fixed inset-0 z-[60] flex items-center justify-center p-4">\n        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity opacity-0" id="vsmBackdrop"></div>\n        \n        <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform scale-95 opacity-0 transition-all duration-300" id="vsmCard">\n          \n          <div class="bg-slate-50 px-8 py-6 border-b border-slate-100 flex flex-col items-center text-center">\n            <div class="w-16 h-16 bg-white border border-slate-200 rounded-2xl flex items-center justify-center shadow-sm mb-4 text-amber-500 text-2xl">\n              <i class="fas fa-key"></i>\n            </div>\n            <h2 class="text-xl font-bold text-slate-900">Configura tu B√≥veda</h2>\n            <p class="text-sm text-slate-500 mt-2 leading-relaxed">\n              Crea una <strong>Llave Maestra</strong> √∫nica. Esta contrase√±a cifrar√° tus documentos y <span class="text-red-500 font-semibold">nosotros no podemos recuperarla</span> si la olvidas.\n            </p>\n          </div>\n\n          <div class="p-8">\n            <form id="vaultSetupForm" class="space-y-5">\n              \n              <div class="space-y-1">\n                <label class="text-xs font-bold text-slate-500 uppercase ml-1">Nueva Llave Maestra</label>\n                <div class="relative">\n                    <input type="password" id="vsPassword" \n                      class="w-full pl-4 pr-10 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:border-brand-500 focus:ring-4 focus:ring-brand-500/10 outline-none transition-all font-mono text-sm text-slate-800"\n                      placeholder="M√≠nimo 8 caracteres" required minlength="8">\n                    <i class="fas fa-lock absolute right-4 top-3.5 text-slate-400 text-sm"></i>\n                </div>\n              </div>\n\n              <div class="space-y-1">\n                <label class="text-xs font-bold text-slate-500 uppercase ml-1">Confirmar Llave</label>\n                <div class="relative">\n                    <input type="password" id="vsConfirm" \n                      class="w-full pl-4 pr-10 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:border-brand-500 focus:ring-4 focus:ring-brand-500/10 outline-none transition-all font-mono text-sm text-slate-800"\n                      placeholder="Repite la contrase√±a" required>\n                    <i class="fas fa-check absolute right-4 top-3.5 text-slate-400 text-sm"></i>\n                </div>\n              </div>\n\n              <div class="pt-2">\n                <button type="submit" id="btnSetupVault" \n                  class="w-full py-3.5 bg-brand-600 hover:bg-brand-700 text-white font-bold rounded-xl shadow-lg shadow-brand-500/20 transition-all transform active:scale-[0.98] flex justify-center items-center gap-2">\n                  <span>Activar Cifrado E2EE</span>\n                  <i class="fas fa-shield-alt"></i>\n                </button>\n              </div>\n\n            </form>\n          </div>\n        </div>\n      </div>\n    '),requestAnimationFrame(()=>{const e=document.getElementById("vsmBackdrop"),t=document.getElementById("vsmCard");e&&t&&(e.classList.remove("opacity-0"),t.classList.remove("scale-95","opacity-0"),t.classList.add("scale-100","opacity-100"))}),this.setupListeners()}setupListeners(){const e=document.getElementById("vaultSetupForm");e?.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("vsPassword").value;if(t!==document.getElementById("vsConfirm").value)return void alert("Las contrase√±as no coinciden.");if(t.length<8)return void alert("La contrase√±a es muy corta (m√≠nimo 8 caracteres).");const n=document.getElementById("btnSetupVault"),s=n.innerHTML;n.disabled=!0,n.innerHTML='<i class="fas fa-circle-notch fa-spin"></i> Configurando...';try{const{authService:e}=await U(async()=>{const{authService:e}=await Promise.resolve().then(()=>A);return{authService:e}},void 0);await e.initializeEncryption(t),await e.markVaultAsConfigured(),this.close(),this.onSuccess()}catch(a){alert("Error configurando b√≥veda: "+a.message),n.disabled=!1,n.innerHTML=s}})}close(){const e=document.getElementById("vaultSetupModal");e&&e.remove()}}class Ee{constructor(e,t){this.onViewDocument=e,this.documents=[],this.activeFilter="all",this.onNewDocument=async()=>{try{if(await M.isVaultConfigured())window.app&&window.app.requireEncryption?window.app.requireEncryption(()=>t()):j.isReady()?t():alert("Por favor recarga la p√°gina para inicializar seguridad.");else{new we(()=>t()).show()}}catch(e){t()}}}async loadDocuments(){const e=document.getElementById("vaultListContainer");if(e){e.innerHTML=`\n      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">\n        ${[1,2,3].map(()=>'\n          <div class="bg-white rounded-xl p-6 border border-slate-200 h-40 animate-pulse flex flex-col justify-between">\n            <div class="flex items-start justify-between">\n               <div class="w-10 h-10 bg-slate-100 rounded-lg"></div>\n               <div class="w-20 h-4 bg-slate-100 rounded"></div>\n            </div>\n            <div class="space-y-3">\n               <div class="h-4 bg-slate-100 rounded w-3/4"></div>\n               <div class="h-3 bg-slate-100 rounded w-1/2"></div>\n            </div>\n          </div>\n        ').join("")}\n      </div>`;try{const[t,n]=await Promise.all([G.listDocuments(),G.getStorageStats()]);this.documents=t,e.innerHTML='\n        <div class="flex flex-col-reverse md:flex-row justify-between items-start md:items-center mb-8 gap-6 animate-fade-in">\n             <div id="vaultFiltersContainer" class="flex flex-wrap items-center gap-2"></div>\n             <div id="vaultStorageWidget" class="w-full md:w-auto"></div>\n        </div>\n        <div id="vaultGridContainer" class="animate-slide-up"></div>\n      ',this.renderStorageWidget(n),this.renderFilters(),this.renderGrid()}catch(t){this.renderErrorState(e)}}}renderStorageWidget(e){const t=document.getElementById("vaultStorageWidget");if(!t)return;const n=Math.min(e.bytes/52428800*100,100).toFixed(1);let s="bg-brand-600",a="text-brand-700";n>75&&(s="bg-amber-500",a="text-amber-700"),n>90&&(s="bg-red-500",a="text-red-700"),t.innerHTML=`\n      <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm flex items-center gap-4 min-w-[260px]">\n          <div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 border border-slate-100">\n              <i class="fas fa-server"></i>\n          </div>\n          <div class="flex-1">\n              <div class="flex justify-between items-end mb-2">\n                  <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Uso de B√≥veda</span>\n                  <span class="text-xs font-bold ${a}">${function(e,t=2){if(!+e)return"0 Bytes";const n=t<0?0:t,s=Math.floor(Math.log(e)/Math.log(1024));return`${parseFloat((e/Math.pow(1024,s)).toFixed(n))} ${["Bytes","KB","MB","GB","TB"][s]}`}(e.bytes)}</span>\n              </div>\n              <div class="w-full bg-slate-100 rounded-full h-1.5 overflow-hidden">\n                  <div class="${s} h-1.5 rounded-full transition-all duration-1000" style="width: ${n}%"></div>\n              </div>\n          </div>\n      </div>\n    `}renderFilters(){const e=document.getElementById("vaultFiltersContainer");if(!e||0===this.documents.length)return void(e&&(e.innerHTML=""));const t=this.documents.reduce((e,t)=>{const n=t.templateName||"General";return e[n]=(e[n]||0)+1,e},{}),n=Object.keys(t).sort(),s=[{id:"all",label:"Todos",count:this.documents.length},...n.map(e=>({id:e,label:e,count:t[e]}))];e.innerHTML=s.map(e=>`\n          <button type="button" \n              class="filter-btn px-4 py-1.5 rounded-full text-xs font-semibold transition-all duration-200 whitespace-nowrap flex items-center gap-2 ${this.activeFilter===e.id?"bg-slate-800 text-white shadow-md border border-slate-800":"bg-white text-slate-600 hover:bg-slate-50 border border-slate-200 hover:border-slate-300"}"\n              data-filter="${e.id}">\n              ${e.label}\n              <span class="opacity-60 text-[10px]">(${e.count})</span>\n          </button>\n        `).join(""),e.querySelectorAll(".filter-btn").forEach(e=>{e.addEventListener("click",()=>{this.activeFilter=e.dataset.filter,this.renderFilters(),this.renderGrid()})})}renderGrid(){const e=document.getElementById("vaultGridContainer");if(!e)return;let t=this.documents;"all"!==this.activeFilter&&(t=this.documents.filter(e=>(e.templateName||"General")===this.activeFilter)),0!==t.length?(e.innerHTML=`\n      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 pb-12">\n        ${t.map(e=>this.renderCardHtml(e)).join("")}\n      </div>\n    `,e.querySelectorAll(".doc-card").forEach(e=>{e.addEventListener("click",()=>this.onViewDocument(e.dataset.id))})):0===this.documents.length?this.renderEmptyStateTotal(e):e.innerHTML='<div class="text-center py-12 text-slate-400">No hay documentos en este filtro.</div>'}renderCardHtml(e){e.color;const t=e.icon||"üìÑ",n=e.title||"Documento sin t√≠tulo",s=e.templateName||"Archivo",a=new Date(e.updatedAt).toLocaleDateString("es-ES",{day:"numeric",month:"short",year:"numeric"});return`\n      <div class="doc-card group bg-white hover:bg-slate-50 rounded-xl p-5 border border-slate-200 shadow-sm hover:shadow-card hover:border-slate-300 transition-all duration-200 cursor-pointer relative overflow-hidden" data-id="${e.id}">\n          <div class="flex items-start justify-between mb-4">\n              <div class="w-10 h-10 rounded-lg flex items-center justify-center text-xl bg-slate-50 border border-slate-100 group-hover:scale-110 transition-transform">\n                  ${t}\n              </div>\n              <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider bg-slate-50 px-2 py-1 rounded border border-slate-100">\n                  ${s}\n              </div>\n          </div>\n          \n          <div class="mb-4">\n              <h3 class="text-sm font-bold text-slate-800 line-clamp-2 leading-snug group-hover:text-brand-600 transition-colors">\n                  ${n}\n              </h3>\n          </div>\n\n          <div class="flex items-center justify-between pt-3 border-t border-slate-100">\n              <span class="text-[10px] text-slate-400 font-medium">${a}</span>\n              <i class="fas fa-lock text-[10px] text-emerald-500 opacity-0 group-hover:opacity-100 transition-opacity" title="E2EE Protegido"></i>\n          </div>\n      </div>\n    `}renderEmptyStateTotal(e){e.innerHTML='\n        <div class="flex flex-col items-center justify-center py-16 text-center border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50/50">\n          <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-sm mb-4">\n            <i class="fas fa-safe text-2xl text-slate-300"></i>\n          </div>\n          <h3 class="text-slate-900 font-semibold mb-1">Tu b√≥veda est√° vac√≠a</h3>\n          <p class="text-slate-500 text-sm max-w-xs mb-6">Crea tu primer documento encriptado para comenzar a asegurar tu informaci√≥n.</p>\n          <button id="btnEmptyStateNew" class="px-5 py-2 bg-white text-slate-700 border border-slate-300 hover:border-brand-500 hover:text-brand-600 rounded-lg shadow-sm transition-all text-sm font-medium">\n            Comenzar ahora\n          </button>\n        </div>',e.querySelector("#btnEmptyStateNew")?.addEventListener("click",this.onNewDocument)}renderErrorState(e){e.innerHTML='\n        <div class="p-4 bg-red-50 text-red-600 rounded-lg text-center text-sm border border-red-100">\n          Error cargando documentos. <button id="retryBtn" class="underline font-bold">Reintentar</button>\n        </div>',document.getElementById("retryBtn")?.addEventListener("click",()=>this.loadDocuments())}}function Ie(e,t,n){if(null==t||""===t)return"_N/A_";if("object"==typeof t&&null!==t){if(t.url){return`${t.text&&t.text!==t.url?`${t.text}: `:""}${t.url}`}return JSON.stringify(t)}switch(e){case"boolean":return t?"S√≠":"No";case"currency":return new Intl.NumberFormat(n.locale).format(Number(t));case"date":try{if(String(t).includes("-")){const[e,n,s]=String(t).split("-");return`${s}/${n}/${e}`}}catch(s){}return String(t);case"percentage":return`${t}%`;default:return String(t)}}const Ce=(e,t,n,s=!1)=>{const a="print-target-iframe";document.querySelectorAll(`#${a}, iframe[name='print_frame']`).forEach(e=>e.remove());const r=document.createElement("iframe");r.id=a,r.name="print_frame",Object.assign(r.style,{position:"fixed",right:"0",bottom:"0",width:"0",height:"0",border:"0",visibility:"hidden",zIndex:"-1"}),document.body.appendChild(r);const i=function(e,t,n,s,a){let r="Fecha desconocida";try{r=new Date(e.updatedAt).toLocaleDateString("es-ES",{day:"numeric",month:"long",year:"numeric"})}catch(u){}const i=e.id||"SIN-ID",o=t.color||"#0f172a";let l="";l=a?`\n        <div class="flex justify-between items-end border-b-2 border-slate-900 pb-3 mb-6">\n            <div class="flex items-center gap-3">\n                <div class="text-lg">\n                    ${t.icon||'<i class="fas fa-file"></i>'}\n                </div>\n                <div>\n                    <h1 class="text-xl font-bold text-slate-900 leading-none">${e.title}</h1>\n                    <p class="text-[10px] text-slate-500 mt-1 uppercase tracking-widest">${t.name}</p>\n                </div>\n            </div>\n            <div class="text-right text-[10px]">\n                <p class="font-bold text-slate-700">${r}</p>\n                <p class="text-slate-400 font-mono">ID: ${i.substring(0,8)}</p>\n            </div>\n        </div>`:`\n        <div class="mb-10">\n             <div class="flex justify-between items-start">\n                <div class="flex gap-5 items-center">\n                    <div class="w-16 h-16 flex items-center justify-center text-3xl border border-slate-200 rounded-lg text-slate-800 bg-white">\n                        ${t.icon||'<i class="fas fa-file"></i>'}\n                    </div>\n                    <div>\n                       <h1 class="text-3xl font-bold text-slate-900 leading-tight mb-1">${e.title}</h1>\n                       <div class="flex items-center gap-3 text-sm text-slate-500">\n                          <span class="font-semibold text-brand-700 uppercase tracking-wide text-xs">${t.name}</span>\n                          <span class="w-1 h-1 bg-slate-300 rounded-full"></span>\n                          <span>${r}</span>\n                       </div>\n                    </div>\n                </div>\n                <div class="text-right">\n                    <div class="inline-block bg-slate-50 border border-slate-200 px-3 py-1 rounded text-[10px] font-mono text-slate-500">\n                        ID: ${i}\n                    </div>\n                </div>\n             </div>\n             <div class="w-full h-1 mt-6 bg-slate-100 relative">\n                <div class="absolute top-0 left-0 h-full w-24" style="background-color: ${o}"></div>\n             </div>\n        </div>`;const d=a?"grid-cols-4 gap-4":"grid-cols-2 gap-x-8 gap-y-6";let c=`\n        ${l}\n        <div class="grid ${d}">\n    `;t.fields.forEach(e=>{const t=n[e.id];let r="col-span-1";const i=["separator","table","textarea"].includes(e.type)||"text"===e.type&&String(t).length>60;if(r=a?i?"col-span-4":"col-span-1":i?"col-span-2":"col-span-1","separator"===e.type)return void(c+=`\n            <div class="${r} mt-4 mb-2 page-break">\n                <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wider border-b border-slate-200 pb-1 flex items-center gap-2">\n                    ${a?"":'<i class="fas fa-chevron-right text-[10px] text-slate-400"></i>'} \n                    ${e.label}\n                </h3>\n            </div>`);if("table"===e.type)return void(c+=`<div class="${r}">${function(e,t,n,s){if(!Array.isArray(t)||0===t.length)return s?"":`<div class="py-2 text-xs text-slate-400 italic text-center border-b border-slate-100">${e.label} (Sin datos)</div>`;const a=s?"px-1 py-1":"px-2 py-2",r=s?"text-[9px]":"text-[11px]",i=e.columns.map(e=>`<th class="${a} text-left ${r} font-bold text-slate-500 uppercase tracking-wider border-b-2 border-slate-200">${e.label}</th>`).join(""),o=t.map(t=>`<tr class="page-break">${e.columns.map(e=>`<td class="${a} ${r} text-slate-700 border-b border-slate-100 align-top">${$e(e.type,t[e.id],n,s)}</td>`).join("")}</tr>`).join("");return`\n        <div class="mt-2 mb-4 page-break w-full">\n            ${s?"":`<label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">${e.label}</label>`}\n            <table class="w-full border-collapse">\n                <thead><tr>${i}</tr></thead>\n                <tbody>${o}</tbody>\n            </table>\n        </div>`}(e,t,s,a)}</div>`);const o=$e(e.type,t,s,a);c+=a?`\n            <div class="${r} border-b border-slate-100 py-1 page-break">\n              <span class="text-[10px] font-bold text-slate-500 uppercase mr-1">${e.label}:</span>\n              <span class="text-xs font-semibold text-slate-900">${o}</span>\n            </div>`:`\n            <div class="${r} page-break mb-2">\n              <dt class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">\n                 ${e.label}\n              </dt>\n              <dd class="text-sm text-slate-900 border-b border-slate-100 pb-1 font-medium leading-relaxed">\n                 ${o}\n              </dd>\n            </div>`}),c+="</div>",a||(c+=`\n        <div class="mt-16 pt-6 border-t border-slate-200 flex items-center justify-between text-slate-400">\n           <div class="flex items-center text-[10px] font-bold uppercase tracking-widest gap-2">\n                <i class="fas fa-lock text-slate-300"></i>\n                <span>Documento Protegido (E2EE)</span>\n           </div>\n           <div class="text-[9px]">\n                Generado el ${(new Date).toLocaleString()}\n           </div>\n        </div>`);return c}(e,t,n,K(),s),o=`\n        <!DOCTYPE html>\n        <html lang="es">\n        <head>\n            <meta charset="UTF-8">\n            <title>${e.title||"Impresi√≥n"}</title>\n            <script src="https://cdn.tailwindcss.com"><\/script>\n            <link rel="preconnect" href="https://fonts.googleapis.com">\n            <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>\n            <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">\n            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">\n            \n            <style>\n                @media print {\n                    @page { \n                        margin: ${s?"1cm":"1.5cm"}; \n                        size: auto; \n                    }\n                    body { \n                        -webkit-print-color-adjust: exact !important; \n                        print-color-adjust: exact !important; \n                    }\n                    .page-break { break-inside: avoid; }\n                }\n                \n                body { \n                    font-family: 'Inter', sans-serif;\n                    background-color: white;\n                    color: #0f172a; /* slate-900 */\n                    font-size: 12px; /* Base size para impresi√≥n */\n                    line-height: 1.5;\n                }\n\n                /* Forzar blanco puro en fondos para ahorrar tinta y limpiar look */\n                .print-card {\n                    background-color: white !important;\n                    border: 1px solid #e2e8f0; /* slate-200 */\n                    box-shadow: none !important;\n                }\n            </style>\n        </head>\n        <body class="antialiased">\n            ${i}\n            <script>\n                window.onload = () => {\n                    // Peque√±o delay para asegurar carga de fuentes e iconos\n                    setTimeout(() => {\n                        window.focus();\n                        window.print();\n                    }, 800);\n                };\n            <\/script>\n        </body>\n        </html>\n    `,l=r.contentWindow.document;l.open(),l.write(o),l.close()};function $e(e,t,n,s){if(null==t||""===t)return s?"‚Äî":'<span class="text-slate-300 italic">Vac√≠o</span>';if("object"==typeof t&&t.url){if("url"===e&&t.url.match(/\.(jpeg|jpg|gif|png|webp)$/i)){const e=s?"w-6 h-6":"w-12 h-12";return`<div class="flex items-center gap-2">\n                <img src="${t.url}" class="${e} object-cover rounded border border-slate-200 bg-slate-50">\n                <span class="text-xs text-slate-700 font-medium">${t.text||"Imagen"}</span>\n             </div>`}return`<span class="text-xs font-medium text-slate-800">${t.text||t.url}</span>`}switch(e){case"boolean":return t?"S√≠":"No";case"currency":return`<span class="font-mono font-bold text-slate-800">${new Intl.NumberFormat(n.locale,{style:"currency",currency:n.codigo}).format(Number(t))}</span>`;case"date":try{const[e,n,s]=String(t).split("-");return`${s}/${n}/${e}`}catch(a){return t}default:return`<span class="whitespace-pre-wrap">${String(t)}</span>`}}const Se=new class{constructor(){this.widgetId="global-media-player",this.widgetContentId="global-player-content",this.widgetTitleId="global-player-title",this.modalId="global-image-modal",this.modalContentId="global-modal-content",this.modalTitleId="global-modal-title",this.isRendered=!1}renderBase(){if(document.getElementById(this.widgetId))return;const e=`\n            <div id="${this.widgetId}" class="fixed bottom-5 right-5 w-80 z-[100] hidden transition-all duration-300 transform translate-y-4 opacity-0 bg-white/95 backdrop-blur-md border border-slate-200 shadow-2xl rounded-2xl overflow-hidden ring-1 ring-black/5">\n                <div class="flex items-center justify-between px-4 py-3 bg-slate-50 border-b border-slate-100">\n                    <span id="${this.widgetTitleId}" class="text-xs font-bold text-slate-500 uppercase tracking-wider">Reproductor</span>\n                    <button id="close-global-player" class="text-slate-400 hover:text-slate-700 w-6 h-6 flex items-center justify-center rounded-full hover:bg-slate-200 transition">\n                        <i class="fas fa-times text-sm"></i>\n                    </button>\n                </div>\n                <div id="${this.widgetContentId}" class="p-4 flex justify-center bg-white min-h-[80px] items-center">\n                </div>\n            </div>\n        `,t=`\n        <div id="${this.modalId}" class="fixed inset-0 z-[110] hidden" aria-hidden="true">\n            <div id="${this.modalId}-backdrop" class="absolute inset-0 bg-slate-900/90 backdrop-blur-sm transition-opacity duration-300 opacity-0 cursor-pointer"></div>\n            \n            <div class="absolute inset-0 flex items-center justify-center p-4 sm:p-6 pointer-events-none">\n                <div id="${this.modalId}-panel" class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col overflow-hidden transform transition-all duration-300 scale-95 opacity-0 pointer-events-auto">\n                    \n                    <div class="flex items-center justify-between px-6 py-4 bg-white border-b border-slate-100 flex-shrink-0 z-10">\n                        <h3 id="${this.modalTitleId}" class="font-bold text-slate-800 text-lg truncate pr-4">Vista Previa</h3>\n                        <div class="flex gap-2">\n                            <a id="${this.modalId}-link" href="#" target="_blank" class="text-slate-400 hover:text-primary bg-slate-50 hover:bg-slate-100 w-9 h-9 flex items-center justify-center rounded-full transition-colors" title="Abrir original">\n                                <i class="fas fa-external-link-alt"></i>\n                            </a>\n                            <button id="${this.modalId}-close" class="text-slate-400 hover:text-slate-700 bg-slate-50 hover:bg-slate-100 w-9 h-9 flex items-center justify-center rounded-full transition-colors focus:outline-none" title="Cerrar">\n                                <i class="fas fa-times text-lg"></i>\n                            </button>\n                        </div>\n                    </div>\n                    \n                    <div id="${this.modalContentId}" class="flex-grow overflow-auto p-2 bg-slate-50/50 flex items-center justify-center relative min-h-[200px]">\n                        </div>\n                </div>\n            </div>\n        </div>\n    `;document.body.insertAdjacentHTML("beforeend",e+t),document.getElementById("close-global-player").addEventListener("click",()=>this.closeWidget());const n=()=>this.closeModal();document.getElementById(`${this.modalId}-close`).addEventListener("click",n),document.getElementById(`${this.modalId}-backdrop`).addEventListener("click",n),document.addEventListener("keydown",e=>{"Escape"!==e.key||document.getElementById(this.modalId).classList.contains("hidden")||this.closeModal()}),this.isRendered=!0}open(e,t,n){this.isRendered||this.renderBase(),"image"===e?(this.closeWidget(),this.openModal(t,n)):(this.closeModal(),this.openWidget(e,t,n))}openWidget(e,t,n){const s=document.getElementById(this.widgetId),a=document.getElementById(this.widgetContentId);document.getElementById(this.widgetTitleId).textContent=n||"Reproduciendo Audio",a.innerHTML="","audio"===e?a.innerHTML=`\n                <div class="w-full">\n                    <audio controls autoplay class="w-full h-10 block rounded bg-slate-50 focus:outline-none">\n                        <source src="${t}">\n                        Tu navegador no soporta audio.\n                    </audio>\n                </div>`:a.textContent="Formato no soportado en vista previa r√°pida.",s.classList.remove("hidden"),requestAnimationFrame(()=>{s.classList.remove("translate-y-4","opacity-0")})}closeWidget(){const e=document.getElementById(this.widgetId);if(!e||e.classList.contains("hidden"))return;const t=e.querySelector("audio");t&&t.pause(),e.classList.add("translate-y-4","opacity-0"),setTimeout(()=>{e.classList.add("hidden"),document.getElementById(this.widgetContentId).innerHTML=""},300)}openModal(e,t){const n=document.getElementById(this.modalId),s=document.getElementById(`${this.modalId}-backdrop`),a=document.getElementById(`${this.modalId}-panel`),r=document.getElementById(this.modalContentId),i=document.getElementById(this.modalTitleId),o=document.getElementById(`${this.modalId}-link`);i.textContent=t||"Imagen Adjunta",o.href=e,r.innerHTML=`\n        <img src="${e}" \n             class="max-w-full max-h-full object-contain rounded-lg shadow-sm animate-fade-in select-none" \n             alt="${t||"Vista previa"}"\n        />`,n.classList.remove("hidden"),requestAnimationFrame(()=>{s.classList.remove("opacity-0"),a.classList.remove("scale-95","opacity-0"),a.classList.add("scale-100","opacity-100")})}closeModal(){const e=document.getElementById(this.modalId);if(!e||e.classList.contains("hidden"))return;const t=document.getElementById(`${this.modalId}-backdrop`),n=document.getElementById(`${this.modalId}-panel`);t.classList.add("opacity-0"),n.classList.remove("scale-100","opacity-100"),n.classList.add("scale-95","opacity-0"),setTimeout(()=>{e.classList.add("hidden"),document.getElementById(this.modalContentId).innerHTML=""},300)}};class ke{constructor(e,t){this.docId=e,this.onBack=t,this.document=null,this.template=null,this.decryptedData=null,this.currencyConfig=K(),this.tableStates={}}render(){return'<div id="documentViewerPlaceholder" class="animate-fade-in pb-20"></div>'}async load(){if(this.renderLoading(),!j.isReady())return window.app&&window.app.requireEncryption?void window.app.requireEncryption(()=>this.load()):void this.renderError("Cifrado no disponible.");try{if(this.document=await G.getById(this.docId),this.template=await V.getTemplateById(this.document.templateId),!this.template)throw new Error("Plantilla no encontrada.");this.decryptedData=await j.decryptDocument(this.document.encryptedContent),this.template.fields.forEach(e=>{"table"===e.type&&(this.tableStates[e.id]={search:"",sortCol:null,sortDir:"asc"})}),this.renderContent()}catch(e){this.renderError(e.message)}}renderFieldValue(e,t,n=!1){if(null==t||"string"==typeof t&&""===t.trim())return'<span class="text-slate-300 text-xs italic">Vac√≠o</span>';switch(e){case"url":return function(e,t=!1){let n="object"==typeof e?e.url:e,s="object"==typeof e?e.text||n:e;if(!n)return'<span class="text-slate-300 italic text-xs">--</span>';const a=(e=>{if(!e||"string"!=typeof e)return"link";let t=e.split("?")[0].toLowerCase();return[".jpg",".jpeg",".png",".gif",".webp",".svg",".bmp"].some(e=>t.endsWith(e))?"image":[".mp3",".wav",".ogg",".m4a",".aac"].some(e=>t.endsWith(e))?"audio":"link"})(n),r=s===n?"audio"===a?"Archivo de Audio":"Imagen Adjunta":s,i=t&&r.length>25?r.substring(0,22)+"...":r;if("audio"===a||"image"===a)return`\n            <div class="flex items-center gap-3 group">\n                <button type="button" \n                        class="trigger-media-btn w-9 h-9 flex items-center justify-center rounded-full border border-slate-200 ${"audio"===a?"bg-pink-50 group-hover:bg-pink-100":"bg-indigo-50 group-hover:bg-indigo-100"} transition-all shadow-sm hover:scale-105"\n                        data-type="${a}" \n                        data-src="${n}" \n                        data-title="${r}"\n                        title="Ver ${"audio"===a?"Audio":"Imagen"}">\n                    <i class="fas ${"audio"===a?"fa-music":"fa-image"} ${"audio"===a?"text-pink-500 group-hover:text-pink-600":"text-indigo-500 group-hover:text-indigo-600"} text-sm"></i>\n                </button>\n                <a href="${n}" target="_blank" class="text-sm font-medium text-slate-700 hover:text-primary hover:underline truncate">\n                    ${i}\n                    <i class="fas fa-external-link-alt text-[10px] ml-1 text-slate-300"></i>\n                </a>\n            </div>\n        `;return`\n        <a href="${n}" target="_blank" class="inline-flex items-center gap-1.5 text-blue-600 hover:text-blue-800 hover:underline font-medium transition-colors break-all text-sm">\n            <i class="fas fa-link text-xs opacity-50 flex-shrink-0"></i> ${i}\n        </a>`}(t,n);case"boolean":return function(e){return e?'<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-emerald-100 text-emerald-700"><i class="fas fa-check mr-1"></i> S√≠</span>':'<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-slate-100 text-slate-500">No</span>'}(t);case"date":return function(e){try{const[t,n,s]=String(e).split("-");return`<span class="font-semibold text-slate-700"><i class="far fa-calendar text-slate-400 mr-2"></i>${new Date(t,n-1,s).toLocaleDateString()}</span>`}catch{return e}}(t);case"currency":return function(e,t){return`<span class="font-mono font-bold text-slate-700 bg-slate-50 px-2 py-0.5 rounded border border-slate-100">${new Intl.NumberFormat(t.locale,{style:"currency",currency:t.codigo}).format(Number(e))}</span>`}(t,this.currencyConfig);case"percentage":return function(e){return`<span class="font-mono font-bold text-slate-700">${e}%</span>`}(t);case"secret":return function(e,t){return e?t?`\n        <div class="group/secret flex items-center gap-2 select-none h-full">\n            <div class="relative font-mono text-xs text-slate-500">\n                <span class="secret-mask tracking-widest align-middle">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>\n                <span class="secret-revealed hidden font-bold text-slate-800 align-middle">${e}</span>\n            </div>\n\n            <div class="flex items-center gap-0.5 opacity-0 group-hover/secret:opacity-100 transition-opacity duration-200">\n                <button type="button" class="toggle-secret-btn w-6 h-6 flex items-center justify-center text-slate-400 hover:text-indigo-600 hover:bg-slate-100 rounded transition-colors" title="Mostrar/Ocultar">\n                    <i class="fas fa-eye text-[10px]"></i>\n                </button>\n\n                <button type="button" class="copy-btn w-6 h-6 flex items-center justify-center text-slate-400 hover:text-emerald-600 hover:bg-slate-100 rounded transition-colors" data-value="${e}" title="Copiar">\n                    <i class="far fa-copy text-[10px]"></i>\n                </button>\n            </div>\n        </div>`:`\n        <div class="flex items-center gap-2">\n            <div class="relative group overflow-hidden rounded-lg border border-slate-200 bg-white px-3 py-2 transition-all hover:border-indigo-200 hover:shadow-sm w-full">\n                <span class="secret-mask filter blur-[5px] select-none transition-all duration-300 group-hover:blur-none font-mono text-sm text-slate-800 tracking-wider">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>\n                <span class="secret-revealed hidden font-mono text-sm text-slate-800 select-all font-bold tracking-wide">${e}</span>\n            </div>\n            <button class="toggle-secret-btn w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-lg text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 transition-colors bg-white border border-slate-200" title="Revelar"><i class="fas fa-eye"></i></button>\n            <button class="copy-btn w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-lg text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 transition-colors bg-white border border-slate-200" data-value="${e}" title="Copiar"><i class="far fa-copy"></i></button>\n        </div>`:'<span class="text-slate-300 text-xs italic">--</span>'}(t,n);case"text":return function(e,t){return t?e.length>30?e.substring(0,30)+"...":e:`<div class="prose prose-sm max-w-none text-slate-600 whitespace-pre-line">${e}</div>`}(t,n);default:return String(t)}}groupFields(){const e=[];let t={id:"group-principal",label:"Informaci√≥n General",icon:"fas fa-info-circle",fields:[]};return this.template.fields.forEach(n=>{"separator"===n.type?(t.fields.length>0&&e.push(t),t={id:`group-${n.id}`,label:n.label,icon:"fas fa-layer-group",fields:[],isSeparator:!0}):t.fields.push(n)}),t.fields.length>0&&e.push(t),e}renderContent(){const e=document.getElementById("documentViewerPlaceholder");if(!e)return;Se.renderBase();const t=new Date(this.document.metadata.updatedAt).toLocaleDateString("es-ES",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"}),n=this.groupFields(),s=this.template.color||"#3b82f6",a=e=>e.map(e=>{const t=this.decryptedData[e.id];if("table"===e.type)return`<div class="col-span-1 md:col-span-2 mt-4 mb-4">${this.renderTableField(e,t)}</div>`;return`\n            <div class="${["text","url"].includes(e.type)?"col-span-1 md:col-span-2":"col-span-1"} group border-b border-slate-100 pb-3 last:border-0 hover:bg-slate-50/50 transition-colors rounded-lg px-2 -mx-2">\n              <dt class="text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-1">\n                 ${e.label}\n              </dt>\n              <dd class="text-sm text-slate-800 font-medium break-words leading-relaxed">\n                 ${this.renderFieldValue(e.type,t)}\n              </dd>\n            </div>`}).join("");let r="";r=1===n.length?`<dl class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-6">${a(n[0].fields)}</dl>`:`\n        <div class="viewer-layout-container mt-6">\n            <div class="flex border-b border-slate-200 mb-6 overflow-x-auto no-scrollbar gap-6 print:hidden">\n                ${n.map((e,t)=>`\n                    <button type="button" \n                            class="viewer-tab-trigger pb-3 text-sm font-bold whitespace-nowrap transition-all flex items-center gap-2 ${0===t?"text-brand-600 border-b-2 border-brand-600":"text-slate-500 hover:text-slate-700 border-b-2 border-transparent"}"\n                            data-target="${e.id}">\n                        ${e.label}\n                    </button>`).join("")}\n            </div>\n\n            <div class="space-y-4">\n                ${n.map((e,t)=>`\n                    <div class="viewer-group-container ${0===t?"":"hidden"} animate-fade-in" id="${e.id}">\n                        <dl class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-6">\n                            ${a(e.fields)}\n                        </dl>\n                    </div>`).join("")}\n            </div>\n        </div>`,e.innerHTML=`\n      <div class="flex items-center justify-between mb-6 no-print">\n         <button id="backBtn" class="flex items-center text-slate-500 hover:text-slate-800 transition-colors font-medium text-sm gap-2 px-3 py-2 rounded-lg hover:bg-slate-100">\n            <i class="fas fa-arrow-left"></i> Volver\n         </button>\n         \n         <div class="flex items-center gap-1 bg-white p-1 rounded-xl shadow-sm border border-slate-200">\n            <button id="whatsappDocBtn" class="w-9 h-9 flex items-center justify-center text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 rounded-lg transition-colors" title="Compartir WhatsApp">\n                <i class="fab fa-whatsapp text-lg"></i>\n            </button>\n            <button id="pdfDocBtn" class="w-9 h-9 flex items-center justify-center text-slate-400 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-colors" title="Imprimir">\n                <i class="fas fa-print text-lg"></i>\n            </button>\n            <div class="w-px h-5 bg-slate-200 mx-1"></div>\n            <button id="deleteDocBtn" class="w-9 h-9 flex items-center justify-center text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Eliminar">\n                <i class="far fa-trash-alt text-lg"></i>\n            </button>\n            <button id="editDocBtn" class="ml-1 px-4 h-9 bg-slate-800 hover:bg-slate-900 text-white rounded-lg text-xs font-bold uppercase tracking-wide transition-colors flex items-center gap-2">\n                <i class="fas fa-pen"></i> Editar\n            </button>\n         </div>\n      </div>\n\n      <div id="documentCard" class="bg-white rounded-none sm:rounded-xl shadow-card border-y sm:border border-slate-200 min-h-[600px] print:shadow-none print:border-none">\n        \n        <div class="px-8 py-10 border-b border-slate-100 bg-slate-50/30 print:bg-white print:border-b-2 print:border-black">\n             <div class="flex items-start gap-6">\n                <div class="w-16 h-16 rounded-xl flex items-center justify-center text-3xl shadow-sm border border-slate-100 bg-white print:hidden" style="color: ${s}">\n                    ${this.template.icon||"üìÑ"}\n                </div>\n                <div>\n                   <div class="flex items-center gap-2 mb-2">\n                      <span class="text-[10px] font-bold uppercase tracking-widest text-slate-400 bg-white border border-slate-200 px-2 py-0.5 rounded shadow-sm">\n                        ${this.template.name}\n                      </span>\n                   </div>\n                   <h1 class="text-3xl font-bold text-slate-900 leading-tight mb-2">${this.document.metadata.title}</h1>\n                   <p class="text-xs text-slate-400 flex items-center gap-4 font-mono">\n                      <span><i class="far fa-clock mr-1"></i> ${t}</span>\n                      <span class="text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded"><i class="fas fa-shield-alt mr-1"></i> E2EE</span>\n                   </p>\n                </div>\n             </div>\n        </div>\n\n        <div class="p-8 sm:p-10">\n           ${r}\n        </div>\n      </div>\n      \n      <div id="rowDetailModal" class="fixed inset-0 z-50 hidden no-print">\n         <div class="absolute inset-0 bg-slate-900/20 backdrop-blur-sm" id="modalBackdrop"></div>\n         <div class="flex items-center justify-center min-h-screen p-4 pointer-events-none">\n            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg pointer-events-auto flex flex-col max-h-[80vh] animate-slide-up">\n                <div class="px-5 py-4 border-b border-slate-100 flex justify-between items-center">\n                    <h3 class="font-bold text-slate-800">Detalle</h3>\n                    <button class="close-modal text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>\n                </div>\n                <div class="p-5 overflow-y-auto" id="rowDetailContent"></div>\n            </div>\n         </div>\n      </div>\n    `,this.setupContentListeners()}showPrintOptions(){if(!document.getElementById("printOptionsModal")){const e='\n        <div id="printOptionsModal" class="fixed inset-0 z-[70] flex items-center justify-center p-4 hidden"> \n            <div class="absolute inset-0 bg-slate-900/20 backdrop-blur-sm" id="printModalBackdrop"></div>\n            <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden animate-slide-up">\n                <div class="p-6 text-center">\n                    <h3 class="text-lg font-bold text-slate-800 mb-4">Imprimir Documento</h3>\n                    <div class="space-y-3">\n                        <button id="printStandardBtn" class="w-full flex items-center p-3 border border-slate-200 rounded-lg hover:border-brand-500 hover:bg-brand-50 transition-all text-left group">\n                            <i class="fas fa-file-alt text-2xl text-slate-300 group-hover:text-brand-500 mr-4"></i>\n                            <div>\n                                <span class="block font-bold text-slate-700 text-sm">Formato Visual</span>\n                                <span class="block text-xs text-slate-400">Dise√±o completo con iconos</span>\n                            </div>\n                        </button>\n                        <button id="printCompactBtn" class="w-full flex items-center p-3 border border-slate-200 rounded-lg hover:border-emerald-500 hover:bg-emerald-50 transition-all text-left group">\n                            <i class="fas fa-list text-2xl text-slate-300 group-hover:text-emerald-500 mr-4"></i>\n                            <div>\n                                <span class="block font-bold text-slate-700 text-sm">Formato Compacto</span>\n                                <span class="block text-xs text-slate-400">Ahorro de papel y tinta</span>\n                            </div>\n                        </button>\n                    </div>\n                </div>\n                <div class="bg-slate-50 p-3 text-center border-t border-slate-100">\n                    <button id="cancelPrintBtn" class="text-xs font-bold text-slate-500 hover:text-slate-800 uppercase">Cancelar</button>\n                </div>\n            </div>\n        </div>';document.body.insertAdjacentHTML("beforeend",e)}const e=document.getElementById("printOptionsModal"),t=()=>e.classList.add("hidden");document.getElementById("printModalBackdrop").onclick=t,document.getElementById("cancelPrintBtn").onclick=t,document.getElementById("printStandardBtn").onclick=()=>{this.triggerPrint(!1),t()},document.getElementById("printCompactBtn").onclick=()=>{this.triggerPrint(!0),t()},e.classList.remove("hidden")}triggerPrint(e){const t={...this.document.metadata,id:this.document.id};Ce(t,this.template,this.decryptedData,e)}setupContentListeners(){const e=document.getElementById("documentViewerPlaceholder"),t=e.querySelectorAll(".viewer-tab-trigger"),n=e.querySelectorAll(".viewer-group-container");t.forEach(e=>{e.addEventListener("click",()=>{const s=e.dataset.target;t.forEach(e=>e.className="viewer-tab-trigger pb-3 text-sm font-bold whitespace-nowrap transition-all flex items-center gap-2 text-slate-500 hover:text-slate-700 border-b-2 border-transparent"),e.className="viewer-tab-trigger pb-3 text-sm font-bold whitespace-nowrap transition-all flex items-center gap-2 text-brand-600 border-b-2 border-brand-600",n.forEach(e=>{e.id===s?e.classList.remove("hidden"):e.classList.add("hidden")})})}),["backBtn"].forEach(e=>document.getElementById(e)?.addEventListener("click",()=>this.onBack())),document.getElementById("deleteDocBtn")?.addEventListener("click",()=>this.handleDelete()),document.getElementById("editDocBtn")?.addEventListener("click",()=>this.handleEdit()),document.getElementById("pdfDocBtn")?.addEventListener("click",()=>this.showPrintOptions()),document.getElementById("whatsappDocBtn")?.addEventListener("click",()=>this.handleCopyToWhatsApp())}renderTableField(e,t){const n=Array.isArray(t)?t:[];return 0===n.length?`<div class="p-6 border border-dashed border-slate-200 rounded-lg bg-slate-50 text-center text-xs text-slate-400 flex flex-col items-center gap-2"><i class="fas fa-table text-xl opacity-20"></i>${e.label} (Tabla vac√≠a)</div>`:`<div class="bg-white border border-slate-200 rounded-lg overflow-hidden shadow-sm">\n        <div class="bg-slate-50 px-4 py-2 border-b border-slate-100 flex justify-between items-center">\n            <span class="text-xs font-bold text-slate-500 uppercase">${e.label}</span>\n            <span class="bg-white border border-slate-200 px-2 rounded-full text-[10px] text-slate-400">${n.length}</span>\n        </div>\n        <div class="overflow-x-auto">\n            <table class="min-w-full text-sm text-left text-slate-600">\n                <thead class="bg-slate-50 text-xs text-slate-400 uppercase font-medium">\n                     ${e.columns.map(e=>`<th class="px-4 py-2">${e.label}</th>`).join("")}\n                </thead>\n                <tbody class="divide-y divide-slate-100">\n                    ${n.map(t=>`\n                        <tr class="hover:bg-slate-50/50">\n                            ${e.columns.map(e=>`<td class="px-4 py-2">${this.renderFieldValue(e.type,t[e.id],!0)}</td>`).join("")}\n                        </tr>\n                    `).join("")}\n                </tbody>\n            </table>\n        </div>\n    </div>`}renderLoading(){document.getElementById("documentViewerPlaceholder").innerHTML='<div class="flex flex-col items-center justify-center py-20"><div class="animate-spin rounded-full h-8 w-8 border-2 border-slate-200 border-t-brand-600 mb-4"></div><p class="text-slate-400 text-sm">Cargando...</p></div>'}renderError(e){document.getElementById("documentViewerPlaceholder").innerHTML=`<div class="bg-red-50 border border-red-100 text-red-600 p-4 rounded-lg text-center text-sm">${e}</div>`}async handleDelete(){confirm("¬øEliminar este documento?")&&(await G.delete(this.docId),this.onBack())}handleEdit(){this.onBack({documentId:this.docId,template:this.template,formData:this.decryptedData,metadata:this.document.metadata})}async handleCopyToWhatsApp(){try{await async function(e,t,n,s){try{let a=`*${e.title}*\n_${t.name}_\n\n`;return t.fields.forEach(e=>{if("separator"===e.type)return;const t=n[e.id];if("table"===e.type){const n=Array.isArray(t)?t:[];a+=`*${e.label}:* ${0===n.length?"_Sin datos_":""}\n`,n.forEach((t,n)=>{a+=`  ${n+1}. `,e.columns&&e.columns.forEach((n,r)=>{const i=t[n.id],o=Ie(n.type,i,s),l=r<e.columns.length-1?" | ":"";a+=`${n.label}: ${o}${l}`}),a+="\n"}),a+="\n"}else a+=`*${e.label}:* ${Ie(e.type,t,s)}\n`}),a+="\n_Enviado desde Mi Gesti√≥n_",await navigator.clipboard.writeText(a),!0}catch(a){throw a}}(this.document.metadata,this.template,this.decryptedData,this.currencyConfig),alert("Copiado al portapapeles para WhatsApp")}catch(e){alert("Error copiando")}}}class Le{render(){return'\n      <div class="max-w-4xl mx-auto space-y-6 animate-fade-in pb-20">\n        \n        <div class="mb-8">\n            <h2 class="text-2xl font-bold text-slate-900 tracking-tight">Configuraci√≥n de Seguridad</h2>\n            <p class="text-slate-500 text-sm">Gestiona tus claves de acceso y cifrado.</p>\n        </div>\n\n        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">\n            \n            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">\n                <div class="px-6 py-4 border-b border-slate-100 flex items-center gap-3">\n                    <div class="w-8 h-8 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center text-sm border border-blue-100">\n                        <i class="fas fa-user-lock"></i>\n                    </div>\n                    <h3 class="font-bold text-slate-800 text-sm">Acceso (Login)</h3>\n                </div>\n                <div class="p-6">\n                    <form id="changeAccessPassForm" class="space-y-4">\n                        <div>\n                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Contrase√±a Actual</label>\n                            <input type="password" id="currentAccessPass" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 outline-none text-sm" required>\n                        </div>\n                        <div>\n                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nueva Contrase√±a</label>\n                            <input type="password" id="newAccessPass" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 outline-none text-sm" required minlength="6">\n                        </div>\n                        <button type="submit" id="btnChangeAccess" class="w-full py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition text-sm shadow-sm">\n                            Actualizar Login\n                        </button>\n                    </form>\n                </div>\n            </div>\n\n            <div class="bg-white rounded-xl shadow-sm border border-amber-200 overflow-hidden relative">\n                <div class="px-6 py-4 border-b border-amber-100 bg-amber-50/30 flex items-center gap-3">\n                    <div class="w-8 h-8 rounded-lg bg-amber-100 text-amber-600 flex items-center justify-center text-sm border border-amber-200">\n                        <i class="fas fa-key"></i>\n                    </div>\n                    <div>\n                        <h3 class="font-bold text-slate-800 text-sm">Llave Maestra (E2EE)</h3>\n                    </div>\n                </div>\n                <div class="p-6">\n                    <p class="text-xs text-amber-700 bg-amber-50 p-3 rounded-lg border border-amber-100 mb-4 leading-relaxed font-medium">\n                        <i class="fas fa-exclamation-triangle mr-1"></i> Cambiar esto re-cifrar√° todos tus documentos.\n                    </p>\n                    \n                    <form id="changeVaultPassForm" class="space-y-4">\n                        <div>\n                            <input type="password" id="currentVaultPass" placeholder="Llave Actual" class="w-full px-3 py-2 bg-white border border-slate-200 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-500/20 outline-none text-sm font-mono" required>\n                        </div>\n                        <div class="grid grid-cols-2 gap-2">\n                            <input type="password" id="newVaultPass" placeholder="Nueva Llave" class="w-full px-3 py-2 bg-white border border-slate-200 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-500/20 outline-none text-sm font-mono" required minlength="8">\n                            <input type="password" id="confirmVaultPass" placeholder="Confirmar" class="w-full px-3 py-2 bg-white border border-slate-200 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-500/20 outline-none text-sm font-mono" required>\n                        </div>\n                        <button type="submit" id="btnChangeVault" class="w-full py-2 bg-amber-600 hover:bg-amber-700 text-white font-bold rounded-lg transition text-sm shadow-sm">\n                            Re-Cifrar B√≥veda\n                        </button>\n                    </form>\n                </div>\n            </div>\n        </div>\n\n        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">\n            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">\n                <h3 class="font-bold text-slate-800 text-sm flex items-center gap-2">\n                    <i class="fas fa-database text-slate-400"></i> Respaldo y Restauraci√≥n\n                </h3>\n            </div>\n            \n            <div class="p-6 flex flex-col sm:flex-row gap-6 items-center">\n                <div class="flex-1 w-full">\n                    <button id="btnExport" class="w-full py-3 bg-white border border-slate-200 text-slate-700 hover:border-brand-500 hover:text-brand-600 font-bold rounded-lg transition-all text-sm flex items-center justify-center gap-2 group">\n                        <span class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center group-hover:bg-brand-50 transition-colors"><i class="fas fa-download text-xs"></i></span>\n                        Descargar Copia Cifrada\n                    </button>\n                    <p class="text-[10px] text-slate-400 text-center mt-2">Formato JSON seguro</p>\n                </div>\n\n                <div class="h-px w-full sm:w-px sm:h-12 bg-slate-200"></div>\n\n                <div class="flex-1 w-full">\n                    <div class="flex gap-2">\n                        <input type="file" id="fileImport" accept=".json" class="hidden" />\n                        <button onclick="document.getElementById(\'fileImport\').click()" class="flex-1 py-3 bg-slate-50 border border-slate-200 hover:bg-slate-100 text-slate-600 font-bold rounded-lg transition text-sm">\n                            Elegir Archivo\n                        </button>\n                        <button id="btnRestore" disabled class="px-6 py-3 bg-brand-600 hover:bg-brand-700 disabled:bg-slate-200 disabled:text-slate-400 disabled:cursor-not-allowed text-white font-bold rounded-lg transition text-sm">\n                            Restaurar\n                        </button>\n                    </div>\n                    <div id="restoreStatus" class="mt-2 text-[10px] text-center min-h-[1.2em]"></div>\n                </div>\n            </div>\n        </div>\n      </div>\n    '}setupEventListeners(){document.getElementById("changeAccessPassForm")?.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("currentAccessPass").value,n=document.getElementById("newAccessPass").value;try{await M.changeAccessPassword(n,t),alert("Clave actualizada"),e.target.reset()}catch(s){alert(s.message)}}),document.getElementById("changeVaultPassForm")?.addEventListener("submit",async e=>{e.preventDefault()}),document.getElementById("btnExport")?.addEventListener("click",async()=>{});const e=document.getElementById("fileImport"),t=document.getElementById("btnRestore");document.getElementById("restoreStatus"),e?.addEventListener("change",()=>{e.files.length&&(t.disabled=!1)}),t?.addEventListener("click",async()=>{})}}async function Te(e,t){if(e){if(!e.emailVerified)return await M.logout(),Be(t),void $.show("Debes verificar tu correo para continuar","error");try{await V.initialize(e.uid)}catch(n){}!async function(e,t){t.innerHTML=`\n    <div class="min-h-screen flex flex-col bg-slate-50">\n      <nav class="sticky top-0 z-50 w-full bg-white border-b border-slate-200 shadow-sm">\n        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">\n          <div class="flex justify-between h-16 items-center">\n            <div class="flex items-center gap-3 cursor-pointer group" id="navHome">\n              <div class="w-9 h-9 rounded-lg bg-brand-600 flex items-center justify-center text-white shadow-md group-hover:bg-brand-700 transition-colors">\n                 <i class="fas fa-fingerprint text-lg"></i>\n              </div>\n              <div>\n                <span class="block font-bold text-slate-800 text-base leading-none">Mi Gesti√≥n</span>\n              </div>\n            </div>\n            \n            <div class="flex items-center gap-6">\n                <div class="hidden md:flex flex-col items-end">\n                    <p class="text-xs font-semibold text-slate-700">${e.email}</p>\n                    <div class="flex items-center gap-1.5">\n                      <div class="w-1.5 h-1.5 rounded-full bg-emerald-500"></div>\n                      <p class="text-[10px] text-slate-500 font-medium uppercase tracking-wide">Encriptado</p>\n                    </div>\n                </div>\n                <div class="h-8 w-px bg-slate-200 hidden md:block"></div>\n                <button id="logoutButton" class="text-slate-500 hover:text-red-600 transition-colors text-sm font-medium flex items-center gap-2">\n                    <i class="fas fa-power-off"></i>\n                    <span class="hidden sm:inline">Salir</span>\n                </button>\n            </div>\n          </div>\n        </div>\n      </nav>\n\n      <main class="flex-grow max-w-7xl w-full mx-auto py-8 px-4 sm:px-6 lg:px-8 relative z-10">\n        <div id="dynamicContent" class="animate-fade-in"></div>\n      </main>\n    </div>`,document.getElementById("logoutButton")?.addEventListener("click",()=>M.logout()),document.getElementById("navHome")?.addEventListener("click",()=>je(e)),je(e)}(e,t)}else Be(t)}function De(e){const t=M.getCurrentUser();if(!t)return;if(j.isReady())return void e();new F(async t=>{try{await M.initializeEncryption(t);const n=await G.getAllDocuments();return n.length>0&&await j.decryptDocument(n[0].encryptedContent),!!j.isReady()&&(e(),!0)}catch(n){return j.lock&&j.lock(),!1}},t.email).show()}function Be(e){const t=new q(()=>{},e=>{const t="auth/user-not-found"===e.code||"auth/invalid-credential"===e.code?"Credenciales incorrectas.":e.message||"Error del sistema";$.show(t,"error")});e.innerHTML='\n    <div class="min-h-screen flex flex-col justify-center items-center bg-slate-50 px-4 sm:px-6 relative overflow-hidden">\n      <div class="absolute inset-0 bg-[url(\'https://grainy-gradients.vercel.app/noise.svg\')] opacity-20"></div>\n      \n      <div class="w-full max-w-md relative z-10">\n        <div class="text-center mb-10">\n            <div class="inline-flex items-center justify-center w-14 h-14 rounded-2xl bg-brand-600 text-white shadow-lg shadow-brand-500/30 mb-4">\n               <i class="fas fa-shield-halved text-2xl"></i>\n            </div>\n            <h1 class="text-3xl font-bold text-slate-900 tracking-tight">Mi Gesti√≥n</h1>\n            <p class="text-slate-500 mt-2 font-medium">B√≥veda Digital Segura</p>\n        </div>\n        <div id="authContainer"></div>\n      </div>\n      \n      <div class="mt-12 text-center">\n        <p class="text-xs font-semibold text-slate-400 uppercase tracking-widest">\n          <i class="fas fa-lock text-emerald-500 mr-1"></i> Encriptaci√≥n E2EE Militar\n        </p>\n      </div>\n    </div>',t.updateView(document.getElementById("authContainer"))}function je(e){const t=document.getElementById("dynamicContent");if(!t)return;t.innerHTML='\n    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-end mb-8 gap-4 border-b border-slate-200 pb-6">\n      <div>\n        <h2 class="text-2xl sm:text-3xl font-bold text-slate-900 tracking-tight">Mis Documentos</h2>\n        <p class="text-slate-500 text-sm mt-1">Gestiona y protege tu informaci√≥n personal.</p>\n      </div>\n      <div class="flex items-center gap-3 w-full sm:w-auto">\n          <button id="btnSettings" class="p-2.5 bg-white text-slate-500 hover:text-brand-600 border border-slate-300 rounded-lg hover:border-brand-500 transition-all shadow-sm" title="Configuraci√≥n">\n             <i class="fas fa-cog text-lg"></i>\n          </button>\n          <button id="btnNewDocVault" class="flex-1 sm:flex-none px-5 py-2.5 bg-brand-600 hover:bg-brand-700 text-white text-sm font-semibold rounded-lg shadow-md shadow-brand-500/20 transition-all flex items-center justify-center gap-2">\n              <i class="fas fa-plus"></i>\n              <span>Nuevo Documento</span>\n          </button>\n      </div>\n    </div>\n    <div id="vaultListContainer"></div>\n  ';const n=new Ee(t=>De(()=>Me(t,e)),()=>De(()=>Ae(e)));document.getElementById("btnNewDocVault")?.addEventListener("click",()=>n.onNewDocument()),document.getElementById("btnSettings")?.addEventListener("click",()=>function(e){const t=document.getElementById("dynamicContent");t.innerHTML='\n    <div class="max-w-3xl mx-auto animate-fade-in">\n        <button id="backToDash" class="mb-6 flex items-center text-slate-500 hover:text-brand-600 transition-colors font-medium text-sm">\n            <i class="fas fa-arrow-left mr-2"></i> Volver\n        </button>\n        <div id="settingsContainer"></div>\n    </div>';const n=new Le;document.getElementById("settingsContainer").innerHTML=n.render(),n.setupEventListeners(),document.getElementById("backToDash").onclick=()=>je(e)}(e)),n.loadDocuments()}function Me(e,t){document.getElementById("dynamicContent").innerHTML='\n    <div id="documentViewerPlaceholder" class="max-w-4xl mx-auto bg-white rounded-xl shadow-card border border-slate-200 p-8 min-h-[400px]">\n        <div class="animate-pulse flex space-x-6">\n            <div class="w-16 h-16 bg-slate-100 rounded-lg"></div>\n            <div class="flex-1 space-y-4 py-1">\n                <div class="h-6 bg-slate-100 rounded w-1/3"></div>\n                <div class="space-y-3">\n                    <div class="h-4 bg-slate-100 rounded"></div>\n                    <div class="h-4 bg-slate-100 rounded w-5/6"></div>\n                </div>\n            </div>\n        </div>\n    </div>';const n=new ke(e,e=>{e?function(e,t){const n=document.getElementById("dynamicContent"),s=new ye(e,()=>Me(e.documentId,t),()=>Me(e.documentId,t));n.innerHTML='<div id="editorContainer" class="max-w-4xl mx-auto animate-slide-up"></div>',document.getElementById("editorContainer").innerHTML=s.render(),s.setupEventListeners()}(e,t):je(t)}),s=document.getElementById("documentViewerPlaceholder");s&&(s.outerHTML=n.render()),n.load()}function Ae(e){const t=document.getElementById("dynamicContent"),n=new oe(t=>async function(e,t){const n=document.getElementById("dynamicContent");n.innerHTML='\n    <div class="flex flex-col justify-center items-center h-64 gap-4">\n        <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-brand-600"></div>\n        <p class="text-slate-500 font-medium text-sm">Preparando editor seguro...</p>\n    </div>';try{const s=await V.getTemplateById(e),a=new ye({template:s},e=>{e?Me(e,t):je(t)},()=>Ae(t));n.innerHTML='<div id="editorContainer" class="max-w-4xl mx-auto animate-slide-up"></div>',document.getElementById("editorContainer").innerHTML=a.render(),a.setupEventListeners()}catch(s){alert("Error cargando plantilla"),Ae(t)}}(t,e));t.innerHTML='\n    <div class="max-w-6xl mx-auto animate-fade-in">\n        <button id="backToDash" class="mb-6 flex items-center text-slate-500 hover:text-brand-600 transition-colors font-medium text-sm">\n            <i class="fas fa-arrow-left mr-2"></i> Volver a Documentos\n        </button>\n        <div id="tmContainer"></div>\n    </div>',document.getElementById("tmContainer").innerHTML=n.render(),document.getElementById("backToDash").onclick=()=>je(e),V.initialize(e.uid),n.loadTemplates()}document.addEventListener("DOMContentLoaded",()=>{!async function(){const e=document.getElementById("app");if(!e)return;M.subscribe(async t=>{await Te(t,e)});const t=M.getCurrentUser();await Te(t,e)}()}),window.app={requireEncryption:De};
