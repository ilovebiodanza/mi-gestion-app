import{initializeApp as e}from"https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";import{getAuth as t,EmailAuthProvider as n,reauthenticateWithCredential as a,onAuthStateChanged as r,updatePassword as s,sendPasswordResetEmail as i,signOut as o,signInWithEmailAndPassword as l,createUserWithEmailAndPassword as d}from"https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";import{getFirestore as c,deleteDoc as u,orderBy as m,query as p,getDocs as g,collection as h,getDoc as y,setDoc as f,doc as b}from"https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const n of e)if("childList"===n.type)for(const e of n.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const v=e({apiKey:"AIzaSyBJgDqHiHD8mncuRNlw8eA1ismr_fcvj2E",authDomain:"mi-gestion-e2ee.firebaseapp.com",projectId:"mi-gestion-e2ee",storageBucket:"mi-gestion-e2ee.firebasestorage.app",messagingSenderId:"97671435614",appId:"1:97671435614:web:e0f35d92692ca1e63b2bcf",measurementId:"G-GLYJSXBC8E"}),x=t(v),w=c(v);window.firebaseModules={app:v,auth:x,db:w,createUserWithEmailAndPassword:d,signInWithEmailAndPassword:l,signOut:o,sendPasswordResetEmail:i,updatePassword:s,onAuthStateChanged:r,reauthenticateWithCredential:a,EmailAuthProvider:n,getFirestore:c,doc:b,setDoc:f,getDoc:y,collection:h,getDocs:g,query:p,orderBy:m,deleteDoc:u};const E=new class{constructor(){if(!window.firebaseModules)throw new Error("Firebase no est√° inicializado. Recarga la p√°gina.");this.modules=window.firebaseModules,this.auth=this.modules.auth,this.db=this.modules.db,this.app=this.modules.app}_cleanObject(e){if("object"!=typeof e||null===e)return e;if(Array.isArray(e))return e.map(e=>this._cleanObject(e));const t={};for(const n in e)if(e.hasOwnProperty(n)){const a=e[n];void 0!==a&&(t[n]=this._cleanObject(a))}return t}getAuth(){return this.auth}getFirestore(){return this.db}getApp(){return this.app}async createUser(e,t){return this.modules.createUserWithEmailAndPassword(this.auth,e,t)}async signIn(e,t){return this.modules.signInWithEmailAndPassword(this.auth,e,t)}async signOut(){return this.modules.signOut(this.auth)}async resetPassword(e){return this.modules.sendPasswordResetEmail(this.auth,e)}async updatePassword(e,t){return this.modules.updatePassword(e,t)}onAuthStateChanged(e){return this.modules.onAuthStateChanged(this.auth,e)}getDoc(e){return this.modules.getDoc(e)}setDoc(e,t,n){const a=this._cleanObject(t);return this.modules.setDoc(e,a,n)}deleteDoc(e){return this.modules.deleteDoc(e)}doc(e){return this.modules.doc(this.db,e)}};async function T(e,t){try{const n=(new TextEncoder).encode(e),a=await crypto.subtle.importKey("raw",n,"PBKDF2",!1,["deriveKey"]),r=await crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:1e5,hash:"SHA-256"},a,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),s=await crypto.subtle.exportKey("raw",r);return new Uint8Array(s)}catch(n){throw n}}async function S(e,t,n=null){try{const a=JSON.stringify(e),r=(new TextEncoder).encode(a),s=function(){const e=new Uint8Array(12);return crypto.getRandomValues(e),e}(),i=await L(t),o={name:"AES-GCM",iv:s,tagLength:128};if(n){const e=String(n);o.additionalData=(new TextEncoder).encode(e)}const l=await crypto.subtle.encrypt(o,i,r),d=new Uint8Array(l),c=btoa(String.fromCharCode(...d));return{content:c,iv:btoa(String.fromCharCode(...s)),algorithm:"AES-GCM-256",timestamp:(new Date).toISOString()}}catch(a){throw a}}async function I(e,t,n=null){try{const a=Uint8Array.from(atob(e.content),e=>e.charCodeAt(0)),r=Uint8Array.from(atob(e.iv),e=>e.charCodeAt(0)),s=await L(t),i={name:"AES-GCM",iv:r,tagLength:128};if(n){const e=String(n);i.additionalData=(new TextEncoder).encode(e)}const o=await crypto.subtle.decrypt(i,s,a),l=(new TextDecoder).decode(o);return JSON.parse(l)}catch(a){if("OperationError"===a.name||a.message.includes("decryption"))throw new Error("Contrase√±a incorrecta o datos corruptos");throw a}}async function L(e){return crypto.subtle.importKey("raw",e,{name:"AES-GCM"},!1,["encrypt","decrypt"])}async function C(e,t,n=null){try{const a=n||"doc_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),r=function(){const e=new Uint8Array(32);return crypto.getRandomValues(e),e}(),s=await S(e,r),i=await S(Array.from(r),t,a);return{content:s,metadata:{itemKey:i,documentId:a,contentHash:await $(e),encryptedAt:(new Date).toISOString(),version:"1.0"}}}catch(a){throw a}}async function D(e,t){try{const n=await I(e.metadata.itemKey,t,e.metadata.documentId||"item_key"),a=new Uint8Array(n),r=await I(e.content,a);await $(r);return e.metadata.contentHash,r}catch(n){if(n.message&&n.message.includes("Contrase√±a incorrecta"))throw new Error("No se puede descifrar: contrase√±a incorrecta o datos corruptos");throw n}}async function $(e){const t=JSON.stringify(e),n=(new TextEncoder).encode(t),a=await crypto.subtle.digest("SHA-256",n);return Array.from(new Uint8Array(a)).map(e=>e.toString(16).padStart(2,"0")).join("")}const B=new class{constructor(){this.isInitialized=!1,this.masterKey=null,this.salt=null}async initialize(e){try{const t=E.getAuth().currentUser;if(!t)throw new Error("Usuario no autenticado para iniciar cifrado");return this.salt=await this.getOrCreateSalt(t.uid),this.masterKey=await T(e,this.salt),this.isInitialized=!0,!0}catch(t){throw t}}async getOrCreateSalt(e){const t=`encryption_salt_${e}`;let n=null;try{const a=E.doc(`artifacts/mi-gestion-v1/users/${e}/metadata/encryption`),r=await E.getDoc(a);if(r.exists()&&r.data().salt){const e=r.data().salt,a=Object.values(e);return n=new Uint8Array(a.length>0?a:e),localStorage.setItem(t,JSON.stringify(Array.from(n))),n}}catch(s){}const a=localStorage.getItem(t)||localStorage.getItem("encryption_salt");if(a)return n=new Uint8Array(JSON.parse(a)),await this.saveSaltToFirestore(e,n),n;const r=function(e=16){const t=new Uint8Array(e);return crypto.getRandomValues(t),t}();return localStorage.setItem(t,JSON.stringify(Array.from(r))),await this.saveSaltToFirestore(e,r),r}async saveSaltToFirestore(e,t){try{const n=E.doc(`artifacts/mi-gestion-v1/users/${e}/metadata/encryption`);await E.setDoc(n,{salt:Array.from(t),updatedAt:(new Date).toISOString()},{merge:!0})}catch(n){}}async encryptDocument(e,t=null){if(!this.isInitialized)throw new Error("Cifrado no inicializado");return C(e,this.masterKey,t)}async decryptDocument(e){if(!this.isInitialized)throw new Error("Cifrado no inicializado");return D(e,this.masterKey)}async encryptField(e,t){if(!this.isInitialized)throw new Error("Cifrado no inicializado");return async function(e,t,n){return S({value:e,field:n,timestamp:(new Date).toISOString()},t,n)}(e,this.masterKey,t)}async decryptField(e,t){if(!this.isInitialized)throw new Error("Cifrado no inicializado");return async function(e,t,n){return(await I(e,t,n)).value}(e,this.masterKey,t)}isReady(){return this.isInitialized&&null!==this.masterKey}getStatus(){return{isInitialized:this.isInitialized,hasMasterKey:null!==this.masterKey,algorithm:"PBKDF2 + AES-GCM-256"}}clearKeys(){this.masterKey=null,this.isInitialized=!1}};const F=new class{constructor(){this.currentUser=null,this.authListeners=[],this.initAuthListener()}initAuthListener(){E.onAuthStateChanged(async e=>{this.currentUser=e,this.notifyAuthListeners(e),e&&await this.initializeNewUser(e)})}async initializeNewUser(e){try{const t=(await e.getIdTokenResult()).claims.isNewUser||!1,n=await this.getUserRole();!t&&n||await this.createUserProfile(e)}catch(t){}}async createUserProfile(e){try{const t={email:e.email,role:"user",createdAt:(new Date).toISOString(),lastLogin:(new Date).toISOString(),settings:{theme:"auto",language:"es",autoLock:30}};localStorage.setItem(`user_profile_${e.uid}`,JSON.stringify(t));const n=E.doc(`artifacts/mi-gestion-v1/users/${e.uid}/metadata/user_config`);return await E.setDoc(n,t,{merge:!0}),t}catch(t){throw t}}async getUserRole(){if(!this.currentUser)return null;const e=localStorage.getItem(`user_profile_${this.currentUser.uid}`);if(e){const t=JSON.parse(e);if(t.role)return t.role}try{const e=E.doc(`artifacts/mi-gestion-v1/users/${this.currentUser.uid}/metadata/user_config`),t=await E.getDoc(e);if(t.exists()){const e=t.data();return localStorage.setItem(`user_profile_${this.currentUser.uid}`,JSON.stringify(e)),e.role||"user"}}catch(t){}return"user"}async register(e,t){try{const a=await E.createUser(e,t);try{await this.initializeEncryption(t)}catch(n){}return await this.createUserProfile(a.user),{success:!0,user:a.user,message:"Usuario registrado exitosamente"}}catch(a){return{success:!1,error:this.getErrorMessage(a.code),code:a.code}}}async login(e,t){try{const a=await E.signIn(e,t);try{await this.initializeEncryption(t)}catch(n){}return this.getUserRole(),{success:!0,user:a.user,message:"Sesi√≥n iniciada exitosamente"}}catch(a){return{success:!1,error:this.getErrorMessage(a.code),code:a.code}}}async logout(){try{return this.clearEncryption(),this.clearSensitiveData(),await E.signOut(),{success:!0,message:"Sesi√≥n cerrada exitosamente"}}catch(e){return{success:!1,error:"Error al cerrar sesi√≥n",code:e.code}}}async resetPassword(e){try{return await E.resetPassword(e),{success:!0,message:"Correo de restablecimiento enviado"}}catch(t){return{success:!1,error:this.getErrorMessage(t.code),code:t.code}}}async changePassword(e,t){try{const a=this.currentUser;if(!a)throw new Error("Usuario no autenticado");if(!t)throw new Error("Se requiere la contrase√±a actual para migrar los datos.");const{updatePassword:r,reauthenticateWithCredential:s,EmailAuthProvider:i,collection:o,getDocs:l,query:d}=E.modules,c=await B.getOrCreateSalt(a.uid),u=await T(t,c),m=await T(e,c),p=`artifacts/mi-gestion-v1/users/${a.uid}/vault`,g=d(o(E.db,p)),h=await l(g),y=[];h.forEach(e=>{const t=e.data();y.push((async()=>{try{const n=await D({content:t.encryptedContent,metadata:t.encryptionMetadata},u),a=await C(n,m,t.id),r={encryptedContent:a.content,encryptionMetadata:a.metadata,"metadata.updatedAt":(new Date).toISOString()};await E.setDoc(e.ref,r,{merge:!0})}catch(n){throw new Error(`Error migrando datos: ${n.message}`)}})())}),y.length>0&&await Promise.all(y);try{await r(a,e)}catch(n){if("auth/requires-recent-login"!==n.code)throw n;{const n=i.credential(a.email,t);await s(a,n),await r(a,e)}}return await B.initialize(e),{success:!0,message:"Contrase√±a actualizada y datos migrados exitosamente"}}catch(n){return{success:!1,error:"No se pudo completar el cambio. Tus datos NO se han modificado. Error: "+n.message,code:n.code}}}getErrorMessage(e){return{"auth/email-already-in-use":"Este correo ya est√° registrado.","auth/invalid-email":"Correo electr√≥nico no v√°lido","auth/weak-password":"La contrase√±a es demasiado d√©bil","auth/wrong-password":"Contrase√±a incorrecta.","auth/requires-recent-login":"Por seguridad, confirma tu contrase√±a actual."}[e]||`Error: ${e}`}clearSensitiveData(){["master_key","encryption_keys","user_session_data","temp_encryption_data"].forEach(e=>{localStorage.removeItem(e),sessionStorage.removeItem(e)});const e=this.currentUser;e&&localStorage.removeItem(`user_profile_${e.uid}`)}subscribe(e){return this.authListeners.push(e),e(this.currentUser),()=>{this.authListeners=this.authListeners.filter(t=>t!==e)}}notifyAuthListeners(e){this.authListeners.forEach(t=>{try{t(e)}catch(n){}})}getCurrentUser(){return this.currentUser}isAuthenticated(){return!!this.currentUser}async getAuthToken(){return this.currentUser?await this.currentUser.getIdToken():null}async initializeEncryption(e){try{return await B.initialize(e),localStorage.setItem("encryption_initialized","true"),!0}catch(t){throw new Error("Error al configurar el cifrado seguro")}}clearEncryption(){B.clearKeys(),localStorage.removeItem("encryption_initialized")}isEncryptionInitialized(){return B.isReady()}};class P{constructor(e){this.onAuthSuccess=e,this.currentForm="login"}renderLoginForm(){return'\n      <div class="max-w-md mx-auto bg-white rounded-xl shadow-lg overflow-hidden p-8">\n        <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">Iniciar Sesi√≥n</h2>\n\n        <form id="loginForm" class="space-y-5">\n          <div>\n            <label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-1">\n              Correo Electr√≥nico\n            </label>\n            <input\n              type="email"\n              id="loginEmail"\n              required\n              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"\n              placeholder="tu@ejemplo.com"\n            />\n          </div>\n\n          <div>\n            <div class="flex justify-between items-center mb-1">\n              <label for="loginPassword" class="block text-sm font-medium text-gray-700">\n                Contrase√±a\n              </label>\n              <button type="button" id="forgotPasswordBtn" class="text-xs text-blue-600 hover:text-blue-800 font-medium">\n                ¬øOlvidaste tu contrase√±a?\n              </button>\n            </div>\n            <input\n              type="password"\n              id="loginPassword"\n              required\n              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"\n              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"\n            />\n          </div>\n\n          <button\n            type="submit"\n            class="w-full bg-blue-600 text-white py-2.5 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition font-medium shadow-sm"\n          >\n            Entrar\n          </button>\n        </form>\n\n        <div class="mt-6 text-center pt-4 border-t border-gray-100">\n          <p class="text-sm text-gray-600">\n            ¬øNo tienes cuenta?\n            <button id="switchToRegister" class="text-blue-600 hover:text-blue-800 font-medium ml-1">\n              Reg√≠strate gratis\n            </button>\n          </p>\n        </div>\n      </div>\n    '}renderRegisterForm(){return'\n      <div class="max-w-md mx-auto bg-white rounded-xl shadow-lg overflow-hidden p-8">\n        <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">Crear Cuenta</h2>\n\n        <form id="registerForm" class="space-y-5">\n          <div>\n            <label for="registerEmail" class="block text-sm font-medium text-gray-700 mb-1">\n              Correo Electr√≥nico\n            </label>\n            <input\n              type="email"\n              id="registerEmail"\n              required\n              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"\n              placeholder="tu@ejemplo.com"\n            />\n          </div>\n\n          <div>\n            <label for="registerPassword" class="block text-sm font-medium text-gray-700 mb-1">\n              Contrase√±a\n            </label>\n            <input\n              type="password"\n              id="registerPassword"\n              required\n              minlength="8"\n              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"\n              placeholder="M√≠nimo 8 caracteres"\n            />\n          </div>\n\n          <div>\n            <label for="registerConfirmPassword" class="block text-sm font-medium text-gray-700 mb-1">\n              Confirmar Contrase√±a\n            </label>\n            <input\n              type="password"\n              id="registerConfirmPassword"\n              required\n              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"\n              placeholder="Repite tu contrase√±a"\n            />\n          </div>\n\n          <div class="bg-blue-50 border border-blue-100 rounded-lg p-3">\n            <div class="flex">\n              <i class="fas fa-info-circle text-blue-500 mt-0.5 mr-2"></i>\n              <p class="text-xs text-blue-700">\n                La contrase√±a cifrar√° tus datos. Si la olvidas, <strong>no podremos recuperarlos</strong>.\n              </p>\n            </div>\n          </div>\n\n          <button\n            type="submit"\n            class="w-full bg-green-600 text-white py-2.5 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition font-medium shadow-sm"\n          >\n            Registrarse\n          </button>\n        </form>\n\n        <div class="mt-6 text-center pt-4 border-t border-gray-100">\n          <p class="text-sm text-gray-600">\n            ¬øYa tienes cuenta?\n            <button id="switchToLogin" class="text-blue-600 hover:text-blue-800 font-medium ml-1">\n              Inicia sesi√≥n\n            </button>\n          </p>\n        </div>\n      </div>\n    '}renderForgotPasswordForm(){return'\n      <div class="max-w-md mx-auto bg-white rounded-xl shadow-lg overflow-hidden p-8">\n        <h2 class="text-2xl font-bold text-gray-800 text-center mb-2">Recuperar Acceso</h2>\n        <p class="text-gray-500 text-center text-sm mb-6">Te enviaremos un enlace para restablecer tu contrase√±a</p>\n\n        <form id="forgotPasswordForm" class="space-y-5">\n          <div>\n            <label for="resetEmail" class="block text-sm font-medium text-gray-700 mb-1">\n              Correo Electr√≥nico\n            </label>\n            <input\n              type="email"\n              id="resetEmail"\n              required\n              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"\n              placeholder="tu@ejemplo.com"\n            />\n          </div>\n\n          <div class="bg-yellow-50 border border-yellow-100 rounded-lg p-3">\n            <div class="flex">\n              <i class="fas fa-exclamation-triangle text-yellow-500 mt-0.5 mr-2"></i>\n              <p class="text-xs text-yellow-700">\n                Al cambiar la contrase√±a, perder√°s acceso a los datos cifrados anteriormente.\n              </p>\n            </div>\n          </div>\n\n          <div class="flex space-x-3">\n            <button\n              type="button"\n              id="cancelReset"\n              class="flex-1 bg-gray-100 text-gray-700 py-2.5 px-4 rounded-lg hover:bg-gray-200 transition font-medium"\n            >\n              Cancelar\n            </button>\n            <button\n              type="submit"\n              class="flex-1 bg-blue-600 text-white py-2.5 px-4 rounded-lg hover:bg-blue-700 transition font-medium shadow-sm"\n            >\n              Enviar\n            </button>\n          </div>\n        </form>\n      </div>\n    '}render(){switch(this.currentForm){case"login":default:return this.renderLoginForm();case"register":return this.renderRegisterForm();case"forgot":return this.renderForgotPasswordForm()}}setupEventListeners(e){switch(this.setupRealTimeValidation(e),this.currentForm){case"login":this.setupLoginListeners(e);break;case"register":this.setupRegisterListeners(e);break;case"forgot":this.setupForgotPasswordListeners(e)}}setupLoginListeners(e){const t=e.querySelector("#loginForm"),n=e.querySelector("#switchToRegister"),a=e.querySelector("#forgotPasswordBtn");t&&t.addEventListener("submit",this.handleLogin.bind(this)),n&&n.addEventListener("click",()=>{this.currentForm="register",this.updateView(e)}),a&&a.addEventListener("click",()=>{this.currentForm="forgot",this.updateView(e)})}setupRegisterListeners(e){const t=e.querySelector("#registerForm"),n=e.querySelector("#switchToLogin");t&&t.addEventListener("submit",this.handleRegister.bind(this)),n&&n.addEventListener("click",()=>{this.currentForm="login",this.updateView(e)})}setupForgotPasswordListeners(e){const t=e.querySelector("#forgotPasswordForm"),n=e.querySelector("#cancelReset");t&&t.addEventListener("submit",this.handleForgotPassword.bind(this)),n&&n.addEventListener("click",()=>{this.currentForm="login",this.updateView(e)})}async handleLogin(e){e.preventDefault();const t=document.getElementById("loginEmail").value,n=document.getElementById("loginPassword").value;if(t&&n){this.showLoading(!0);try{const e=await F.login(t,n);e.success?window.app&&window.app.initializePostLogin&&window.app.initializePostLogin(e.user,n):(this.showError(e.error||"Error en login"),this.showLoading(!1))}catch(a){this.showError("Error inesperado. Intenta nuevamente."),this.showLoading(!1)}}else this.showError("Por favor completa todos los campos")}async handleRegister(e){e.preventDefault();const t=document.getElementById("registerEmail").value,n=document.getElementById("registerPassword").value,a=document.getElementById("registerConfirmPassword").value;if(t&&n&&a)if(n===a)if(n.length<8)this.showError("La contrase√±a debe tener al menos 8 caracteres");else{this.showLoading(!0);try{const e=await F.register(t,n);e.success||(this.showError(e.error||"Error en registro"),this.showLoading(!1))}catch(r){this.showError("Error inesperado. Intenta nuevamente."),this.showLoading(!1)}}else this.showError("Las contrase√±as no coinciden");else this.showError("Por favor completa todos los campos")}async handleForgotPassword(e){e.preventDefault();const t=document.getElementById("resetEmail").value;if(t){this.showLoading(!0);try{const e=await F.resetPassword(t);e.success?(this.showMessage(e.message,"success"),setTimeout(()=>{this.currentForm="login",this.updateView(document.getElementById("authContainer"))},3e3)):(this.showError(e.error||"Error al enviar correo"),this.showLoading(!1))}catch(n){this.showError("Error inesperado. Intenta nuevamente."),this.showLoading(!1)}}else this.showError("Por favor ingresa tu correo electr√≥nico")}updateView(e){e&&(e.innerHTML=this.render(),this.setupEventListeners(e))}showLoading(e){const t=document.querySelectorAll('button[type="submit"]'),n=document.querySelectorAll("#authContainer input");t.forEach(t=>{e?(t.dataset.originalText||(t.dataset.originalText=t.innerHTML),t.innerHTML='<div class="spinner inline-block mr-2"></div> Procesando...',t.disabled=!0,t.classList.add("opacity-70","cursor-not-allowed")):(t.dataset.originalText&&(t.innerHTML=t.dataset.originalText,delete t.dataset.originalText),t.disabled=!1,t.classList.remove("opacity-70","cursor-not-allowed"))}),n.forEach(t=>{t.disabled=e,e?t.classList.add("bg-gray-50"):t.classList.remove("bg-gray-50")})}showError(e,t=5e3){this.clearMessages();const n=document.createElement("div");n.className="error-message animate-fade-in mb-4 p-3 bg-red-50 border-l-4 border-red-500 rounded-r text-red-700 text-sm flex items-center",n.innerHTML=`<i class="fas fa-exclamation-circle mr-2"></i> ${e}`;const a=document.querySelector("#authContainer form");a&&(a.parentElement.insertBefore(n,a),t>0&&setTimeout(()=>n.remove(),t))}showMessage(e,t="success",n=5e3){this.clearMessages();const a="success"===t?"green":"blue",r="success"===t?"fa-check-circle":"fa-info-circle",s=document.createElement("div");s.className=`success-message animate-fade-in mb-4 p-3 bg-${a}-50 border-l-4 border-${a}-500 rounded-r text-${a}-700 text-sm flex items-center`,s.innerHTML=`<i class="fas ${r} mr-2"></i> ${e}`;const i=document.querySelector("#authContainer form");i&&(i.parentElement.insertBefore(s,i),n>0&&setTimeout(()=>s.remove(),n))}clearMessages(){document.querySelectorAll(".error-message, .success-message").forEach(e=>e.remove())}setupRealTimeValidation(e){e.querySelectorAll("input").forEach(e=>{e.addEventListener("input",()=>{e.classList.remove("border-red-500")})})}}class k{constructor(e,t){this.onPasswordSubmit=e,this.userEmail=t,this.isSubmitting=!1}render(){return`\n      <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">\n        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 animate-fade-in">\n          <div class="text-center mb-6">\n            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">\n              <i class="fas fa-shield-alt text-blue-600 text-2xl"></i>\n            </div>\n            <h3 class="text-xl font-bold text-gray-800">Cifrado de Seguridad</h3>\n            <p class="text-gray-600 mt-2">Ingresa tu contrase√±a para activar el cifrado</p>\n          </div>\n          \n          <div class="space-y-4">\n            <div>\n              <label class="block text-sm font-medium text-gray-700 mb-1">\n                <i class="fas fa-user mr-1"></i>\n                Usuario\n              </label>\n              <input\n                type="text"\n                value="${this.userEmail}"\n                disabled\n                class="w-full px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-600"\n              />\n            </div>\n            \n            <div>\n              <label class="block text-sm font-medium text-gray-700 mb-1">\n                <i class="fas fa-key mr-1"></i>\n                Contrase√±a\n              </label>\n              <input\n                type="password"\n                id="encryptionPassword"\n                placeholder="Ingresa tu contrase√±a"\n                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"\n                autocomplete="current-password"\n              />\n              <p class="text-xs text-gray-500 mt-1">\n                Tu contrase√±a se usa solo para generar claves de cifrado localmente.\n              </p>\n            </div>\n            \n            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">\n              <h4 class="font-medium text-yellow-800 mb-2">\n                <i class="fas fa-info-circle mr-1"></i>\n                Importante\n              </h4>\n              <ul class="text-sm text-yellow-700 space-y-1">\n                <li>‚Ä¢ Sin la contrase√±a correcta, no podr√°s acceder a tus datos cifrados</li>\n                <li>‚Ä¢ La contrase√±a nunca sale de tu dispositivo</li>\n                <li>‚Ä¢ Si la olvidas, perder√°s acceso a tus datos cifrados</li>\n              </ul>\n            </div>\n            \n            <div class="flex space-x-3 pt-2">\n              <button\n                id="cancelEncryption"\n                class="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300 transition font-medium"\n              >\n                Omitir por ahora\n              </button>\n              <button\n                id="submitEncryptionPassword"\n                class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition font-medium flex items-center justify-center"\n              >\n                <span id="submitText">Activar Cifrado</span>\n                <div id="submitSpinner" class="hidden ml-2">\n                  <div class="spinner-small"></div>\n                </div>\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n      \n      <style>\n        .animate-fade-in {\n          animation: fadeIn 0.3s ease-out;\n        }\n        @keyframes fadeIn {\n          from { opacity: 0; transform: translateY(-20px); }\n          to { opacity: 1; transform: translateY(0); }\n        }\n        .spinner-small {\n          display: inline-block;\n          width: 1rem;\n          height: 1rem;\n          border: 2px solid rgba(255, 255, 255, 0.3);\n          border-radius: 50%;\n          border-top-color: #fff;\n          animation: spin 1s ease-in-out infinite;\n        }\n        @keyframes spin {\n          to { transform: rotate(360deg); }\n        }\n      </style>\n    `}show(){const e=document.createElement("div");e.id="encryptionPromptOverlay",e.innerHTML=this.render(),document.body.appendChild(e),this.setupEventListeners()}hide(){const e=document.getElementById("encryptionPromptOverlay");e&&e.remove()}setupEventListeners(){const e=document.getElementById("encryptionPassword"),t=document.getElementById("submitEncryptionPassword"),n=document.getElementById("cancelEncryption"),a=document.getElementById("submitText"),r=document.getElementById("submitSpinner");t.addEventListener("click",async()=>{if(this.isSubmitting)return;const n=e.value.trim();if(n){this.isSubmitting=!0,a.textContent="Inicializando...",r.classList.remove("hidden"),t.disabled=!0;try{await this.onPasswordSubmit(n)?this.hide():(this.showError("Contrase√±a incorrecta o error al inicializar cifrado"),this.resetForm())}catch(s){this.showError(s.message||"Error al activar cifrado"),this.resetForm()}}else this.showError("Por favor ingresa tu contrase√±a")}),n.addEventListener("click",()=>{this.hide()}),e.addEventListener("keypress",e=>{"Enter"!==e.key||this.isSubmitting||t.click()});const s=document.getElementById("encryptionPromptOverlay");s.addEventListener("click",e=>{e.target===s&&this.hide()})}showError(e){this.clearErrors();const t=document.createElement("div");t.className="bg-red-50 border border-red-200 rounded-lg p-3 mt-3 animate-fade-in",t.innerHTML=`\n      <div class="flex items-center">\n        <i class="fas fa-exclamation-circle text-red-500 mr-2"></i>\n        <span class="text-red-700 text-sm">${e}</span>\n      </div>\n    `;const n=document.querySelector("#encryptionPromptOverlay .space-y-4"),a=n?.querySelector(".flex.space-x-3");if(n&&a)n.insertBefore(t,a);else{const e=document.querySelector("#encryptionPromptOverlay .bg-white");e&&e.appendChild(t)}}clearErrors(){document.querySelectorAll("#encryptionPromptOverlay .bg-red-50").forEach(e=>e.remove())}resetForm(){this.isSubmitting=!1;const e=document.getElementById("submitText"),t=document.getElementById("submitSpinner"),n=document.getElementById("submitEncryptionPassword");e&&(e.textContent="Activar Cifrado"),t&&t.classList.add("hidden"),n&&(n.disabled=!1);const a=document.getElementById("encryptionPassword");a&&a.focus()}}class A{constructor(e,t="mi-gestion-v1"){this.userId=e,this.appId=t}async loadFromLocalStorage(){const e=`user_templates_${this.userId}`,t=localStorage.getItem(e);return t?JSON.parse(t):[]}async saveToLocalStorage(e){try{if(!this.userId)return;const t=`user_templates_${this.userId}`;localStorage.setItem(t,JSON.stringify(e))}catch(t){}}getTemplatesRef(){if(!this.userId)throw new Error("ID de usuario no definido para Firestore.");return E.doc(`artifacts/${this.appId}/users/${this.userId}/metadata/templates`)}async loadFromFirestore(){try{const e=this.getTemplatesRef(),t=await E.getDoc(e);if(t.exists()){const e=t.data();return e.templates||[]}return[]}catch(e){return null}}async saveToFirestore(e){try{if(!this.userId)return;const t=this.getTemplatesRef(),n={userId:this.userId,appId:this.appId,templates:e,lastUpdated:(new Date).toISOString(),count:e.length};await E.setDoc(t,n,{merge:!0}),await this.saveToLocalStorage(e)}catch(t){throw new Error("Fallo al guardar plantillas en la nube.")}}async migrateToFirestore(){const e=await this.loadFromLocalStorage();return e.length>0?(await this.saveToFirestore(e),{success:!0,migrated:e.length}):{success:!0,migrated:0}}async checkSyncStatus(e){if(!this.userId)return{synced:!1,error:"Usuario no autenticado"};const t=this.getTemplatesRef(),n=await E.getDoc(t);if(n.exists()){const t=n.data(),a=t.templates||[];return{synced:a.length===e.length,localCount:e.length,cloudCount:a.length,cloudTemplates:a,lastUpdated:t.lastUpdated,needsSync:a.length!==e.length}}return{synced:!1,localCount:e.length,cloudCount:0,needsSync:!0,cloudTemplates:[]}}}const M=[{value:"string",label:"Texto corto",inputType:"text"},{value:"text",label:"Texto largo",inputType:"textarea"},{value:"phone",label:"N√∫mero de tel√©fono",inputType:"tel"},{value:"number",label:"N√∫mero",inputType:"number"},{value:"currency",label:"Monto (Moneda)",inputType:"number"},{value:"percentage",label:"Porcentaje",inputType:"number"},{value:"boolean",label:"S√≠/No",inputType:"checkbox"},{value:"date",label:"Fecha",inputType:"date"},{value:"select",label:"Selecci√≥n Simple",inputType:"select"},{value:"url",label:"URL",inputType:"url"},{value:"email",label:"Email",inputType:"email"},{value:"secret",label:"Contrase√±a / Secreto",inputType:"password"}],q=()=>M,N=e=>M.find(t=>t.value===e);const U=new class{getValidFieldTypes(){return q().map(e=>e.value)}generateFieldId(e,t){if(!e||"string"!=typeof e)return`campo_${t+1}`;const n=e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9_$]/g,"_").replace(/_{2,}/g,"_").replace(/^_|_$/g,"");return n&&/^[a-zA-Z_$]/.test(n)?n:`campo_${t+1}`}validateField(e,t){const n=this.getValidFieldTypes();if(!n.includes(e.type))throw new Error(`Tipo de campo inv√°lido: "${e.type}". Tipos v√°lidos: ${n.join(", ")}`);return e.id||(e.id=this.generateFieldId(e.label,t)),!0}validateTemplateData(e){if(!e.name||!e.fields)throw new Error("La plantilla debe tener nombre y campos");if(!Array.isArray(e.fields)||0===e.fields.length)throw new Error("La plantilla debe tener al menos un campo");return e.fields.forEach((e,t)=>{this.validateField(e,t)}),!0}getCategoryName(e){return{personal:"Personal",access:"Accesos",financial:"Financiero",health:"Salud",custom:"Personalizado"}[e]||e}getCategoryIcon(e){return{personal:"üë§",access:"üîê",financial:"üí∞",health:"üè•",custom:"üìã"}[e]||"üìÑ"}};const _=new class{constructor(){this.userId=null,this.appId="mi-gestion-v1",this.userTemplates=[],this.isInitialized=!1,this.storage=null}async initialize(e){this.isInitialized&&this.userId===e||(this.userId=e,this.storage=new A(e,this.appId),await this.loadUserTemplates(),this.isInitialized=!0)}async loadUserTemplates(){try{if(!this.userId)return void(this.userTemplates=[]);let e=await this.storage.loadFromFirestore();null===e&&(e=await this.storage.loadFromLocalStorage()),e&&0!==e.length||(e=this.getDefaultTemplates(),await this.storage.saveToFirestore(e)),this.userTemplates=e}catch(e){this.userTemplates=this.getDefaultTemplates()}}async createTemplate(e){if(!this.userId)throw new Error("Usuario no autenticado");U.validateTemplateData(e);const t={id:`template_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,userId:this.userId,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),...e,settings:{allowDuplicates:!1,maxEntries:0,category:"custom",...e.settings,isSystemTemplate:!1}};return this.userTemplates.push(t),await this.storage.saveToFirestore(this.userTemplates),t}async updateTemplate(e,t){const n=this.userTemplates.findIndex(t=>t.id===e);if(-1===n)throw new Error("Plantilla no encontrada");const a={...this.userTemplates[n],...t};return U.validateTemplateData(a),this.userTemplates[n]={...a,updatedAt:(new Date).toISOString()},await this.storage.saveToFirestore(this.userTemplates),this.userTemplates[n]}async deleteTemplate(e){const t=this.userTemplates.length;if(this.userTemplates=this.userTemplates.filter(t=>t.id!==e),this.userTemplates.length===t)throw new Error("Plantilla no encontrada");return await this.storage.saveToFirestore(this.userTemplates),{success:!0,message:"Plantilla eliminada"}}async getUserTemplates(){if(!this.isInitialized)throw new Error("Servicio no inicializado");return 0===this.userTemplates.length?this.getDefaultTemplates():this.userTemplates}async getTemplateById(e){return this.userTemplates.find(t=>t.id===e)||null}async getCategories(){const e=await this.getUserTemplates();return[...new Set(e.map(e=>e.settings.category))].map(t=>({id:t,count:e.filter(e=>e.settings.category===t).length}))}getDefaultTemplates(){return[{id:"tpl_default_access",name:"Accesos y Contrase√±as",description:"Gesti√≥n segura de credenciales",icon:"üîê",color:"#F59E0B",settings:{category:"access",allowDuplicates:!0},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),fields:[{id:"f_site",label:"Sitio / Aplicaci√≥n",type:"string",order:1,required:!0},{id:"f_user",label:"Usuario / Email",type:"string",order:2,required:!1},{id:"f_pass",label:"Contrase√±a",type:"secret",order:3,required:!0},{id:"f_url",label:"URL de acceso",type:"url",order:4,required:!1},{id:"f_notes",label:"Notas adicionales",type:"text",order:5,required:!1}]},{id:"tpl_default_health",name:"Historial M√©dico",description:"Registro b√°sico de salud",icon:"‚öïÔ∏è",color:"#EF4444",settings:{category:"health",allowDuplicates:!1},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),fields:[{id:"f_blood",label:"Tipo de Sangre",type:"string",order:1,required:!1},{id:"f_allergies",label:"Alergias",type:"text",order:2,required:!1},{id:"f_meds",label:"Medicaci√≥n Actual",type:"text",order:3,required:!1},{id:"f_contact",label:"Contacto Emergencia",type:"string",order:4,required:!0}]},{id:"tpl_default_finance",name:"Tarjeta de Cr√©dito",description:"Datos de tarjetas bancarias",icon:"üí≥",color:"#10B981",settings:{category:"financial",allowDuplicates:!0},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),fields:[{id:"f_bank",label:"Banco / Emisor",type:"string",order:1,required:!0},{id:"f_number",label:"N√∫mero de Tarjeta",type:"secret",order:2,required:!0},{id:"f_exp",label:"Vencimiento (MM/AA)",type:"string",order:3,required:!0},{id:"f_cvv",label:"CVV",type:"secret",order:4,required:!0},{id:"f_pin",label:"PIN Cajero",type:"secret",order:5,required:!1}]}]}async checkSyncStatus(){return this.storage.checkSyncStatus(this.userTemplates)}async syncTemplates(){const e=await this.storage.checkSyncStatus(this.userTemplates);if(e.needsSync){if(e.cloudCount>e.localCount)return this.userTemplates=e.cloudTemplates,await this.storage.saveToLocalStorage(this.userTemplates),{synced:!0,message:`Descargadas ${e.cloudCount} plantillas.`};if(e.localCount>e.cloudCount)return await this.storage.saveToFirestore(this.userTemplates),{synced:!0,message:`Subidas ${e.localCount} plantillas.`}}return{synced:!0,message:"Sincronizado."}}},j=Object.freeze(Object.defineProperty({__proto__:null,templateService:_},Symbol.toStringTag,{value:"Module"})),O={"es-VE":{moneda:"Bol√≠var",codigo:"VES"},"es-ES":{moneda:"Euro",codigo:"EUR"},"en-US":{moneda:"D√≥lar estadounidense",codigo:"USD"},"en-GB":{moneda:"Libra esterlina",codigo:"GBP"},"fr-FR":{moneda:"Euro",codigo:"EUR"},"pt-BR":{moneda:"Real brasile√±o",codigo:"BRL"},es:{moneda:"D√≥lar estadounidense",codigo:"USD"},"es-419":{moneda:"D√≥lar estadounidense",codigo:"USD"},"es-AR":{moneda:"Peso argentino",codigo:"ARS"},"es-CO":{moneda:"Peso colombiano",codigo:"COP"},"es-MX":{moneda:"Peso mexicano",codigo:"MXN"}},R=()=>{const e=navigator.language;if(O[e])return{locale:e,...O[e]};const t=e.split("-")[0];return O[t]?{locale:t,...O[t]}:{locale:"en-US",...O["en-US"]}},z=(e,t)=>{if(!e||"string"!=typeof e)return`campo_${t+1}`;const n=e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9_$]/g,"_").replace(/_{2,}/g,"_").replace(/^_|_$/g,"");return n&&/^[a-zA-Z_$]/.test(n)?n:`campo_${t+1}`},H=e=>({personal:"Personal",access:"Accesos",financial:"Financiero",health:"Salud",home:"Hogar",car:"Veh√≠culo",job:"Trabajo",education:"Formaci√≥n",custom:"Personalizado",all:"Todas"}[e]||e),V=e=>({personal:"üë§",access:"üîê",financial:"üí∞",health:"üè•",home:"üè†",car:"üöó",job:"üíº",education:"üéì",custom:"üìã"}[e]||"üìÑ");class G{constructor(e){this.onTemplateSelect=e,this.currentView="list",this.editingTemplate=null,this.tempFormData=null,this.allTemplates=[],this.currentCategory="all"}render(){return`\n      <div class="bg-white rounded-xl shadow-lg overflow-hidden">\n        <div class="border-b border-gray-200 px-6 py-4">\n          <div class="flex justify-between items-center">\n            <div>\n              <h2 class="text-xl font-bold text-gray-800">\n                <i class="fas fa-layer-group mr-2"></i>\n                Plantillas de Datos\n              </h2>\n              <p class="text-gray-600 text-sm mt-1">\n                Crea y gestiona plantillas para organizar tu informaci√≥n\n              </p>\n            </div>\n            <button id="btnNewTemplate" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition flex items-center">\n              <i class="fas fa-plus mr-2"></i>\n              Nueva Plantilla\n            </button>\n          </div>\n        </div>\n\n        <div id="templateContent" class="p-6">\n          ${this.renderLoading()}\n        </div>\n      </div>\n    `}renderLoading(){return'\n      <div class="flex justify-center py-12">\n        <div class="text-center">\n          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>\n          <p class="mt-4 text-gray-600">Cargando plantillas...</p>\n        </div>\n      </div>\n    '}renderTemplateList(e,t){const n=e.filter(e=>!e.settings?.isSystemTemplate);return`\n      <div class="space-y-6">\n        <div class="grid grid-cols-2 md:grid-cols-5 gap-3">\n          <div class="bg-gray-50 hover:bg-gray-100 rounded-lg p-3 cursor-pointer transition category-filter ${"all"===this.currentCategory?"border-2 border-blue-500 bg-blue-100":""}" data-category="all">\n            <div class="flex items-center">\n              <span class="text-lg mr-2">‚≠ê</span>\n              <div>\n                <p class="font-medium text-gray-800">Todas</p>\n                <p class="text-xs text-gray-500">${this.allTemplates.length} plantilla${1!==this.allTemplates.length?"s":""}</p>\n              </div>\n            </div>\n          </div>\n          ${t.map(e=>`\n            <div class="bg-gray-50 hover:bg-gray-100 rounded-lg p-3 cursor-pointer transition category-filter ${e.id===this.currentCategory?"border-2 border-blue-500 bg-blue-100":""}" data-category="${e.id}">\n              <div class="flex items-center">\n                <span class="text-lg mr-2">${V(e.id)}</span>\n                <div>\n                  <p class="font-medium text-gray-800">${H(e.id)}</p>\n                  <p class="text-xs text-gray-500">${e.count} plantilla${1!==e.count?"s":""}</p>\n                </div>\n              </div>\n            </div>\n          `).join("")}\n        </div>\n\n        <div id="customTemplatesSection">\n          <div id="customTemplatesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">\n            ${n.length>0?n.map(e=>this.renderTemplateCard(e)).join(""):""}\n          </div>\n          \n          <div id="noCustomTemplates" class="${n.length>0?"hidden":""} text-center py-8 border-2 border-dashed border-gray-300 rounded-lg">\n            <p class="text-gray-600 font-medium">No hay plantillas${"all"!==this.currentCategory?` en ${H(this.currentCategory)}`:""}</p>\n            <p class="text-gray-500 text-sm mt-1">Crea tu primera plantilla para organizar tus datos</p>\n          </div>\n        </div>\n      </div>\n    `}renderTemplateCard(e){const t=e.fields.length;return e.id||(e.id="temp_"+Math.random()),`\n    <div class="template-card border border-gray-200 rounded-lg hover:border-blue-300 hover:shadow-md transition-all cursor-pointer bg-white" \n         data-template-id="${e.id}"\n         data-template-name="${e.name||""}">\n      <div class="p-4">\n        <div class="flex justify-between items-start mb-3">\n          <div class="flex items-center">\n            <div class="w-10 h-10 rounded-lg flex items-center justify-center text-lg" style="background-color: ${e.color}20; color: ${e.color}">\n              ${e.icon||"üìã"}\n            </div>\n            <div class="ml-3">\n              <h4 class="font-bold text-gray-800">${e.name||"Sin nombre"}</h4>\n              <p class="text-xs text-gray-500 truncate max-w-[150px]">${e.description||"Sin descripci√≥n"}</p>\n            </div>\n          </div>\n          <div class="flex space-x-1">\n              <button type="button" class="edit-template text-gray-400 hover:text-blue-600 p-1 rounded hover:bg-blue-50 transition" \n                      data-template-id="${e.id}"\n                      title="Editar plantilla">\n                <i class="fas fa-edit"></i>\n              </button>\n              <button type="button" class="delete-template text-gray-400 hover:text-red-600 p-1 rounded hover:bg-red-50 transition" \n                      data-template-id="${e.id}"\n                      title="Eliminar plantilla">\n                <i class="fas fa-trash"></i>\n              </button>\n          </div>\n        </div>\n        \n        <div class="space-y-2">\n          <div class="flex justify-between text-sm">\n            <span class="text-gray-600">\n              <i class="fas fa-list-ul mr-1"></i>\n              ${t} campo${1!==t?"s":""}\n            </span>\n          </div>\n          \n          <div class="flex flex-wrap gap-1">\n            ${e.fields.slice(0,3).map(e=>`\n              <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded border border-gray-200">\n                ${e.label||"Sin etiqueta"}\n              </span>\n            `).join("")}\n            ${e.fields.length>3?`\n              <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded border border-gray-200">\n                +${e.fields.length-3} m√°s\n              </span>\n            `:""}\n          </div>\n        </div>\n        \n        <button type="button" class="use-template-btn w-full mt-4 bg-gray-50 hover:bg-blue-50 text-blue-600 hover:text-blue-700 font-medium py-2 px-4 rounded-lg transition flex items-center justify-center border border-gray-200 hover:border-blue-200"\n                data-template-id="${e.id}">\n          <i class="fas fa-plus-circle mr-2"></i>\n          Usar esta plantilla\n        </button>\n      </div>\n    </div>\n  `}async loadTemplates(){try{const e=document.getElementById("templateContent");if(!e)return;e.innerHTML=this.renderLoading();const t=await _.checkSyncStatus();t.needsSync&&t.cloudCount>0&&(this.showMessage(`Hay ${t.cloudCount} plantillas en la nube. <button type="button" class="underline font-medium" id="quickSync">Sincronizar</button>`,"info",1e4),setTimeout(()=>{document.getElementById("quickSync")?.addEventListener("click",async()=>{const e=await _.syncTemplates();e.synced&&(this.showSuccess(e.message),this.loadTemplates())})},100)),this.allTemplates=await _.getUserTemplates();const n=await _.getCategories();this.currentCategory="all",e.innerHTML=this.renderTemplateList(this.allTemplates,n),this.setupTemplateListListeners()}catch(e){this.showError("Error al cargar plantillas: "+e.message)}}setupTemplateListListeners(){const e=document.getElementById("btnNewTemplate");e&&e.addEventListener("click",()=>this.showTemplateForm()),document.querySelectorAll(".category-filter").forEach(e=>{e.addEventListener("click",e=>this.filterTemplatesByCategory(e.currentTarget.dataset.category))});const t=document.getElementById("templateContent");t&&t.addEventListener("click",e=>{if(!e.target.closest("button, .template-card"))return;const t=e.target.closest(".template-card"),n=t?.dataset.templateId;e.target.closest(".use-template-btn")?(n&&this.onTemplateSelect&&this.onTemplateSelect(n),e.stopPropagation()):e.target.closest(".edit-template")?(n&&this.editTemplate(n),e.stopPropagation()):e.target.closest(".delete-template")?(n&&this.deleteTemplate(n),e.stopPropagation()):!t||e.target.closest("button")||e.target.closest("a")||n&&this.showTemplatePreview(n)})}renderTemplateForm(e=null){const t=!!e,n=e?.fields?e.fields.map((e,t)=>this.renderFieldForm(e,t)).join(""):"",a=e?.settings?.category||"custom",r=e?.icon||V(a);return`\n      <div class="max-w-4xl mx-auto">\n        <div class="mb-6">\n          <h3 class="text-xl font-bold text-gray-800">\n            <i class="fas fa-${t?"edit":"plus-circle"} mr-2"></i>\n            ${t?"Editar Plantilla":"Nueva Plantilla"}\n          </h3>\n          <p class="text-gray-600 mt-1">\n            ${t?"Modifica los detalles de tu plantilla":"Crea una plantilla personalizada para organizar tus datos"}\n          </p>\n        </div>\n\n        <form id="templateForm" class="space-y-6">\n          <div class="bg-white border border-gray-200 rounded-lg p-6">\n            <h4 class="font-semibold text-gray-800 mb-4">\n              <i class="fas fa-info-circle mr-2 text-blue-500"></i>\n              Informaci√≥n B√°sica\n            </h4>\n            \n            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">\n              <div>\n                <label for="templateName" class="block text-sm font-medium text-gray-700 mb-1">\n                  Nombre de la Plantilla *\n                </label>\n                <input type="text" id="templateName" value="${e?.name||""}" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Ej: Datos M√©dicos, Credenciales, etc." />\n              </div>\n              \n              <div>\n                <label for="templateCategory" class="block text-sm font-medium text-gray-700 mb-1">\n                  Categor√≠a *\n                </label>\n                <select id="templateCategory" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">\n                  ${[{value:"custom",label:"Personalizado"},{value:"personal",label:"Personal"},{value:"access",label:"Accesos"},{value:"financial",label:"Financiero"},{value:"health",label:"Salud"},{value:"home",label:"Hogar"},{value:"car",label:"Veh√≠culo"},{value:"job",label:"Trabajo"},{value:"education",label:"Formaci√≥n"}].map(e=>`\n                    <option value="${e.value}" ${e.value===a?"selected":""}>\n                      ${V(e.value)} ${e.label}\n                    </option>\n                  `).join("")}\n                </select>\n              </div>\n              \n              <div>\n                <label for="templateIcon" class="block text-sm font-medium text-gray-700 mb-1">Icono</label>\n                <input type="text" id="templateIcon" value="${r}" \n                       maxlength="2" class="w-16 text-center px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="üìã" />\n              </div>\n              \n              <div>\n                <label for="templateColor" class="block text-sm font-medium text-gray-700 mb-1">Color</label>\n                <input type="color" id="templateColor" value="${e?.color||"#3B82F6"}" class="w-full h-10 px-1 border border-gray-300 rounded-lg cursor-pointer" />\n              </div>\n\n            </div>\n\n            <div class="mt-4">\n                <label for="templateDescription" class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n</label>\n                <input type="text" id="templateDescription" value="${e?.description||""}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Breve descripci√≥n de la plantilla" />\n            </div>\n          </div>\n\n          <div class="bg-white border border-gray-200 rounded-lg p-6">\n            <div class="flex justify-between items-center mb-4">\n              <h4 class="font-semibold text-gray-800">\n                <i class="fas fa-list-alt mr-2 text-green-500"></i>\n                Campos de la Plantilla\n              </h4>\n              <button type="button" id="addFieldBtn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition flex items-center">\n                <i class="fas fa-plus mr-2"></i>\n                Agregar Campo\n              </button>\n            </div>\n            \n            <div id="fieldsContainer" class="space-y-4">\n              ${n}\n            </div>\n            \n            <div id="noFieldsMessage" class="${e?.fields?.length?"hidden":"text-center py-8 border-2 border-dashed border-gray-300 rounded-lg"}">\n              <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">\n                <i class="fas fa-list-ul text-gray-400 text-2xl"></i>\n              </div>\n              <p class="text-gray-600 font-medium">No hay campos definidos</p>\n              <p class="text-gray-500 text-sm mt-1">Agrega campos para capturar informaci√≥n</p>\n            </div>\n          </div>\n\n          <div class="bg-white border border-gray-200 rounded-lg p-6">\n            <h4 class="font-semibold text-gray-800 mb-4">\n              <i class="fas fa-cogs mr-2 text-purple-500"></i>\n              Configuraci√≥n Adicional\n            </h4>\n            \n            <div class="space-y-4">\n              <div class="flex items-center">\n                <input type="checkbox" id="allowDuplicates" ${e?.settings?.allowDuplicates?"checked":""} class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" />\n                <label for="allowDuplicates" class="ml-2 text-gray-700">Permitir m√∫ltiples entradas con esta plantilla</label>\n              </div>\n              \n              <div>\n                <label for="maxEntries" class="block text-sm font-medium text-gray-700 mb-1">L√≠mite de entradas (0 = ilimitado)</label>\n                <input type="number" id="maxEntries" value="${e?.settings?.maxEntries||0}" min="0" class="w-32 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" />\n              </div>\n              \n              </div>\n          </div>\n\n          <div class="flex justify-between pt-4 border-t border-gray-200">\n            <button type="button" id="cancelTemplate" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-6 rounded-lg transition">Cancelar</button>\n            <div class="space-x-3">\n              <button type="button" id="previewTemplate" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-6 rounded-lg transition"><i class="fas fa-eye mr-2"></i>Vista Previa</button>\n              <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg transition"><i class="fas fa-save mr-2"></i>${t?"Actualizar Plantilla":"Crear Plantilla"}</button>\n            </div>\n          </div>\n        </form>\n      </div>\n    `}renderFieldForm(e=null,t=0){const n=e?.id||z(e?.label||`campo_${t+1}`,t),a=q();return`\n    <div class="field-item border border-gray-200 rounded-lg p-4 cursor-move" data-field-id="${n}">\n      <div class="flex justify-between items-start mb-4">\n        <span class="drag-handle text-gray-400 hover:text-gray-600 mr-3 p-1"><i class="fas fa-grip-lines"></i></span>\n        <h5 class="font-medium text-gray-800"><i class="fas fa-columns mr-2"></i>Campo ${t+1}</h5>\n        <button type="button" class="remove-field text-red-600 hover:text-red-800"><i class="fas fa-times"></i></button>\n      </div>\n      \n      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-4"> \n        <div>\n          <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Campo *</label>\n          <input type="text" class="field-label w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" value="${e?.label||""}" placeholder="Ej: Nombre Completo" required />\n        </div>\n        \n        <div>\n          <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Dato *</label>\n          <select class="field-type w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm">\n            ${a.map(t=>`\n              <option value="${t.value}" ${e?.type===t.value?"selected":""}>\n                ${t.label}\n              </option>\n            `).join("")}\n          </select>\n        </div>\n        </div>\n        \n        <div class="options-input-group ${"select"===e?.type?"":"hidden"} mt-4">\n          <label class="block text-sm font-medium text-gray-700 mb-1">Opciones (separadas por coma) *</label>\n          <textarea\n            class="field-options w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm"\n            placeholder="Ej: Banco, Tarjeta de Cr√©dito, Inversi√≥n"\n          >${(e?.options||[]).join(", ")}</textarea>\n        </div>\n      \n      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">\n        <div>\n          <label class="block text-sm font-medium text-gray-700 mb-1">Texto de ayuda</label>\n          <input type="text" class="field-placeholder w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" value="${e?.placeholder||""}" placeholder="Placeholder..." />\n        </div>\n        <div class="space-y-2">\n          <div class="flex items-center">\n            <input type="checkbox" class="field-required h-4 w-4 text-blue-600 border-gray-300 rounded" ${e?.required?"checked":""} />\n            <label class="ml-2 text-sm text-gray-700">Obligatorio</label>\n          </div>\n        </div>\n      </div>\n    </div>\n      `}async showTemplateForm(e=null){const t=document.getElementById("templateContent");t&&(e?(this.editingTemplate=await _.getTemplateById(e),this.tempFormData=null,t.innerHTML=this.renderTemplateForm(this.editingTemplate)):this.tempFormData?(this.editingTemplate=null,t.innerHTML=this.renderTemplateForm(this.tempFormData)):(this.editingTemplate=null,this.tempFormData=null,t.innerHTML=this.renderTemplateForm()),this.setupTemplateFormListeners())}setupTemplateFormListeners(){const e=document.getElementById("templateCategory"),t=document.getElementById("templateIcon");e&&t&&e.addEventListener("change",e=>{t.value=V(e.target.value)}),document.getElementById("addFieldBtn")?.addEventListener("click",()=>this.addField());const n=document.getElementById("fieldsContainer");n&&(n.addEventListener("click",e=>{e.target.closest(".remove-field")&&(e.target.closest(".field-item").remove(),this.updateNoFieldsMessage())}),n.addEventListener("change",e=>{if(e.target.classList.contains("field-type")){const t=e.target.closest(".field-item").querySelector(".options-input-group");"select"===e.target.value?(t.classList.remove("hidden"),t.querySelector(".field-options").setAttribute("required","required")):(t.classList.add("hidden"),t.querySelector(".field-options").removeAttribute("required"))}})),document.getElementById("cancelTemplate")?.addEventListener("click",()=>this.loadTemplates()),document.getElementById("previewTemplate")?.addEventListener("click",()=>this.previewTemplate()),document.getElementById("templateForm")?.addEventListener("submit",e=>{e.preventDefault(),this.saveTemplate()}),this.setupFieldValidation(),this.initializeSortable()}addField(){const e=document.getElementById("fieldsContainer");if(e){const t=e.querySelectorAll(".field-item").length;e.insertAdjacentHTML("beforeend",this.renderFieldForm(null,t)),document.getElementById("noFieldsMessage")?.classList.add("hidden")}}updateNoFieldsMessage(){const e=document.getElementById("fieldsContainer");e&&0===e.querySelectorAll(".field-item").length&&document.getElementById("noFieldsMessage")?.classList.remove("hidden")}collectFormData(){const e=document.getElementById("templateName")?.value||"",t=document.getElementById("templateDescription")?.value||"",n=document.getElementById("templateIcon")?.value||"üìã",a=document.getElementById("templateColor")?.value||"#3B82F6",r=document.getElementById("allowDuplicates")?.checked||!1,s=parseInt(document.getElementById("maxEntries")?.value)||0,i=document.getElementById("templateCategory")?.value||"custom";if(!e.trim())throw new Error("El nombre de la plantilla es requerido.");const o=[],l=document.querySelectorAll("#fieldsContainer .field-item");if(0===l.length)throw new Error("La plantilla debe tener al menos un campo.");return l.forEach((e,t)=>{const n=e.querySelector(".field-label")?.value||"",a=e.querySelector(".field-type")?.value||"string";if(!n.trim())throw new Error(`Campo ${t+1}: Nombre requerido`);const r=z(n,t);let s=[];if("select"===a){const t=e.querySelector(".field-options").value;if(!t)throw new Error(`El campo '${n}' de tipo Selecci√≥n Simple requiere opciones.`);s=t.split(",").map(e=>e.trim()).filter(e=>e.length>0)}o.push({id:r,label:n.trim(),type:a,order:t+1,placeholder:e.querySelector(".field-placeholder")?.value||"",required:e.querySelector(".field-required")?.checked||!1,...s.length>0&&{options:s}})}),{name:e.trim(),description:t.trim(),icon:n,color:a,fields:o,settings:{allowDuplicates:r,maxEntries:s,category:i,isSystemTemplate:!1}}}async saveTemplate(){try{const e=document.querySelector('#templateForm button[type="submit"]');e&&(e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i> Procesando...');const t=this.collectFormData();this.editingTemplate?(await _.updateTemplate(this.editingTemplate.id,t),this.showSuccess("‚úÖ Plantilla actualizada correctamente")):(await _.createTemplate(t),this.showSuccess("‚úÖ Plantilla creada correctamente")),setTimeout(()=>this.loadTemplates(),1500)}catch(e){this.showError(e.message);const t=document.querySelector('#templateForm button[type="submit"]');t&&(t.disabled=!1,t.innerHTML='<i class="fas fa-save mr-2"></i> '+(this.editingTemplate?"Actualizar Plantilla":"Crear Plantilla"))}}async editTemplate(e){await this.showTemplateForm(e)}async deleteTemplate(e){if(confirm("¬øEst√°s seguro de que deseas eliminar esta plantilla? Esta acci√≥n es irreversible."))try{await _.deleteTemplate(e),this.showSuccess("‚úÖ Plantilla eliminada correctamente"),this.loadTemplates()}catch(t){this.showError("Error al eliminar: "+t.message)}}async previewTemplate(){try{this.tempFormData=this.collectFormData(),this.showTemplatePreviewData(this.tempFormData)}catch(e){this.showError(e.message)}}async showTemplatePreview(e){try{const t=await _.getTemplateById(e);if(!t)throw new Error("Plantilla no encontrada para previsualizar.");this.showTemplatePreviewData(t)}catch(t){this.showError("Error al cargar vista previa: "+t.message)}}showTemplatePreviewData(e){const t=document.getElementById("templateContent");t&&(t.innerHTML=`\n        <div class="max-w-4xl mx-auto">\n             <div class="mb-6"><h3 class="text-xl font-bold text-gray-800"><i class="fas fa-eye mr-2"></i>Vista Previa de Plantilla</h3></div>\n             <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">\n                <div class="flex items-center"><div class="w-12 h-12 rounded-lg flex items-center justify-center text-xl mr-4" style="background-color:${e.color}20;color:${e.color}">${e.icon}</div>\n                <div><h4 class="font-bold text-gray-800">${e.name}</h4><p class="text-gray-600">${e.description}</p></div></div>\n             </div>\n             <div class="bg-white border border-gray-200 rounded-lg p-6">\n                <h4 class="font-semibold text-gray-800 mb-4">Formulario Ejemplo</h4>\n                <div class="space-y-4">${e.fields.map(e=>this.renderFieldPreview(e)).join("")}</div>\n             </div>\n             <div class="flex justify-between pt-4">\n               <button id="backToForm" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-6 rounded-lg transition">\n                  <i class="fas fa-arrow-left mr-2"></i> Volver a Editar\n               </button>\n               <button id="saveFromPreview" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg transition">\n                  <i class="fas fa-save mr-2"></i> Guardar Plantilla\n               </button>\n             </div>\n        </div>\n      `,document.getElementById("backToForm")?.addEventListener("click",()=>this.showTemplateForm(this.editingTemplate?.id)),document.getElementById("saveFromPreview")?.addEventListener("click",()=>{this.showTemplateForm(this.editingTemplate?.id),setTimeout(()=>document.getElementById("templateForm")?.requestSubmit(),50)}))}renderFieldPreview(e){const t=(e=>{const t=N(e);return t?t.label:e})(e.type);let n;if("select"===e.type){n=`<div class="p-3 bg-gray-100 border border-gray-200 rounded-lg">${(e.options||[]).map(e=>`<span class="text-xs bg-gray-200 text-gray-800 px-2 py-1 rounded">${e}</span>`).join(" ")}</div>`}else n=`\n            <input disabled class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-700" \n                   placeholder="${e.placeholder||"Campo de tipo: "+t}" \n                   value="">\n        `;return`\n        <div class="mb-4">\n           <label class="block text-sm font-medium text-gray-700">\n             ${e.label} \n             ${e.required?'<span class="text-red-600 ml-1 font-bold" title="Campo Obligatorio">*</span>':""}\n           </label>\n           ${n} \n        </div>\n      `}async filterTemplatesByCategory(e){if(this.currentCategory===e)return;this.currentCategory=e;const t=await _.getCategories(),n="all"===e?this.allTemplates:this.allTemplates.filter(t=>t.settings.category===e),a=document.getElementById("templateContent");a&&(a.innerHTML=this.renderTemplateList(n,t),this.setupTemplateListListeners());const r=H(e);this.showMessage(`Mostrando ${n.length} plantilla${1!==n.length?"s":""} en categor√≠a: ${r}`,"info",3e3)}showMessage(e,t="info",n=3e3){const a=document.createElement("div");a.className="fixed bottom-4 right-4 z-50 px-4 py-3 rounded text-white shadow-lg "+("error"===t?"bg-red-500":"success"===t?"bg-green-500":"bg-blue-500"),a.innerHTML=e,document.body.appendChild(a),setTimeout(()=>a.remove(),n)}showSuccess(e){this.showMessage(e,"success")}showError(e){this.showMessage(e,"error",5e3)}setupFieldValidation(){document.querySelectorAll(".field-label").forEach(e=>{e.addEventListener("blur",()=>{this.validateFieldLabel(e)}),e.addEventListener("input",()=>{this.clearFieldError(e)})})}validateFieldLabel(e){const t=e.value.trim();return t?t.length<2?(this.showFieldError(e,"El nombre debe tener al menos 2 caracteres"),!1):(this.clearFieldError(e),!0):(this.showFieldError(e,"El nombre del campo es requerido"),!1)}showFieldError(e,t){this.clearFieldError(e),e.classList.add("border-red-500","bg-red-50");const n=document.createElement("div");n.className="text-red-600 text-xs mt-1",n.textContent=t,n.id=`error-${e.id||e.name||e.classList[0]}`,e.parentNode.appendChild(n)}clearFieldError(e){e.classList.remove("border-red-500","bg-red-50");const t=`error-${e.id||e.name||e.classList[0]}`,n=document.getElementById(t);n&&n.remove()}initializeSortable(){const e=document.getElementById("fieldsContainer");e&&"undefined"!=typeof Sortable&&new Sortable(e,{animation:150,handle:".drag-handle",ghostClass:"sortable-ghost",onEnd:e=>{}})}}const K=new class{renderField(e,t=""){if(!e||!e.type)return`<p class="text-red-500">Error: Tipo de campo no definido para ${e.label||"un campo"}.</p>`;const n=e.required?"required":"";let a="";const r=N(e.type);let s=r?.inputType||"text";switch(s){case"checkbox":a=`<input type="checkbox" id="${e.id}" name="${e.id}" class="form-checkbox" ${t?"checked":""} />`;break;case"textarea":a=`<textarea id="${e.id}" name="${e.id}" class="form-textarea" placeholder="${e.placeholder||""}" ${n}>${t}</textarea>`;break;case"select":const r=(e.options||[]).map(e=>`\n          <option value="${e}" ${t===e?"selected":""}>\n            ${e}\n          </option>\n        `).join("");a=`\n          <select id="${e.id}" name="${e.id}" class="form-select" ${n}>\n            <option value="" disabled ${t?"":"selected"}>Seleccionar...</option>\n            ${r}\n          </select>`;break;default:a=`<input type="${s}" id="${e.id}" name="${e.id}" class="form-input" placeholder="${e.placeholder||""}" value="${t}" ${n} />`}return`\n      <div class="mb-4 field-wrapper">\n        <label for="${e.id}" class="block text-sm font-medium text-gray-700">\n            ${e.label} \n        </label>\n        ${a}\n      </div>\n    `}generateFormHtml(e,t={}){if(!e||!e.fields)return'<div class="p-4 text-red-600">Error: Plantilla inv√°lida.</div>';const n=e.fields.map(e=>{const n=t[e.id]||"";return this.renderField(e,n)}).join("");return`<form id="templateForm_${e.id}">${n}</form>`}},J={};class W{constructor(e={}){this.id=e.id||this.generateId(),this.userId=e.userId,this.areaId=e.areaId,this.encryptedContent=e.encryptedContent||"",this.contentHash=e.contentHash||"",this.encryptionMetadata=e.encryptionMetadata||{encryptedItemKey:"",iv:"",salt:"",algorithm:"AES-GCM-256",version:"1.0"},this.metadata=e.metadata||{title:"",createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),tags:[],isFavorite:!1,icon:"üìÑ"},this.sharedWith=e.sharedWith||{},this.templateId=e.templateId||"",this.fieldOrder=e.fieldOrder||[],this.version=e.version||1}generateId(){return"doc_"+Math.random().toString(36).substr(2,9)}toFirestore(){return{id:this.id,userId:this.userId,areaId:this.areaId,encryptedContent:this.encryptedContent,contentHash:this.contentHash,encryptionMetadata:this.encryptionMetadata,metadata:this.metadata,sharedWith:this.sharedWith,templateId:this.templateId,fieldOrder:this.fieldOrder,version:this.version}}}const Y=new class{constructor(){this.collectionPath="vault"}async createDocument(e,t){const n=F.getCurrentUser();if(!n)throw new Error("Usuario no autenticado");const a={...t,_templateVersion:e.updatedAt},r=await B.encryptDocument(a),s=new W({userId:n.uid,templateId:e.id,encryptedContent:r.content,encryptionMetadata:r.metadata,metadata:{title:this.generateDocumentTitle(e,t),createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),icon:e.icon||"üìÑ",isFavorite:!1}}),i=E.doc(`artifacts/mi-gestion-v1/users/${n.uid}/vault/${s.id}`);return await E.setDoc(i,s.toFirestore()),s}async getAllDocuments(){const e=F.getCurrentUser();if(!e)throw new Error("Usuario no autenticado");const t=`artifacts/mi-gestion-v1/users/${e.uid}/vault`,n=E.getFirestore(),{collection:a,getDocs:r,query:s,orderBy:i}=window.firebaseModules;try{const e=s(a(n,t),i("metadata.updatedAt","desc")),o=await r(e),l=[];return o.forEach(e=>{l.push(e.data())}),l}catch(o){return[]}}async getDocumentById(e){const t=F.getCurrentUser();if(!t)throw new Error("Usuario no autenticado");try{const n=E.doc(`artifacts/mi-gestion-v1/users/${t.uid}/vault/${e}`),a=await E.getDoc(n);if(a.exists())return a.data();throw new Error("Documento no encontrado")}catch(n){throw n}}async loadDocumentForEditing(e){if(!F.getCurrentUser())throw new Error("Usuario no autenticado");const{templateService:t}=await function(e,t){let n=Promise.resolve();if(t&&t.length>0){let e=function(e){return Promise.all(e.map(e=>Promise.resolve(e).then(e=>({status:"fulfilled",value:e}),e=>({status:"rejected",reason:e}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),r=a?.nonce||a?.getAttribute("nonce");n=e(t.map(e=>{if((e=function(e){return"/"+e}(e))in J)return;J[e]=!0;const t=e.endsWith(".css"),n=t?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${e}"]${n}`))return;const a=document.createElement("link");return a.rel=t?"stylesheet":"modulepreload",t||(a.as="script"),a.crossOrigin="",a.href=e,r&&a.setAttribute("nonce",r),document.head.appendChild(a),t?new Promise((t,n)=>{a.addEventListener("load",t),a.addEventListener("error",()=>n(new Error(`Unable to preload CSS for ${e}`)))}):void 0}))}function a(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return n.then(t=>{for(const e of t||[])"rejected"===e.status&&a(e.reason);return e().catch(a)})}(async()=>{const{templateService:e}=await Promise.resolve().then(()=>j);return{templateService:e}},void 0),n=await this.getDocumentById(e);if(!n.encryptionMetadata||!n.encryptedContent)throw new Error("Datos cifrados incompletos o corruptos.");const a=await B.decryptDocument({content:n.encryptedContent,metadata:n.encryptionMetadata}),r=await t.getTemplateById(n.templateId);if(!r)throw new Error("Plantilla asociada no encontrada.");return{template:r,formData:a,documentId:e,metadata:n.metadata}}async updateDocument(e,t,n){const a=F.getCurrentUser();if(!a)throw new Error("Usuario no autenticado");const r={...n,_templateVersion:t.updatedAt},s=await B.encryptDocument(r,e),i={encryptedContent:s.content,encryptionMetadata:s.metadata,metadata:{...t.metadata,title:this.generateDocumentTitle(t,n),updatedAt:(new Date).toISOString(),icon:t.icon||"üìÑ",isFavorite:!1}},o=E.doc(`artifacts/mi-gestion-v1/users/${a.uid}/vault/${e}`);return await E.setDoc(o,i,{merge:!0}),{id:e,...i}}async deleteDocument(e){const t=F.getCurrentUser();if(!t)throw new Error("Usuario no autenticado");try{const n=E.doc(`artifacts/mi-gestion-v1/users/${t.uid}/vault/${e}`);return await E.deleteDoc(n),{success:!0}}catch(n){throw new Error("No se pudo eliminar el documento de la b√≥veda.")}}generateDocumentTitle(e,t){const n=e.fields[0];if(n&&void 0!==t[n.id]&&null!==t[n.id]){const e=t[n.id];let a=String(e);if(a.length>0||0===e||!1===e)return a.length>50&&(a=a.substring(0,50)+"..."),a}return`${e.name} - ${(new Date).toLocaleDateString()}`}};class X{constructor(e,t,n){this.initialData=e,this.onSaveSuccess=t,this.onCancel=n,this.isEditing=!!e.documentId,this.documentId=e.documentId||null,this.template=e.template||null,this.initialFormData=e.formData||{},this.documentMetadata=e.metadata||{},this.isSubmitting=!1,this.isEditing&&!this.template&&this.loadExistingDocument()}async loadExistingDocument(){this.updateEditorState(!0,"Cargando datos...");try{const e=await Y.loadDocumentForEditing(this.documentId);this.template=e.template,this.initialFormData=e.formData,this.documentMetadata=e.metadata,this.render(),this.setupEventListeners(),this.updateEditorState(!1)}catch(e){this.renderError("Error al cargar datos cifrados: "+e.message)}}render(){if(!this.template&&this.isEditing)return'<div id="editorContainer" class="max-w-3xl mx-auto py-8">\n            <div class="flex justify-center items-center">\n                <i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i>\n            </div>\n        </div>';if(!this.template)return'<div id="editorContainer">Error: Plantilla no definida.</div>';const e=this.isEditing?`Editando: ${this.documentMetadata?.title||this.template.name}`:`Nuevo: ${this.template.name}`,t=this.isEditing?"Actualizar y Recifrar":"Guardar y Cifrar",n=this.isEditing?"recifrados":"cifrados";return`\n      <div id="editorContainer" class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden animate-fade-in">\n        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">\n          <div class="flex items-center">\n            <div class="w-10 h-10 rounded-lg flex items-center justify-center text-xl mr-3" \n                 style="background-color: ${this.template.color}20; color: ${this.template.color}">\n              ${this.template.icon}\n            </div>\n            <div>\n              <h2 class="text-lg font-bold text-gray-800">${e}</h2>\n              <p class="text-xs text-gray-500">Los datos ser√°n ${n} antes de guardarse</p>\n            </div>\n          </div>\n          <button id="closeEditorBtn" class="text-gray-400 hover:text-gray-600">\n            <i class="fas fa-times"></i>\n          </button>\n        </div>\n\n        <div class="p-6">\n          <div id="dynamicFormContainer">\n            ${K.generateFormHtml(this.template,this.initialFormData)}\n          </div>\n\n          <div class="mt-6 mb-6 flex items-start p-3 bg-green-50 border border-green-100 rounded-lg">\n            <i class="fas fa-lock text-green-600 mt-1 mr-3"></i>\n            <div class="text-sm text-green-800">\n              <p class="font-medium">Protecci√≥n E2EE Activa</p>\n              <p class="text-green-700 opacity-90">\n                Tu clave maestra se usar√° para sellar este documento digitalmente.\n              </p>\n            </div>\n          </div>\n\n          <div class="flex justify-end space-x-3 pt-4 border-t border-gray-100">\n            <button id="cancelDocBtn" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium transition">\n              Cancelar\n            </button>\n            <button id="saveDocBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium shadow-md hover:shadow-lg transition flex items-center">\n              <i class="fas fa-save mr-2"></i>\n              ${t}\n            </button>\n          </div>\n        </div>\n      </div>\n    `}setupEventListeners(){document.getElementById("closeEditorBtn")?.addEventListener("click",()=>this.onCancel()),document.getElementById("cancelDocBtn")?.addEventListener("click",()=>this.onCancel()),document.getElementById("saveDocBtn")?.addEventListener("click",()=>this.handleSave())}async handleSave(){if(this.isSubmitting)return;const e=document.querySelector('form[id^="templateForm_"]');if(e&&e.checkValidity()){this.updateEditorState(!0,this.isEditing?"Actualizando...":"Cifrando...");try{const t=this.collectFormData(e);let n;n=this.isEditing?await Y.updateDocument(this.documentId,this.template,t):await Y.createDocument(this.template,t),this.onSaveSuccess&&this.onSaveSuccess(n)}catch(t){alert("Error al guardar: "+t.message),this.updateEditorState(!1)}}else e?.reportValidity()}collectFormData(e){const t={};return this.template.fields.forEach(e=>{const n=document.getElementById(e.id);n&&("boolean"===e.type?t[e.id]=n.checked:"number"===e.type||"currency"===e.type||"percentage"===e.type?t[e.id]=Number(n.value):t[e.id]=n.value)}),t}updateEditorState(e,t=null){this.isSubmitting=e;const n=document.getElementById("saveDocBtn");if(!n)return;if(e)n.disabled=!0,n.innerHTML=`<i class="fas fa-spinner fa-spin mr-2"></i> ${t||"Procesando..."}`,n.classList.add("opacity-75","cursor-not-allowed");else{n.disabled=!1;const e=this.isEditing?"Actualizar y Recifrar":"Guardar y Cifrar";n.innerHTML=`<i class="fas fa-save mr-2"></i> ${e}`,n.classList.remove("opacity-75","cursor-not-allowed")}document.querySelectorAll("#dynamicFormContainer input, #dynamicFormContainer textarea, #dynamicFormContainer select").forEach(t=>t.disabled=e)}renderError(e){const t=document.getElementById("editorContainer");t&&(t.innerHTML=`\n        <div class="p-6">\n            <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r-lg max-w-3xl mx-auto">\n                <h4 class="text-red-800 font-bold mb-2">Error Cr√≠tico</h4>\n                <p class="text-red-700">${e}</p>\n                <button id="backBtnError" class="mt-4 bg-white border border-red-300 text-red-700 px-4 py-2 rounded hover:bg-red-50 transition">\n                  Volver al Listado\n                </button>\n            </div>\n        </div>\n      `,document.getElementById("backBtnError")?.addEventListener("click",()=>this.onCancel()))}}class Z{constructor(e,t){this.onDocumentSelect=e,this.onNewDocument=t,this.documents=[],this.templatesMap={},this.isLoading=!1,this.currentFilter="all"}async loadDocuments(){this.isLoading=!0,this.render();try{const[e,t]=await Promise.all([Y.getAllDocuments(),_.getUserTemplates()]);this.documents=e,this.templatesMap=t.reduce((e,t)=>(e[t.id]=t,e),{})}catch(e){this.error="No se pudieron cargar tus documentos seguros."}finally{this.isLoading=!1,this.render()}}getActiveFilters(){const e=this.documents.reduce((e,t)=>{const n=t.templateId;return e[n]=(e[n]||0)+1,e},{});return Object.keys(e).map(t=>{const n=this.templatesMap[t]||{name:"Desconocido",icon:"‚ùì",color:"#gray"};return{id:t,name:n.name,icon:n.icon,color:n.color,count:e[t]}})}render(){const e=document.getElementById("vaultListContainer");if(!e)return;if(this.isLoading)return void(e.innerHTML='\n        <div class="flex justify-center items-center py-12">\n          <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"></div>\n          <span class="ml-3 text-gray-500">Accediendo a la b√≥veda segura...</span>\n        </div>\n      ');if(this.error)return e.innerHTML=`\n        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r">\n          <p class="text-red-700">${this.error}</p>\n          <button id="retryLoadBtn" class="mt-2 text-sm text-red-600 underline hover:text-red-800">Reintentar</button>\n        </div>\n      `,void document.getElementById("retryLoadBtn")?.addEventListener("click",()=>this.loadDocuments());if(0===this.documents.length)return e.innerHTML=this.renderEmptyState(),void document.getElementById("createFirstDocBtn")?.addEventListener("click",()=>this.onNewDocument());const t="all"===this.currentFilter?this.documents:this.documents.filter(e=>e.templateId===this.currentFilter);e.innerHTML=`\n      <div class="mb-6 overflow-x-auto pb-2 scrollbar-hide">\n        <div class="flex space-x-2">\n            ${this.renderFilters()}\n        </div>\n      </div>\n\n      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 animate-fade-in">\n        ${t.map(e=>this.renderDocumentCard(e)).join("")}\n      </div>\n      \n      ${0===t.length?'\n        <div class="text-center py-8 text-gray-500 bg-gray-50 rounded-lg border border-dashed border-gray-300">\n            No hay documentos en esta categor√≠a.\n        </div>\n      ':""}\n    `,this.setupListeners(e)}renderFilters(){const e=this.getActiveFilters();let t=`\n      <button class="filter-btn flex items-center px-4 py-2 rounded-full text-sm font-medium transition whitespace-nowrap border ${"all"===this.currentFilter?"bg-gray-800 text-white border-gray-800 shadow-md":"bg-white text-gray-600 border-gray-200 hover:bg-gray-50"}" data-filter="all">\n        <span class="mr-2">üìÇ</span> Todos (${this.documents.length})\n      </button>\n    `;return t+=e.map(e=>`\n      <button class="filter-btn flex items-center px-4 py-2 rounded-full text-sm font-medium transition whitespace-nowrap border ${this.currentFilter===e.id?"text-white shadow-md transform scale-105":"bg-white text-gray-600 border-gray-200 hover:bg-gray-50"}" \n      style="${this.currentFilter===e.id?`background-color: ${e.color}; border-color: ${e.color};`:""}"\n      data-filter="${e.id}">\n        <span class="mr-2">${e.icon}</span> ${e.name} <span class="ml-2 opacity-75 text-xs bg-black bg-opacity-10 px-1.5 rounded-full">${e.count}</span>\n      </button>\n    `).join(""),t}renderEmptyState(){return'\n      <div class="text-center py-12 bg-white rounded-xl shadow-sm border border-gray-200">\n        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">\n          <i class="fas fa-box-open text-gray-400 text-3xl"></i>\n        </div>\n        <h3 class="text-lg font-medium text-gray-900">Tu b√≥veda est√° vac√≠a</h3>\n        <p class="mt-1 text-gray-500 max-w-sm mx-auto">Comienza a proteger tu informaci√≥n personal creando tu primer documento cifrado.</p>\n        <div class="mt-6">\n          <button id="createFirstDocBtn" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none">\n            <i class="fas fa-plus mr-2"></i>\n            Crear Nuevo Documento\n          </button>\n        </div>\n      </div>\n    '}renderDocumentCard(e){const t=new Date(e.metadata.updatedAt).toLocaleDateString("es-ES",{year:"numeric",month:"short",day:"numeric"}),n=this.templatesMap[e.templateId]||{},a=n.icon||e.metadata.icon||"üìÑ",r=n.color||"#3B82F6";return`\n      <div class="vault-card bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md hover:border-blue-300 transition-all cursor-pointer p-4 group" data-id="${e.id}">\n        <div class="flex items-start justify-between">\n          <div class="flex items-center space-x-3">\n            <div class="flex-shrink-0">\n              <span class="inline-flex items-center justify-center h-10 w-10 rounded-lg text-xl" \n                    style="background-color: ${r}20; color: ${r}">\n                ${a}\n              </span>\n            </div>\n            <div class="min-w-0 flex-1">\n              <p class="text-sm font-bold text-gray-900 truncate">\n                ${e.metadata.title||"Sin T√≠tulo"}\n              </p>\n              <p class="text-xs text-gray-500 truncate">\n                ${n.name||"Documento"} ‚Ä¢ ${t}\n              </p>\n            </div>\n          </div>\n          <div class="opacity-0 group-hover:opacity-100 transition-opacity">\n            <i class="fas fa-chevron-right text-gray-400"></i>\n          </div>\n        </div>\n        <div class="mt-3 flex items-center justify-between text-xs">\n          <div class="flex items-center text-green-600 bg-green-50 px-2 py-1 rounded">\n            <i class="fas fa-lock mr-1"></i> E2EE\n          </div>\n          <span class="text-gray-400 font-mono">v${e.version||1}</span>\n        </div>\n      </div>\n    `}setupListeners(e){e.querySelectorAll(".filter-btn").forEach(e=>{e.addEventListener("click",e=>{const t=e.currentTarget.dataset.filter;this.currentFilter=t,this.render()})}),e.querySelectorAll(".vault-card").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.id;this.onDocumentSelect(t)})})}}class Q{constructor(e,t){this.docId=e,this.onBack=t,this.document=null,this.template=null,this.decryptedData=null}async load(){this.renderLoading();try{if(this.document=await Y.getDocumentById(this.docId),this.template=await _.getTemplateById(this.document.templateId),!this.template)throw new Error("La plantilla asociada a este documento ya no existe.");if(!B.isReady())throw new Error("El servicio de cifrado no est√° listo. Por favor, ingresa tu contrase√±a.");this.decryptedData=await B.decryptDocument({content:this.document.encryptedContent,metadata:this.document.encryptionMetadata}),this.renderContent()}catch(e){this.renderError(e.message)}}renderLoading(){const e=document.getElementById("documentViewerPlaceholder");e&&(e.innerHTML='\n        <div class="flex flex-col items-center justify-center py-20">\n          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>\n          <p class="text-gray-600 animate-pulse">Descifrando informaci√≥n segura...</p>\n          <p class="text-xs text-gray-400 mt-2">Aplicando algoritmo AES-GCM-256</p>\n        </div>\n      ')}renderError(e){const t=document.getElementById("documentViewerPlaceholder");t&&(t.innerHTML=`\n        <div class="bg-red-50 border-l-4 border-red-500 p-6 rounded-r-lg">\n          <h3 class="text-red-800 font-bold mb-2">Error de Desencriptaci√≥n</h3>\n          <p class="text-red-700">${e}</p>\n          <button id="backBtnError" class="mt-4 bg-white border border-red-300 text-red-700 px-4 py-2 rounded hover:bg-red-50 transition">\n            Volver\n          </button>\n        </div>\n      `,document.getElementById("backBtnError")?.addEventListener("click",()=>this.onBack()))}renderContent(){const e=document.getElementById("documentViewerPlaceholder");if(!e)return;const t=new Date(this.document.metadata.updatedAt).toLocaleString(),n=R(),a=this.template.fields.map((e,t)=>{if(0===t)return"";const a=this.decryptedData[e.id],r=e.label;let s;if(null==a||"string"==typeof a&&0===a.length)s='<span class="text-gray-400 italic">Sin datos</span>';else if("date"===e.type&&a)try{const[e,t,r]=a.split("-").map(Number),i=new Date(e,t-1,r);s=new Intl.DateTimeFormat(n.locale,{year:"numeric",month:"short",day:"numeric"}).format(i)}catch(i){s=a}else s="boolean"===e.type?a?'<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm">S√≠</span>':'<span class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-sm">No</span>':"currency"===e.type&&"number"==typeof a?new Intl.NumberFormat(n.locale,{style:"currency",currency:n.codigo}).format(a):"percentage"===e.type&&"number"==typeof a?`${a}%`:"secret"===e.type?`\n          <div class="flex items-center gap-2">\n            <span class="font-mono bg-gray-100 px-2 py-1 rounded secret-mask" data-value="${a}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>\n            \n            <button type="button" class="toggle-secret-btn text-gray-500 hover:text-blue-600 transition focus:outline-none" title="Ver/Ocultar">\n              <i class="fas fa-eye"></i>\n            </button>\n            \n            <button type="button" class="copy-btn text-gray-400 hover:text-green-600 transition" data-value="${a}" title="Copiar">\n               <i class="fas fa-copy"></i>\n            </button>\n          </div>`:"url"===e.type?`<a href="${a}" target="_blank" class="text-blue-600 hover:underline flex items-center"><i class="fas fa-external-link-alt mr-1 text-xs"></i> ${a}</a>`:String(a);0!==a&&!1!==a||(s=String(a));return`\n        <div class="border-b border-gray-100 last:border-0 py-4">\n          <dt class="text-sm font-medium text-gray-500 mb-1 flex items-center">\n            ${r}\n          </dt>\n          <dd class="${"text"===e.type?"mt-2 whitespace-pre-wrap text-gray-800 bg-gray-50 p-3 rounded-md border border-gray-100 text-sm font-normal":"text-gray-900 font-medium break-words"}">${s}</dd>\n        </div>\n      `}).join("");e.innerHTML=`\n      <div id="documentCard" class="bg-white rounded-xl shadow-lg overflow-hidden animate-fade-in max-w-3xl mx-auto">\n        \n        <div class="px-6 py-5 border-b border-gray-200 bg-gray-50 flex justify-between items-start">\n          <div class="flex items-center">\n            <div class="w-12 h-12 rounded-lg flex items-center justify-center text-2xl mr-4 shadow-sm" \n                 style="background-color: ${this.template.color}20; color: ${this.template.color}">\n              ${this.template.icon}\n            </div>\n            <div>\n              <h2 class="text-xl font-bold text-gray-900">${this.document.metadata.title}</h2>\n              <p class="text-sm text-gray-500">\n                ${this.template.name} ‚Ä¢ Actualizado: ${t}\n              </p>\n            </div>\n          </div>\n          <button id="closeViewerBtn" class="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-200 transition no-print">\n            <i class="fas fa-times text-xl"></i>\n          </button>\n        </div>\n\n        <div class="p-6">\n          <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-6 flex items-center text-sm text-green-800 no-print">\n            <i class="fas fa-check-circle mr-2 text-green-600"></i>\n            Datos descifrados exitosamente en tu dispositivo.\n          </div>\n          \n          <dl class="divide-y divide-gray-100">\n            ${a}\n          </dl>\n        </div>\n\n        <div class="bg-gray-50 px-6 py-4 border-t border-gray-200 flex justify-between no-print-section">\n          <button id="backBtn" class="text-gray-600 hover:text-gray-900 font-medium px-4 py-2 rounded hover:bg-gray-200 transition">\n            <i class="fas fa-arrow-left mr-2"></i> Volver\n          </button>\n          \n          <div class="space-x-2 flex">\n            <button id="whatsappDocBtn" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded transition shadow-sm flex items-center" title="Copiar para WhatsApp">\n                <i class="fab fa-whatsapp mr-2"></i> <span class="hidden sm:inline">WhatsApp</span>\n            </button>\n\n            <button id="pdfDocBtn" class="bg-gray-800 hover:bg-gray-900 text-white px-3 py-2 rounded transition shadow-sm flex items-center" title="Guardar PDF">\n                <i class="fas fa-file-pdf mr-2"></i> <span class="hidden sm:inline">PDF</span>\n            </button>\n\n            <button id="deleteDocBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded transition shadow-sm" title="Eliminar">\n                <i class="fas fa-trash"></i>\n            </button>\n            <button id="editDocBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded transition shadow-sm" title="Editar">\n                <i class="fas fa-edit"></i>\n            </button>\n          </div>\n        </div>\n      </div>\n    `,this.setupContentListeners()}async handleCopyToWhatsApp(){try{const e=R();let t=`*${this.document.metadata.title}*\n_${this.template.name}_\n\n`;this.template.fields.forEach((n,a)=>{if(0===a)return;const r=`*${n.label}:*`;let s=this.decryptedData[n.id];if(null==s||""===s)s="_N/A_";else if("date"===n.type&&s)try{const[t,n,a]=s.split("-").map(Number),r=new Date(t,n-1,a);s=new Intl.DateTimeFormat(e.locale,{year:"numeric",month:"short",day:"numeric"}).format(r)}catch(i){}else"boolean"===n.type?s=s?"S√≠":"No":"secret"===n.type?s=`\`\`\`${s}\`\`\``:"currency"===n.type&&"number"==typeof s?s=new Intl.NumberFormat(e.locale,{style:"currency",currency:e.codigo}).format(s):"percentage"===n.type&&(s=`${s}%`);"text"===n.type?t+=`${r}\n${s}\n\n`:t+=`${r} ${s}\n`}),t+="\n_Generado por Mi Gesti√≥n_",await navigator.clipboard.writeText(t);const n=document.getElementById("whatsappDocBtn"),a=n.innerHTML,r=n.className;n.innerHTML='<i class="fas fa-check mr-2"></i> Copiado',n.className="bg-green-700 text-white px-3 py-2 rounded transition shadow-sm flex items-center",setTimeout(()=>{n.innerHTML=a,n.className=r},2e3)}catch(e){alert("No se pudo copiar al portapapeles. Verifica los permisos de tu navegador.")}}handleExportPDF(){window.print()}handleEdit(){const e={documentId:this.docId,template:this.template,formData:this.decryptedData,metadata:this.document.metadata};this.onBack(e)}async handleDelete(){if(confirm("ADVERTENCIA DE SEGURIDAD:\n¬øEst√°s seguro de que deseas ELIMINAR este documento cifrado? Esta acci√≥n es PERMANENTE."))try{const e=document.getElementById("deleteDocBtn");e.innerHTML='<i class="fas fa-spinner fa-spin"></i>',e.disabled=!0,await Y.deleteDocument(this.docId),alert("üóëÔ∏è Documento eliminado permanentemente de la b√≥veda."),this.onBack()}catch(e){alert("Error al eliminar: "+e.message),document.getElementById("deleteDocBtn").disabled=!1,document.getElementById("deleteDocBtn").innerHTML='<i class="fas fa-trash"></i>'}}setupContentListeners(){document.getElementById("closeViewerBtn")?.addEventListener("click",()=>this.onBack()),document.getElementById("backBtn")?.addEventListener("click",()=>this.onBack()),document.getElementById("deleteDocBtn")?.addEventListener("click",()=>this.handleDelete()),document.getElementById("editDocBtn")?.addEventListener("click",()=>this.handleEdit()),document.getElementById("pdfDocBtn")?.addEventListener("click",()=>this.handleExportPDF()),document.getElementById("whatsappDocBtn")?.addEventListener("click",()=>this.handleCopyToWhatsApp());document.getElementById("documentViewerPlaceholder").querySelectorAll(".toggle-secret-btn").forEach(e=>{e.addEventListener("click",e=>{const t=e.currentTarget,n=t.parentElement.querySelector(".secret-mask"),a=t.querySelector("i"),r=n.dataset.value;"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"===n.textContent?(n.textContent=r,a.classList.remove("fa-eye"),a.classList.add("fa-eye-slash"),n.classList.add("text-blue-700","font-bold")):(n.textContent="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢",a.classList.remove("fa-eye-slash"),a.classList.add("fa-eye"),n.classList.remove("text-blue-700","font-bold"))})}),document.querySelectorAll(".copy-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.value;navigator.clipboard.writeText(t).then(()=>{const t=e.innerHTML;e.innerHTML='<i class="fas fa-check text-green-600"></i>',setTimeout(()=>e.innerHTML=t,2e3)})})})}render(){return'<div id="documentViewerPlaceholder"></div>'}}const ee={async createBackup(){try{const e=await _.getUserTemplates(),t=await Y.getAllDocuments(),n={metadata:{version:"1.0",appName:"Mi Gesti√≥n",exportedAt:(new Date).toISOString(),totalDocuments:t.length,totalTemplates:e.length},data:{templates:e,vault:t}},a=JSON.stringify(n,null,2),r=new Blob([a],{type:"application/json"}),s=URL.createObjectURL(r),i=document.createElement("a");i.href=s;const o=(new Date).toISOString().slice(0,10);return i.download=`respaldo_migestion_${o}.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),{success:!0,count:t.length}}catch(e){throw e}},restoreBackup:async e=>new Promise((t,n)=>{const a=new FileReader;a.onload=async e=>{try{const n=JSON.parse(e.target.result);if(!n.data||!n.data.templates||!n.data.vault)throw new Error("El archivo no es v√°lido o est√° da√±ado.");const r=F.getCurrentUser();if(!r)throw new Error("Debes iniciar sesi√≥n para restaurar.");if(n.data.vault.length>0)try{const e=n.data.vault[0];if(!B.isReady())throw new Error("Cifrado no inicializado");await B.decryptDocument({content:e.encryptedContent,metadata:e.encryptionMetadata})}catch(a){throw new Error("‚õî CLAVE INCORRECTA\n\nEste archivo de respaldo fue creado con una contrase√±a diferente a la actual.\nNo se puede restaurar porque los datos ser√≠an ilegibles.")}const s=[],i=E.doc(`artifacts/mi-gestion-v1/users/${r.uid}/metadata/templates`),o=await _.getUserTemplates(),l=new Map(o.map(e=>[e.id,e]));n.data.templates.forEach(e=>{e.userId=r.uid,l.set(e.id,e)}),s.push(E.setDoc(i,{templates:Array.from(l.values()),lastUpdated:(new Date).toISOString(),count:l.size},{merge:!0})),n.data.vault.forEach(e=>{e.userId=r.uid;const t=E.doc(`artifacts/mi-gestion-v1/users/${r.uid}/vault/${e.id}`);s.push(E.setDoc(t,e))}),await Promise.all(s),await _.loadUserTemplates(),t({success:!0,docsRestored:n.data.vault.length,templatesRestored:n.data.templates.length})}catch(r){n(r)}},a.onerror=()=>n(new Error("Error al leer el archivo")),a.readAsText(e)})};class te{render(){return'\n      <div class="max-w-4xl mx-auto space-y-8 animate-fade-in">\n        \n        <div class="mb-6">\n          <h2 class="text-2xl font-bold text-gray-800">\n            <i class="fas fa-cogs mr-2 text-blue-600"></i>\n            Configuraci√≥n\n          </h2>\n          <p class="text-gray-600">Gestiona tu seguridad, datos y preferencias de la cuenta.</p>\n        </div>\n\n        <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100">\n          <div class="p-6">\n            <h3 class="text-lg font-bold text-gray-800 mb-2">üì• Descargar mis datos (Respaldo)</h3>\n            <p class="text-gray-600 text-sm mb-4">\n              Crea un archivo con toda tu informaci√≥n cifrada y tus plantillas.\n            </p>\n            \n            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">\n              <div class="flex">\n                <div class="flex-shrink-0">\n                  <i class="fas fa-info-circle text-blue-500"></i>\n                </div>\n                <div class="ml-3">\n                  <p class="text-sm text-blue-700 font-medium">\n                    Vigencia del Respaldo:\n                  </p>\n                  <p class="text-sm text-blue-600 mt-1">\n                    Este archivo <strong>solo ser√° v√°lido mientras mantengas tu contrase√±a actual</strong>.\n                    Si la cambias, este archivo quedar√° inservible.\n                  </p>\n                </div>\n              </div>\n            </div>\n\n            <button id="btnExport" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg transition flex items-center shadow-sm">\n              <i class="fas fa-download mr-2"></i>\n              Descargar Archivo de Respaldo\n            </button>\n          </div>\n        </div>\n\n        <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-red-100">\n          <div class="p-6">\n            <h3 class="text-lg font-bold text-gray-800 mb-2">üì§ Restaurar datos desde archivo</h3>\n            <p class="text-gray-600 text-sm mb-4">\n              Recupera tu informaci√≥n subiendo un archivo de respaldo (.json).\n            </p>\n\n            <div class="flex items-center space-x-4">\n              <input \n                type="file" \n                id="fileImport" \n                accept=".json"\n                class="block w-full text-sm text-gray-500\n                  file:mr-4 file:py-2 file:px-4\n                  file:rounded-full file:border-0\n                  file:text-sm file:font-semibold\n                  file:bg-blue-50 file:text-blue-700\n                  hover:file:bg-blue-100\n                "\n              />\n              <button id="btnRestore" class="bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 font-medium py-2 px-6 rounded-lg transition flex items-center shadow-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled>\n                <i class="fas fa-upload mr-2"></i>\n                Restaurar\n              </button>\n            </div>\n            \n            <div id="restoreStatus" class="mt-4 hidden"></div>\n          </div>\n        </div>\n\n        <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-orange-100">\n          <div class="p-6">\n            <h3 class="text-lg font-bold text-gray-800 mb-2">üîê Cambio de Contrase√±a</h3>\n            <p class="text-gray-600 text-sm mb-4">\n              Actualiza tu clave de acceso y cifrado.\n            </p>\n\n            <div class="bg-orange-50 border-l-4 border-orange-500 p-4 mb-6">\n              <div class="flex">\n                <div class="flex-shrink-0">\n                  <i class="fas fa-exclamation-triangle text-orange-500 text-xl"></i>\n                </div>\n                <div class="ml-3">\n                  <h4 class="text-sm font-bold text-orange-800 uppercase">Advertencia Importante</h4>\n                  <ul class="list-disc list-inside text-sm text-orange-700 mt-2 space-y-1">\n                    <li>Al cambiar tu contrase√±a, <strong>los respaldos anteriores dejar√°n de funcionar</strong>.</li>\n                    <li>No podr√°s recuperar datos antiguos si olvidas esta nueva contrase√±a.</li>\n                    <li><strong>Recomendaci√≥n:</strong> Crea un nuevo respaldo inmediatamente despu√©s de cambiar la clave.</li>\n                  </ul>\n                </div>\n              </div>\n            </div>\n\n            <form id="changePasswordForm" class="space-y-4 max-w-md">\n              <div>\n                <label class="block text-sm font-medium text-gray-700 mb-1">Contrase√±a Actual</label>\n                <input type="password" id="currentPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Necesaria para verificar tu identidad" required>\n              </div>\n              <div>\n                <label class="block text-sm font-medium text-gray-700 mb-1">Nueva Contrase√±a</label>\n                <input type="password" id="newPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="M√≠nimo 8 caracteres" required minlength="8">\n              </div>\n              <div>\n                <label class="block text-sm font-medium text-gray-700 mb-1">Confirmar Nueva Contrase√±a</label>\n                <input type="password" id="confirmNewPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Repite la contrase√±a" required>\n              </div>\n              \n              <button type="submit" id="btnChangePass" class="bg-orange-600 hover:bg-orange-700 text-white font-medium py-2 px-6 rounded-lg transition shadow-sm w-full">\n                Cambiar Contrase√±a\n              </button>\n            </form>\n\n          </div>\n        </div>\n\n      </div>\n    '}setupEventListeners(){document.getElementById("btnExport")?.addEventListener("click",async()=>{const e=document.getElementById("btnExport"),t=e.innerHTML;try{e.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i> Generando...',e.disabled=!0;const t=await ee.createBackup();alert(`‚úÖ Respaldo creado con √©xito (${t.count} documentos).\n\n‚ö†Ô∏è IMPORTANTE:\nEste archivo SOLO funciona con tu contrase√±a actual.\nSi cambias tu contrase√±a en el futuro, este archivo ser√° inservible.\nPor favor, crea un nuevo respaldo cada vez que cambies tu clave.`)}catch(n){alert("Error al crear el respaldo: "+n.message)}finally{e.innerHTML=t,e.disabled=!1}});const e=document.getElementById("fileImport"),t=document.getElementById("btnRestore");e?.addEventListener("change",()=>{e.files.length>0?(t.disabled=!1,t.classList.remove("bg-white","text-gray-700","border-gray-300"),t.classList.add("bg-blue-600","text-white","hover:bg-blue-700","border-transparent")):(t.disabled=!0,t.classList.add("bg-white","text-gray-700","border-gray-300"),t.classList.remove("bg-blue-600","text-white","hover:bg-blue-700","border-transparent"))}),t?.addEventListener("click",async()=>{if(0===e.files.length)return;const n=e.files[0],a=document.getElementById("restoreStatus");a.classList.remove("hidden"),a.innerHTML='<p class="text-blue-600"><i class="fas fa-spinner fa-spin mr-2"></i> Verificando clave y restaurando...</p>',t.disabled=!0;try{const r=await ee.restoreBackup(n);a.innerHTML=`\n                <div class="bg-green-50 text-green-800 p-3 rounded border border-green-200 animate-fade-in">\n                    <p class="font-bold"><i class="fas fa-check-circle mr-2"></i> ¬°Restauraci√≥n completada!</p>\n                    <p class="text-sm mt-1">Se recuperaron ${r.docsRestored} documentos y ${r.templatesRestored} plantillas.</p>\n                    <p class="text-xs mt-2 text-green-700">Tus datos antiguos y nuevos se han fusionado correctamente.</p>\n                </div>`,e.value="",t.disabled=!0,t.classList.add("bg-white","text-gray-700","border-gray-300"),t.classList.remove("bg-blue-600","text-white","hover:bg-blue-700")}catch(r){a.innerHTML=`\n                <div class="bg-red-50 text-red-800 p-3 rounded border border-red-200 animate-fade-in">\n                    <p class="font-bold"><i class="fas fa-times-circle mr-2"></i> No se pudo restaurar</p>\n                    <p class="text-sm mt-1 whitespace-pre-line">${r.message}</p>\n                </div>\n            `}finally{e.files.length>0&&(t.disabled=!1)}});const n=document.getElementById("changePasswordForm");n?.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("currentPassword").value,a=document.getElementById("newPassword").value;if(a!==document.getElementById("confirmNewPassword").value)return void alert("Las contrase√±as nuevas no coinciden.");if(a.length<8)return void alert("La contrase√±a debe tener al menos 8 caracteres.");if(!confirm("‚ö†Ô∏è ADVERTENCIA DE SEGURIDAD ‚ö†Ô∏è\n\nEst√°s a punto de cambiar tu contrase√±a maestra.\n\n1. Los respaldos antiguos DEJAR√ÅN DE FUNCIONAR.\n2. Debes crear un NUEVO respaldo inmediatamente despu√©s.\n\n¬øDeseas continuar?"))return;const r=document.getElementById("btnChangePass"),s=r.innerHTML;r.disabled=!0,r.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i> Procesando...';try{const e=await F.changePassword(a,t);e.success?(alert("‚úÖ Contrase√±a actualizada correctamente.\n\nLa pr√≥xima vez que inicies sesi√≥n, usa tu nueva clave.\n\n¬°IMPORTANTE! Genera un nuevo respaldo ahora mismo."),n.reset()):alert("Error: "+e.error)}catch(i){alert("Error al cambiar contrase√±a: "+i.message)}finally{r.disabled=!1,r.innerHTML=s}})}}async function ne(e,t){if(e){try{await _.initialize(e.uid)}catch(n){}ae(e,t),await async function(e){setTimeout(async()=>{if(!B.isReady()){const t=new k(async e=>{try{return await F.initializeEncryption(e),!0}catch(n){return!1}},e.email);setTimeout(()=>{t.show()},500)}},1e3)}(e)}else!function(e){const t=new P(e=>{});e.innerHTML='\n    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-gray-100 flex items-center justify-center p-4">\n      <div class="w-full max-w-lg">\n        <div class="text-center mb-8">\n          <div class="inline-flex items-center justify-center w-20 h-20 bg-blue-100 rounded-full mb-4">\n            <i class="fas fa-shield-alt text-3xl text-blue-600"></i>\n          </div>\n          <h1 class="text-3xl font-bold text-gray-800 mb-2">Mi Gesti√≥n</h1>\n          <p class="text-gray-600">Protege tu informaci√≥n personal con cifrado de extremo a extremo</p>\n        </div>\n        \n        <div id="authContainer"></div>\n        \n        <div class="mt-8 text-center text-sm text-gray-500">\n          <p><i class="fas fa-lock mr-1"></i> Tus datos nunca salen de tu dispositivo cifrados</p>\n        </div>\n      </div>\n    </div>\n  ';const n=document.getElementById("authContainer");n&&t.updateView(n)}(t)}async function ae(e,t){const n=await F.getUserRole(),a="admin"===n?'<a href="#" class="text-red-600 hover:text-red-800 px-3 py-2 rounded-md text-sm font-bold border border-red-200 bg-red-50 ml-2" id="navAdmin">\n         <i class="fas fa-user-shield mr-1"></i> Panel Admin\n       </a>':"";t.innerHTML=`\n    <div class="min-h-screen bg-gray-50">\n      <nav class="bg-white shadow-sm">\n        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">\n          <div class="flex justify-between h-16">\n            <div class="flex items-center">\n              <div class="flex items-center">\n                <i class="fas fa-shield-alt text-xl text-blue-600 mr-3"></i>\n                <h1 class="text-xl font-bold text-gray-800">Mi Gesti√≥n</h1>\n              </div>\n              <div class="hidden md:block ml-10">\n                <div class="flex space-x-4 items-center">\n                  <a href="#" class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium" id="navHome">\n                    <i class="fas fa-home mr-1"></i> Inicio\n                  </a>\n                  <a href="#mis-datos" class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium" id="navMyData">\n                    <i class="fas fa-database mr-1"></i> Mis Datos\n                  </a>\n                  <a href="#" class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium" id="navSettings">\n                    <i class="fas fa-cogs mr-1"></i> Configuraci√≥n\n                  </a>\n                  ${a}\n                </div>\n              </div>\n            </div>\n            \n            <div class="flex items-center">\n              <div class="flex items-center space-x-3">\n                <div class="text-right hidden md:block">\n                  <p class="text-sm font-medium text-gray-700">${e.email}</p>\n                  <p class="text-xs text-gray-500">${"admin"===n?"Administrador":"Usuario"}</p>\n                </div>\n                <div class="relative">\n                  <button id="userMenuButton" class="flex items-center space-x-2 bg-gray-100 hover:bg-gray-200 rounded-full p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">\n                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-medium">\n                      ${e.email.charAt(0).toUpperCase()}\n                    </div>\n                    <i class="fas fa-chevron-down text-gray-600"></i>\n                  </button>\n                  \n                  <div id="userMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10">\n                    <button id="logoutButton" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">\n                      <i class="fas fa-sign-out-alt mr-2"></i> Cerrar Sesi√≥n\n                    </button>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </nav>\n\n      <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">\n        <div id="dynamicContent"></div>\n      </main>\n    </div>\n  `,function(){const e=document.getElementById("userMenuButton"),t=document.getElementById("userMenu"),n=document.getElementById("logoutButton");e&&t&&(e.addEventListener("click",e=>{e.stopPropagation(),t.classList.toggle("hidden")}),document.addEventListener("click",()=>t.classList.add("hidden")),t.addEventListener("click",e=>e.stopPropagation()));n&&n.addEventListener("click",async()=>{try{await F.logout()}catch(e){}});document.getElementById("navMyData")?.addEventListener("click",e=>{e.preventDefault();re(F.getCurrentUser())}),document.getElementById("navHome")?.addEventListener("click",e=>{e.preventDefault();re(F.getCurrentUser())}),document.getElementById("navSettings")?.addEventListener("click",e=>{e.preventDefault(),F.getCurrentUser(),function(){const e=document.querySelector("main");if(!e)return;const t=new te;e.innerHTML=t.render(),t.setupEventListeners()}()})}(),"admin"===n&&document.getElementById("navAdmin")?.addEventListener("click",e=>{e.preventDefault(),alert("üöß Panel de Administraci√≥n en construcci√≥n.\nAqu√≠ podr√°s gestionar plantillas globales y usuarios.")}),re(e)}function re(e){const t=document.querySelector("main");if(!t)return;t.innerHTML='\n    <div class="mb-6 flex justify-between items-center">\n      <div>\n        <h2 class="text-2xl font-bold text-gray-800">Mis Datos</h2>\n        <p class="text-gray-600">Informaci√≥n protegida y cifrada</p>\n      </div>\n      <button id="btnNewDocVault" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition flex items-center shadow-sm">\n        <i class="fas fa-plus mr-2"></i> Nuevo\n      </button>\n    </div>\n    <div id="vaultListContainer"></div>\n  ';const n=new Z(t=>{se(t,e)},()=>{ie(e)});document.getElementById("btnNewDocVault")?.addEventListener("click",()=>{ie(e)}),n.loadDocuments()}async function se(e,t){const n=document.getElementById("app");n.innerHTML='\n    <div class="min-h-screen bg-gray-50 py-8 px-4 sm:px-6 lg:px-8">\n      <div id="documentViewerPlaceholder"></div>\n    </div>\n  ';const a=document.getElementById("documentViewerPlaceholder"),r=new Q(e,e=>{e?function(e,t){const n=document.getElementById("app"),a=new X(e,()=>{se(e.documentId,t)},()=>{se(e.documentId,t)});n.innerHTML='\n    <div class="min-h-screen bg-gray-50 py-8 px-4 sm:px-6 lg:px-8">\n      <div id="editorContainer"></div>\n    </div>\n  ',document.getElementById("editorContainer").innerHTML=a.render(),a.setupEventListeners()}(e,t):ae(t,n)});a.innerHTML=r.render(),await r.load()}function ie(e){const t=document.getElementById("app");if(!t)return;const n=new G(t=>{!async function(e,t){const n=document.getElementById("app");n.innerHTML='\n    <div class="min-h-screen bg-gray-50 flex items-center justify-center">\n      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>\n    </div>';try{const a=await _.getTemplateById(e),r=new X({template:a},()=>{ae(t,n)},()=>{ie(t)});n.innerHTML='\n      <div class="min-h-screen bg-gray-50 py-8 px-4 sm:px-6 lg:px-8">\n        <div id="editorContainer"></div>\n      </div>\n    ',document.getElementById("editorContainer").innerHTML=r.render(),r.setupEventListeners()}catch(a){alert("Error al cargar la plantilla: "+a.message),ie(t)}}(t,e)});t.innerHTML='\n    <div class="min-h-screen bg-gray-50">\n      <nav class="bg-white shadow-sm">\n        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">\n          <div class="flex justify-between h-16">\n            <div class="flex items-center">\n              <button id="backToDashboard" class="mr-4 text-gray-600 hover:text-blue-600">\n                <i class="fas fa-arrow-left text-lg"></i>\n              </button>\n              <div class="flex items-center">\n                <i class="fas fa-layer-group text-xl text-indigo-600 mr-3"></i>\n                <h1 class="text-xl font-bold text-gray-800">Gesti√≥n de Plantillas</h1>\n              </div>\n            </div>\n          </div>\n        </div>\n      </nav>\n      <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">\n        <div id="templateManagerContainer"></div>\n      </main>\n    </div>\n  ';const a=document.getElementById("templateManagerContainer");a&&(a.innerHTML=n.render(),_.initialize(e.uid),n.loadTemplates()),document.getElementById("backToDashboard")?.addEventListener("click",()=>{const e=F.getCurrentUser();e&&ae(e,t)})}document.addEventListener("DOMContentLoaded",()=>{!async function(){const e=document.getElementById("app");if(!e)return;F.subscribe(async t=>{await ne(t,e)});const t=F.getCurrentUser();await ne(t,e)}()}),window.app={initializePostLogin:async function(e,t){await B.initialize(t,e.uid)}};
